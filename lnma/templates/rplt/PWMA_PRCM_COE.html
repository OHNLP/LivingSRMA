{% extends '_layout_bs.html' %}

{% block title %}
PWMA Primary + Cumulative Analysis API Demo
{% endblock %}

{% block style %}
<style>
    .code {
        font-family: 'Courier New', Courier, monospace;
        background-color: #eeeeee;
        font-size: 13px;
    }

    .fact {
        font-style: italic;
        padding: 0 0 0 1em;
    }

    .result {
        font-weight: bold;
        padding: 0 0 0 1em;
    }

    .box {
        position: relative;
    }

    .defs {
        width: 250px;
        border: 1px solid #DADADA;
        padding: 10px;
        margin: 5px;
        position: absolute;
        top: 0;
        right: 0;
        line-height: 1em;
    }
</style>
{% endblock %}

{% block main %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-5">
            <h2>RPLT PWMA + CoE API Demo</h2>
            <p>
                RPLT PWMA + CoE API Test for <span class="code">/rplt/PWMA_PRCM_COE</span>. <br>
                The return URL is the relative path to root, please add to absolute path in your own code. The server
                supports cross-domain access and HTTP header "Access-Control-Allow-Origin" has been added, so this
                service can be accessed from any server.
                The usage of this web API in JavaScript is also available in the source code of this page for reference.
                <br>
                There are 4 parameters:
            </p>
            <div>
                <div class="form-group row">
                    <label for="am" class="col-sm-3 col-form-label">am
                    </label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="am" value="FORESTDATA">
                        <small id="amHelp" class="form-text text-muted">
                            Analyzer Model: The R script token name for generating this figure. Available values
                            include: <br>
                            FORESTDATA: get the forest plot results only <br>
                            FOREST: get the forest plot image only<br>
                        </small>
                    </div>

                </div>

                <div class="form-group row">
                    <label for="sm" class="col-sm-3 col-form-label">sm</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="sm" value="OR">
                        <small id="smHelp" class="form-text text-muted">The measure of effect. Available values include:
                            <br>
                            OR, RR, or RD.</small>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="rs" class="col-sm-3 col-form-label">rs</label>
                    <div class="col-sm-9">
                        <textarea class="form-control code" id="rs" rows="20" style="font-size: 9px;"></textarea>
                        <small id="rsHelp" class="form-text text-muted">The JSON data for generating plots. Each study
                            is an object, with 6 attributes (case sensitive). The value of this parameter is a
                            stringified JSON object.</small>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="imp_t" class="col-sm-3 col-form-label">
                        imp_t (optional)
                    </label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="imp_t" value="">
                        <small id="ind_tHlep" class="form-text text-muted">
                            ImprecisionT threshold: The threshold for imprecision evaluation.
                            It's optional. Default value is 0.
                        </small>
                    </div>

                </div>

                <div class="form-group row">
                    <label for="hk" class="col-sm-3 col-form-label">hk</label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="hk" value="FALSE">
                        <small id="hkHelp" class="form-text text-muted">The Hartung-Knapp adjustment setting, TRUE or
                            FALSE</small>
                    </div>
                </div>

                <div class="form-group row">
                    <label for="apikey" class="col-sm-3 col-form-label">apikey
                    </label>
                    <div class="col-sm-9">
                        <input type="text" class="form-control" id="apikey"
                            value="[[ config['settings'].API_SYSTEM_APIKEYS[0]|show_if_local ]]">
                        <small id="apikeyHelp" class="form-text text-muted">
                            For the security of this service, API Key is required for authentication.
                        </small>
                    </div>

                </div>

                <div class="form-group row">
                    <div class="col-sm-10">
                        <button onclick="get_data();" class="btn btn-primary">
                            Request figure URLs with above parameters
                        </button>
                    </div>
                </div>
            </div>
        </div>


        <div class="col-md-7" style="padding-top: 20px;">

            <h4>Server Response: </h4>
            <pre id="resp" style="width: 100%; max-height: 200px;" class="code">
            </pre>

            <div id="app_coe">
                <div v-if="pma != null">
                    <h4>Certainty of Evidence</h4>


                    <div class="box">
                        <h5>Risk of Bias</h5>
                        <p class="fact">
                            All Low risk = {{ pma.data.coe.info.risk_of_bias.is_all_low }} <br>
                            All high risk / some concerns = {{ pma.data.coe.info.risk_of_bias.is_all_high }} <br>
                            Subgroup Analysis (Low vs. High/Some) P-value = {{ pma.data.coe.info.risk_of_bias.subg_pval }} <br>
                            Percentage of High-risk studies = {{ pma.data.coe.info.risk_of_bias.per_high_stus }}
                        </p>

                        <p class="result">
                            Result = {{ pma.data.coe.risk_of_bias }}
                            ({{ coe_helper.val_to_label(pma.data.coe.risk_of_bias, 'risk_of_bias') }})
                        </p>
                        
                        <pre id="mermaid_rob" 
                            class="mermaid"
                            v-html="mermaid_chart_rob">
                        </pre>

                        <p class="defs">
                            0: Not applicable <br>
                            1: No serious <br>
                            2: Serious <br>
                            3: Very serious <br>
                        </p>

                        <hr>
                    </div>
                    <!-- /.box Risk of Bias -->



                    <div class="box">

                        <h5>Inconsistency</h5>

                        <p class="fact">
                            I<sup>2</sup> = {{ pma.data.primma.heterogeneity.i2 }}
                        </p>

                        <p class="result">
                            Result = {{ coe_helper.judge_inconsistency(pma.data.primma.heterogeneity.i2) }}
                            ({{
                            coe_helper.val_to_label(coe_helper.judge_inconsistency(pma.data.primma.heterogeneity.i2),
                            'inconsistency') }})
                        </p>

                        <pre id="mermaid_inc" 
                            class="mermaid"
                            v-html="mermaid_chart_inc">
                        </pre>

                        <p class="defs">
                            0: Not inconsistency <br>
                            1: Serious inconsistency <br>
                            2: Very serious inconsistency <br>
                            3: Very serious inconsistency <br>
                        </p>
                        <hr>
                    </div>
                    <!-- /.box Inconsistency -->



                    <div class="box">

                        <h5>Publication Bias</h5>
                        <p class="fact">
                            N = {{ pma.data.coe.info.publication_bias.n_studies }} <br>
                            Egger's Test p = {{ pma.data.coe.info.publication_bias.egger_test_p_value }} <br>
                            Pooled Effect = {{ pma.data.coe.info.publication_bias.pooled_sm }} <br>
                            Adjusted Effect = {{ pma.data.coe.info.publication_bias.adjusted_sm }} <br>
                            Effect Difference = {{ pma.data.coe.info.publication_bias.difference_sm * 100 }}% <br>
                        </p>

                        <p class="result">
                            Result = {{ pma.data.coe.publication_bias }}
                            ({{ coe_helper.val_to_label(coe_helper.judge_publication_bias(pma.data.coe.info.publication_bias.n_studies, pma.data.coe.info.publication_bias.egger_test_p_value, pma.data.coe.info.publication_bias.difference_sm), 'publication_bias') }})
                        </p>

                        <pre id="mermaid_pbb" 
                            class="mermaid"
                            v-html="mermaid_chart_pbb">
                        </pre>

                        <p class="defs">
                            0: Not applicable <br>
                            1: Not serious <br>
                            2: Serious  <br>
                        </p>

                        <hr>
                    </div>
                    <!-- /.box Publication Bias -->


                    <div class="box">
                        <h5>Imprecision</h5>
                        <p class="fact">
                            T = {{ pma.data.coe.info.imprecision.t }} (
                                Is T user-provided? = {{ pma.data.coe.info.imprecision.is_t_user_provided }}) <br>
                            CI of RD: ({{ pma.data.coe.info.imprecision.ci_of_rd[0].toFixed(4) }}; 
                                       {{ pma.data.coe.info.imprecision.ci_of_rd[1].toFixed(4) }}) <br>
                            Does CI of RD include T? = {{ pma.data.coe.info.imprecision.is_t_included_in_ci_of_rd }}) <br>
                            Relative Effect =  {{ pma.data.coe.info.imprecision.sm }} <br>
                            MA Size N = {{ pma.data.coe.info.imprecision.ma_size }} <br>
                            OIS = {{ pma.data.coe.info.imprecision.ois }} <br>
                        </p>


                        <p class="result">
                            Result = {{ pma.data.coe.imprecision }}
                            ({{ coe_helper.val_to_label(coe_helper.judge_imprecision(pma.data.coe.info.imprecision), 'imprecision') }})
                        </p>

                        <pre id="mermaid_imp" 
                            class="mermaid"
                            v-html="mermaid_chart_imp">
                        </pre>

                        <p class="defs">
                            0: Not applicable <br>
                            1: No serious <br>
                            2: Serious <br>
                            3: Very serious <br>
                            4: Extremely serious <br>
                        </p>

                        <hr>
                    </div>
                    <!-- /.box Imprecision -->




                    <div class="box">
                        <h5>Indirectness</h5>
                        <p class="fact">
                            Number of "Very Close" = {{ pma.data.coe.info.indirectness.n_very_close }} <br>
                            Percentage of "Very Close" = {{ to_percentage(pma.data.coe.info.indirectness.n_very_close / pma.data.coe.info.indirectness.n_studies) }} <br>
                            Number of "Moderately Close" = {{ pma.data.coe.info.indirectness.n_moderately_close }} <br>
                            Number of "Not Close" = {{ pma.data.coe.info.indirectness.n_not_close }} <br>
                            Number of studies = {{ pma.data.coe.info.indirectness.n_studies }}
                        </p>

                        <p class="result">
                            Result = {{ pma.data.coe.indirectness }}
                            ({{ coe_helper.val_to_label(coe_helper.judge_indirectness(pma.data.coe.info.indirectness.n_very_close, pma.data.coe.info.indirectness.n_moderately_close, pma.data.coe.info.indirectness.n_not_close, pma.data.coe.info.indirectness.n_ind_na, pma.data.coe.info.indirectness.n_studies), 'indirectness') }})
                        </p>

                        <pre id="mermaid_ind" 
                            class="mermaid"
                            v-html="mermaid_chart_ind">
                        </pre>

                        <p class="defs">
                            0: Not applicable <br>
                            1: No serious <br>
                            2: Serious <br>
                            3: Very serious <br>
                            4: Extremely serious <br>
                        </p>

                        <hr>

                    </div>
                    <!-- /.box Indirectness -->


                </div>
                <div v-else>
                    Run API to Get PMA Results
                </div>
            </div>

            <!-- <img id="img-1" style="width: 100%; border: 3px solid #cccccc; margin: 5px 0;" src="">
            <img id="img-2" style="width: 100%; border: 3px solid #cccccc; margin: 5px 0;" src=""> -->
        </div>
    </div>
</div>

{% endblock %}

{% block script %}
<!-- Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>

<!-- Mermaid -->
<script type="module">
import mermaid from 'https://cdn.jsdelivr.net/npm/mermaid@9/dist/mermaid.esm.min.mjs';
// mermaid.initialize({ startOnLoad: true });
window.mermaid = mermaid;
</script>

<script>
{% include 'js/coe_helper.js' %}

var rs_sample = [
    { study: 'Raskob et al', year: 2017, Et: 41, Nt: 522, Ec: 59, Nc: 524, pid: '1234', rob: 'L', ind: 'V' },
    { study: 'Young et al', year: 2018, Et: 8, Nt: 203, Ec: 18, Nc: 203, pid: '2345', rob: 'L', ind: 'V' },
    { study: 'McBane et al', year: 2019, Et: 1, Nt: 145, Ec: 9, Nc: 142, pid: '3456', rob: 'L', ind: 'V' },
    { study: 'Don et al', year: 2020, Et: 32, Nt: 576, Ec: 46, Nc: 579, pid: '4567', rob: 'M', ind: 'V' },
    { study: 'Kim et al', year: 2021, Et: 18, Nt: 276, Ec: 26, Nc: 279, pid: '45678', rob: 'L', ind: 'V' },
    { study: 'Aaskob et al', year: 2017, Et: 45, Nt: 512, Ec: 55, Nc: 524, pid: '1234', rob: 'L', ind: 'M' },
    { study: 'Boung et al', year: 2018, Et: 18, Nt: 213, Ec: 18, Nc: 202, pid: '2341', rob: 'L', ind: 'N' },
    { study: 'DcBane et al', year: 2019, Et: 2, Nt: 125, Ec: 9, Nc: 141, pid: '3451', rob: 'L', ind: 'V' },
    { study: 'Eon et al', year: 2020, Et: 30, Nt: 546, Ec: 43, Nc: 573, pid: '4561', rob: 'L', ind: 'M' },
    { study: 'Fim et al', year: 2021, Et: 15, Nt: 306, Ec: 25, Nc: 272, pid: '45671', rob: 'L', ind: 'V' },
];

var coe_mermaid_helper = {
    activate_link_style: ' stroke:red,color:red;\n',

    get_rob_mermaid: function(vals) {
        var chart_desc = `
graph TD
%% define class
classDef HITL fill:yellow,stroke:orange;
%% define nodes
s1["Are all studies low risk?"]
s2["Are all studies high risk or some concerns?"]
s3["Subgroup analysis (low vs. high/some)"]
s4["Percent of high-risk studies"]
s_init_hitl{{"HITL: Are all studies evaluated?"}}:::HITL
s_hitl{{"HITL: Review"}}:::HITL

%% define links
%% link 0
s1 -- "Yes" --> r1([1: Not serious])
%% link 1
s1 -- "No" --> s2
%% link 2
s2 -- "Yes" --> r2([2: Serious])
%% link 3
s2 -- "No" --> s3
%% link 4
s3 -- "p<0.05" --> r3([3: Very serious])
%% link 5
s3 -- "p≥0.05" --> s4
%% link 6
s4 -- "<50%" --> r4([1: Not serious])
%% link 7
s4 -- "≥50%" --> r5([2: Serious])
%% link 8 for HITL
r2 --> s_hitl --> r6([3-4: Very-Extremely serious])
%% link 9 for init
s_init_hitl -- "Yes" --> s1
%% link 10 for init no
s_init_hitl -- "No" --> r00([0: Not applicable])
        `
        if (typeof(vals) == 'undefined') {
            return chart_desc;
        }

        // ok, let's add more styles for path
        if (vals.is_all_low) {
            chart_desc += 'linkStyle 0' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 1' + this.activate_link_style;
        }
        if (vals.is_all_high) {
            chart_desc += 'linkStyle 2' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 3' + this.activate_link_style;
        }
        if (vals.subg_pval < 0.05) {
            chart_desc += 'linkStyle 4' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 5' + this.activate_link_style;
        }
        if (vals.per_high_stus < 0.5) {
            chart_desc += 'linkStyle 6' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 7' + this.activate_link_style;
        }

        return chart_desc;
    },

    get_inc_mermaid: function(vals) {
        var chart_desc = `
graph TD
%% define class
classDef HITL fill:yellow,stroke:orange;
%% define nodes
s1["I-sq as an indication of statistical heterogeneity"]
s2["Are 75% of the studies within same category?"]
s3{{"HITL Review"}}:::HITL

%% define links
%% link 0
s1 -- "<50%" --> r1([1: Not serious])
%% link 1
s1 -- "≥50%" --> s2
%% link 2
s2 -- "Yes" --> r2([1: Not serious])
%% link 3
s2 -- "No" --> r3([2: Serious])
%% link 4
r3 -- "Optional" --> s3
%% link 5
s3 -- "Rate down" --> r4([3: Very serious])
        `;
        if (typeof(vals) == 'undefined') {
            return chart_desc;
        }

        // ok, let's add more styles for path
        if (vals.i2 < 0.5) {
            chart_desc += 'linkStyle 0' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 1' + this.activate_link_style;
        }
        return chart_desc;
    },

    get_pbb_mermaid: function(vals) {
        var chart_desc = `
graph TD
%% define class
classDef HITL fill:yellow,stroke:orange;
%% define nodes
s1[Number of studies]
s2[Egger's Regression Test]
s3[Does adjusted effect show less benefit?]

%% define links
%% link 0
s1 -- "N<10" --> r1([1: Not serious])
%% link 1
s1 -- "N≥10" --> s2
%% link 2
s2 -- "p<0.05" --> s3
%% link 3
s2 -- "p≥0.05" --> r3([1: Not serious])
%% link 4
s3 -- "diff<20%" --> r5([1: Not serious])
%% link 5
s3 -- "diff≥20%" --> r4([2: Serious])
        `
        // if no values, just return this chart
        if (typeof(vals) == 'undefined') {
            return chart_desc;
        }

        // ok, let's add more styles for path
        if (vals.n_studies < 10) {
            chart_desc += 'linkStyle 0' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 1' + this.activate_link_style;
        }

        if (vals.egger_test_p_value < 0.05) {
            chart_desc += 'linkStyle 2' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 3' + this.activate_link_style;
        }

        if (vals.difference_sm < 0.2) {
            chart_desc += 'linkStyle 4' + this.activate_link_style;
        } else {
            chart_desc += 'linkStyle 5' + this.activate_link_style;
        }

        return chart_desc;
    },

    get_imp_mermaid: function(vals) {
        var chart_desc = `
graph TD
%% define class
classDef HITL fill:yellow,stroke:orange;
%% define nodes
s0["Get threshold T\nUser-provided or null(0)"]
s1["Does CI of RD include T?"]
s2["Is relative effect (RR/OR)\n<0.7 or >1.3?"]
s3["Calculate OIS"]

%% define link
%% link 0
s0 --> s1
%% link 1
s1 -- Yes --> s_tup["Is T user-provided?"]
%% link 2
s_tup -- Yes --> s_mpt["Does CI of RD include\nboth - and + T?"]
%% link 3
s_mpt -- Yes --> r3a["4: Extremely serious"]
%% link 4
s_mpt -- No --> r2a["3: Very serious"]
%% link 5
s_tup -- No --> s_200p["Does CI of RD include\nboth - and +\n200 per 1,000?"]
%% link 6
s_200p -- Yes --> r3b["4: Extremely serious"]
%% link 7
s_200p -- No --> r2b["3: Very serious"]
%% link 8
s1 -- No --> s2
%% link 9
s2 -- No --> r2([1: Not serious])
%% link 10
s2 -- Yes --> s3
%% link 11
s3 -- "MA size ≥ OIS" --> r3([1: Not serious])
%% link 12
s3 -- "MA size in 50-100% OIS" --> r4([2: Serious])
%% link 13
s3 -- "MA size < 50% OIS" --> r5([3: Very serious])
        `;
        // if no values, just return this chart
        if (typeof(vals) == 'undefined') {
            return chart_desc;
        }
        // always get the T first
        chart_desc += 'linkStyle 0' + this.activate_link_style;

        if (vals.is_t_included_in_ci_of_rd) {
            chart_desc += 'linkStyle 1' + this.activate_link_style;
            
            if (vals.is_t_user_provided) {
                chart_desc += 'linkStyle 2' + this.activate_link_style;

                if (vals.is_both_ts_included_in_ci_of_rd) {
                    chart_desc += 'linkStyle 3' + this.activate_link_style;
                } else {
                    chart_desc += 'linkStyle 4' + this.activate_link_style;
                }
            } else {
                chart_desc += 'linkStyle 5' + this.activate_link_style;
                if (vals.is_both_200p1000_included_in_ci_of_rd) {
                    chart_desc += 'linkStyle 6' + this.activate_link_style;
                } else {
                    chart_desc += 'linkStyle 7' + this.activate_link_style;
                }
            }

        } else {
            chart_desc += 'linkStyle 8' + this.activate_link_style;
        }

        if (vals.is_relative_effect_large) {
            chart_desc += 'linkStyle 10' + this.activate_link_style;
            
            if (vals.ma_size > vals.ois) {
                chart_desc += 'linkStyle 11' + this.activate_link_style;
            } else if (vals.ma_size < 0.5 * vals.ois) {
                chart_desc += 'linkStyle 13' + this.activate_link_style;
            } else {
                chart_desc += 'linkStyle 12' + this.activate_link_style;
            }
        } else {
            chart_desc += 'linkStyle 9' + this.activate_link_style;
        }

        return chart_desc;
    },

    get_ind_mermaid: function(vals) {
        var chart_desc = `
        graph TD
%% define class
classDef HITL fill:yellow,stroke:orange;
%% define nodes
s1[Is >75% of studies 'Very Close'?]
s2[Is none of studies 'Not Close'?]
s_init_hitl{{"HITL: Are all studies evaluated?"}}:::HITL

%% define links
%% link 0: for HITL
s_init_hitl -- "Yes" --> s1
%% link 1: for HITL
s_init_hitl -- "No" --> r0([0: Not applicable])
%% link 2
s1 -- "Yes" --> r1([1: Not serious])
%% link 3
s1 -- "No" --> s2
%% link 4
s2 -- "Yes" --> r2([2: Serious])
%% link 5
s2 -- "No" --> r3([3: Very serious])
        `;
        // if no values, just return this chart
        if (typeof(vals) == 'undefined') {
            return chart_desc;
        }

        // ok, let's add more styles for path
        if (vals.n_ind_na == 0) {
            chart_desc += 'linkStyle 0' + this.activate_link_style;

            if (vals.percentage_very_close >= 0.75) {
                chart_desc += 'linkStyle 2' + this.activate_link_style;
            } else {
                chart_desc += 'linkStyle 3' + this.activate_link_style;
            }

            if (vals.n_not_close == 0) {
                chart_desc += 'linkStyle 4' + this.activate_link_style;
            } else {
                chart_desc += 'linkStyle 5' + this.activate_link_style;
            }

        } else {
            chart_desc += 'linkStyle 1' + this.activate_link_style;
        }

        return chart_desc;
    },
};

var app_coe = {
    vpp: null,

    init: function () {
        this.vpp = new Vue({
            el: '#app_coe',
            data: {
                rs: null,
                pma: null,
                coe_helper: coe_helper,

                // for mermaid vis
                mermaid_chart_rob: '',
                mermaid_chart_pbb: '',
                mermaid_chart_inc: '',
                mermaid_chart_imp: '',
                mermaid_chart_ind: '',
            },

            methods: {
                update_data: function(data_pma) {
                    this.pma = data_pma;

                    var tmp = '';
                    // update charts

                    // for publication bias
                    tmp = coe_mermaid_helper.get_pbb_mermaid(
                        this.pma.data.coe.info.publication_bias
                    );
                    console.log('* Mermaid chart for publication bias', tmp);
                    this.mermaid_chart_pbb = tmp;

                    // for risk of bias
                    tmp = coe_mermaid_helper.get_rob_mermaid(
                        this.pma.data.coe.info.risk_of_bias
                    );
                    console.log('* Mermaid chart for risk of bias', tmp);
                    this.mermaid_chart_rob = tmp;

                    // for inconsistency
                    tmp = coe_mermaid_helper.get_inc_mermaid(
                        this.pma.data.coe.info.inconsistency
                    );
                    console.log('* Mermaid chart for inconsistency', tmp);
                    this.mermaid_chart_inc = tmp;

                    // for imprecision
                    tmp = coe_mermaid_helper.get_imp_mermaid(
                        this.pma.data.coe.info.imprecision
                    );
                    console.log('* Mermaid chart for imprecision', tmp);
                    this.mermaid_chart_imp = tmp;

                    // for indirectness
                    tmp = coe_mermaid_helper.get_ind_mermaid(
                        this.pma.data.coe.info.indirectness
                    );
                    console.log('* Mermaid chart for indirectness', tmp);
                    this.mermaid_chart_ind = tmp;

                },

                get_sample_size: function () {
                    var n = 0;
                    for (let i = 0; i < this.rs.length; i++) {
                        const r = this.rs[i];
                        n += r.Nt;
                        n += r.Nc;
                    }
                    return n;
                },

                to_percentage: function(v) {
                    if (isNaN(v)) {
                        return 'NA';
                    }

                    return (v*100).toFixed(2) + '%';
                }

            },

            updated: function() {
                mermaid.init({ noteMargin: 10 }, '.mermaid');
            }
        });
    }
}

app_coe.init();

function get_data() {
    var params = {
        am: $('#am').val(),
        sm: $('#sm').val(),
        rs: $('#rs').val(),
        hk: $('#hk').val(),
        imp_t: $('#imp_t').val(),
        apikey: $('#apikey').val()
    };
    console.log(params);

    app_coe.vpp.$data.rs = JSON.parse(params.rs);

    // clear the response area
    $('#resp').html('Waiting for response ....');
    $('#img-1').attr('src', '');
    $('#img-2').attr('src', '');

    var base = '';
    // var base = 'https://workspace.network-meta-analysis.com/';
    $.post(
        base + '/rplt/PWMA_PRCM_COE',
        params,
        function (data) {
            console.log('* get return', data);

            app_coe.vpp.update_data(data);

            $('#resp').html(JSON.stringify(data, null, 2));
            // $('#img-1').attr('src', base + data.img['outplt1'].url);
            // $('#img-2').attr('src', base + data.img['cumuplt'].url);
        }, 'json'
    )
}
// show the JSON content of rs in textarea
$('#rs').val(JSON.stringify(rs_sample, null, 2));
</script>
{% endblock %}