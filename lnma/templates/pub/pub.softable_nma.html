<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Summary of Findings: Network Meta-Analysis</title>

<link rel="icon" href="/static/img/favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
<link rel="stylesheet" href="/static/css/mybox-0.9.1.css">

<style>
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
a {
    color: #333333;
    text-decoration: none;
}
#wrapper {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
}
#start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}

/* for this page */
#app {
    width: 100%;
    height: 100%;
}

/* for the simple oclist */

#vw_simple_oclist {
    width: 200px;
    min-width: 200px;
    padding: 0 5px;
    height: 100%;
}
.ae-item {
    display: flex;
    align-items: center;
    width: calc(100% - 10px);
    height: 50px;
    border: 1px solid #dddddd;
    margin: 0 0 10px;
    padding: 0 0 0 10px;
    cursor: pointer;
}
.ae-item:hover {
    background: whitesmoke;
    font-weight: bold;
}
.ae-item-selected {
    background: #ececec;
    font-weight: bold;
}

/* for the NMA table */

#tb_simple_sofnma {
    width: 100%;
}

/* for the SoF table */
.sof-table {
    width: 100%;
}
.sof-table th {
    text-align: center;
    background: whitesmoke;
    padding: 5px 0;
}
.sof-table td {
    text-align: center;
    line-height: 1.45em;
    padding: 3px 0;
    border-bottom: 1px solid #e6e6e6;
    border-right: 1px solid #e6e6e6;
}
.sof-table .col-ae-name {
    width: 150px;
    max-width: 200px;
    cursor: pointer;
}
.sof-table .col-ae-name:hover {
    background: whitesmoke;
}
.sof-table .col-treat {
    width: 100px;
    max-width: 150px;
}
.sof-table .col-comarator {
    background: #ffface;
}
.sof-table .col-ta-left {
    text-align: left !important;
    padding-left: 10px;
}
.sof-table .col-flipable {
    cursor: pointer;
}
.sof-table .col-flipable:hover {
    background: whitesmoke;
}
.cie-table th {
    text-align: left;
    padding: 3px 5px;
}
.cell-treat {
    background: white;
    cursor: pointer;
}
.cell-treat:hover {
    /* background: #efefef; */
}
.cie-bene-4 { background: rgb(55, 86, 35); color: white; }
.cie-bene-3 { background: rgb(84, 130, 53); color: white; }
.cie-bene-2 { background: rgb(169, 208, 142); color: black; }
.cie-bene-1 { background: rgb(198, 224, 180); color: black; }
.cie-harm-4 { background: rgb(150, 0, 0); color: white; }
.cie-harm-3 { background: rgb(220, 0, 0); color: white; }
.cie-harm-2 { background: rgb(255, 50, 50); color: black; }
.cie-harm-1 { background: rgb(255, 125, 125); color: black; }
.cie-nner-2 { background: rgb(202, 183, 10); color: black; }
.cie-nner-1 { background: rgb(250, 248, 133); color: black; }


.legend-table td { padding: 5px 10px; font-size: 14px; }

.dlg-sm h4 { margin: 5px 0; }
.dlg-sm p { margin: 0; }
.dlg-sm hr { border: 0; border-bottom: 1px solid #ececec; }

.red { color: red; }
.grey { color: grey; }
</style>
</head>
<body>
<div id="start-screen">
    <h1>
        <i class="fa fa-table"></i>
        Summary of Findings: Network Meta-Analysis
    </h1>
    <div id="ss-msg">Loading data and initializing ...</div>
</div>

<div id="color_guide" style="display: none;" title="Color guide">
<table class="legend-table">
    <tr>
        <td class="cie-bene-4">High certainty benefit</td>
        <td class="cie-harm-4">High certainty harm</td>
        <td>&nbsp;</td>
    </tr>
    <tr>
        <td class="cie-bene-3">Moderate certainty benefit</td>
        <td class="cie-harm-3">Moderate certainty harm</td>
        <td>&nbsp;</td>
    </tr>
    <tr>
        <td class="cie-bene-2">Low certainty benefit</td>
        <td class="cie-harm-2">Low certainty harm</td>
        <td class="cie-nner-2">Low certainty neither harm nor benefit</td>
    </tr>
    <tr>
        <td class="cie-bene-1">Very low certainty benefit</td>
        <td class="cie-harm-1">Very low certainty harm</td>
        <td class="cie-nner-1">Very low certainty neither harm nor benefit</td>
    </tr>
</table>
</div>
<!-- /div#legend -->

<div id="wrapper">

<div id="app_softnma" class="d-flex fx-row">

    <div id="tb_simple_sofnma">
        <div class="box" style="height: 100%;">
            <div class="box-header">
                <h4>
                    <i class="fa fa-table"></i>
                </h4>
                <div class="d-flex fx-row">

                    <div class="box-menu-group d-flex fx-row">
                        <div class="red">
                            <i class="fa fa-cog"></i>
                            <b>Comparator: </b>
                        </div>
                        <div>
                            <select v-model='comparator'>
                                <option v-for="treat in treat_list"
                                    v-bind:value="treat">
                                    {{ treat }}
                                </option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Display risks per: 
                        </div>
                        <div>
                            <select v-model="baseline">
                                <option value="100">100</option>
                                <option value="1000">1000</option>
                                <option value="10000">10,000</option>
                                <option value="100000">100,000</option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div class="box-menu-link" 
                            onclick="jarvis.show_color_guide();">
                            <i class="fa fa-paint-brush"></i>
                            Color guide
                        </div>
                    </div>
                </div>
            </div>

            <div class="box-body" style="height: 100%; overflow-y: auto;">

                <table class="sof-table">
                    <tr>
                        <th class="col-ae-name">Outcome</th>
                        <th class="col-treat">Comparator: <b class="red">{{ comparator }}</b></th>
                        <th class="col-treat" 
                            v-for="treat in treat_list" 
                            v-if="treat != comparator">
                            {{ treat }}
                        </th>
                    </tr>
                    <tr v-for="r in rs">
                        <td class="col-ae-name">
                            {{ r.oc_fullname }}<br>
                            <span class="grey">( {{ r.oc_measure }} )</span>
                        </td>
                        
                    </tr>
                </table>

            </div>

        </div>

        
    </div>
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<script>

var app_softnma = {
    vpp: null,
    vpp_id: '#app_softnma',
    default_comparator: null,

    vpp_methods: {

    },

    init: function(data) {
        // pre-processing
        var rs = [];

        for (const abbr in data.oc_dict) {
            if (Object.hasOwnProperty.call(data.oc_dict, abbr)) {
                const oc = data.oc_dict[abbr];
                // we need to convert this oc to a format for vpp
                var r = this.conv_oc2r(oc);
                rs.push(r);
            }
        }

        // sort
        rs.sort(function(a, b) {
            return a.oc_fullname.localeCompare(b.oc_fullname);
        });

        // set the app_softnma.default_comparator
        if (this.default_comparator == null) {
            // which means no value given
            // set the first treat
            this.default_comparator = data.treat_list[0];
        }

        // init the vpp
        this.vpp = new Vue({
            el: this.vpp_id,

            data: {
                baseline: 1000,
                show_survival: 'no',
                show_detail: {
                    oc_name: null,
                },
                comparator: this.default_comparator,
                
                oc_dict: data.oc_dict,
                treat_list: data.treat_list,
                rs: rs
            },

            methods: this.vpp_methods
        });
    },

    pre_processing: function(data) {

    },

    conv_oc2r: function(oc) {
        var r = {
            // bind the oc itself
            oc: oc,

            // abbr
            oc_name: oc.extract.abbr,

            // name for quick access
            oc_fullname: oc.extract.meta.full_name,

            // measure for quick access
            oc_measure: oc.extract.meta.measure_of_effect,

            // input_format / datatype for quick access
            oc_data_type: oc.extract.data_type,

            // for display setting
            is_show: {
                // show sm, study info
                sm: true,
                // show ARD, or ARD CI
                ARD: true,
                // show CIR, or CIR CI
                CIR: true
            }
        }

        return r;
    }
};


var jarvis = {
    init: function() {
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // OK, 
        var prj = jarvis.get_url_paramter('prj');
        if (prj == null || prj == '') {
            jarvis.ssmsg('Project information error.')
            return;
        }

        // get the cq_abbr for this project
        var cq = jarvis.get_url_paramter('cq');
        if (cq == null) {
            cq = 'default';
        }

        // get the analysis group, by default just show the primary
        var gp = jarvis.get_url_paramter('gp');
        if (gp == '') {
            gp = 'primary';
        }

        // set default_comparator
        var dc = jarvis.get_url_paramter('dc');
        if (dc == '') {
            app_softnma.default_comparator = null;
        } else {
            app_softnma.default_comparator = dc;
        }

        jarvis.ssmsg('Loading data ...');

        $.get(
            '/pub/graphdata/' + prj + '/SOFTABLE_NMA.json',
            {
                src: 'cache',
                cq: cq,
                gp: gp,
                ver: Math.random()
            },
            function(data) {
                // init the NMA table
                app_softnma.init(data);

                // ok, remove the start screen
                jarvis.ssmsg('Almost initialized.');
                setTimeout('jarvis.ssclose();', 400);

            }, 'json'
        );

    },

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    show_color_guide: function() {
        $('#color_guide').dialog({
            width: 680
        });
    }
};

$(document).ready(function() {
    jarvis.init();
})
</script>
</body>