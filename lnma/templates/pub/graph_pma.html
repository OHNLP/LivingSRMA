<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Pairwise MA Results</title>
<link rel="icon" href="/static/img/favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-F3w7mX95PdgyTmZZMECAngseQB83DfGTowi0iMjiWaeVhAn4FJkqJByhZMI3AhiU" crossorigin="anonymous">
<style>

{% include 'css/basic.css' %}
{% include 'css/box.css' %}
{% include 'css/start_screen.css' %}

html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    font-size: 12px;
}
body {
    overflow-y: hidden;
}
#oc_list {
    width: 250px;
    border-right: 1px solid #aaaaaa;
    padding: 5px;
    overflow-y: auto;
}
.chk-oc-group {
    margin-bottom: 3px;
}
.chk-oc-h3 {
    border-top: 1px solid whitesmoke;
    padding-top: 3px;
    font-weight: bold;
}
.chk-oc {
    padding: 3px 5px;
    cursor: pointer;
}
.chk-oc:hover {
    background-color: whitesmoke;
}
.chk-oc-selected {
    background-color: #cfcfcf;
    font-weight: bold;
}
#oc_plot {
    width: 700px;
    height: auto;
    min-height: 100px;
    padding: 5px;
}
</style>
</head>
<body>
<div id="start-screen">
    <h1>
        <i class="fa fa-chart-bar"></i>
        Pairwise Meta-Analysis Plots
    </h1>
    <div id="ss-msg">System initializing ...</div>
</div>

<div class="flex-container" style="width:100%; height:100%;">

<div id="app_graphpma"
    style="height: 100%;"
    class="d-flex flex-row">

    <div id="oc_list">

        <div v-for="(group, group_idx) in extract_tree_sorted.groups"
            v-if="is_show_group(group.abbr)"
            class="mt-1 mb-1">
            <div class="chk-oc-h2 d-flex flex-row justify-content-between cursor-pointer"
                v-if="enabled_group == 'all'">
                <div class="ml-1 font-weight-bold">
                    &nbsp; 
                    {{ _lbl(group.abbr) }}
                </div>
            </div>

            <div v-for="(cate, cate_idx) in group.cates"
                class="chk-oc-group">
                <div class="chk-oc-h3 d-flex flex-row justify-content-between cursor-pointer"
                    v-if="group.cates.length > 1">
                    <div class="ml-1">
                        <i class="far fa-folder-open"></i>
                        {{ cate.name }}
                    </div>
                </div>

                <div v-for="(oc, oc_idx) in cate.ocs"
                    class="chk-oc d-flex flex-row"
                    v-bind:class="{'chk-oc-selected': oc.abbr == selected_oc_abbr}">
                    <div class="d-flex flex-row justify-content-between flex-fill"
                        title="Click to check the forest plot"
                        v-on:click="toggle_oc(oc.abbr)">
                        <div>
                            <i class="far fa-clipboard"></i>
                            {{ oc.meta.full_name }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>

    <div id="oc_plot">
        <div>
            <h4>
                Forest Plot for 
                <span v-if="oc_dict[selected_oc_abbr].extract.meta.category != 'default'">
                    {{ oc_dict[selected_oc_abbr].extract.meta.category }} | 
                </span>
                {{ oc_dict[selected_oc_abbr].extract.meta.full_name }}
            </h4>
        </div>
        <div id="fg_pwma_forest" style="width: 100%; height: 100%;">
            <svg id="fg_pwma_forest_svg"></svg>
        </div>
        <div id="fg_subg_forest" style="width: 100%; height: 100%;">
            <svg id="fg_subg_forest_svg"></svg>
        </div>

    </div>

</div>

</div><!-- .flex-container -->

<!-- use third party libs -->

<!-- jQuery first, then Popper.js, then Bootstrap JS -->
<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
<!-- jQuery UI -->
<script src="https://code.jquery.com/ui/1.12.0/jquery-ui.min.js"></script>
<!-- Vue.js -->
<script src="https://cdn.jsdelivr.net/npm/vue@2.6.11"></script>
<!-- filesaver -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>
<!-- dayjs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.8.36/dayjs.min.js"></script>

<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.0/d3.min.js"></script>

<!-- chart.js -->
<!-- <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> -->
<!-- PapaParse -->
<!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script> -->
<!-- Shepherd -->
<script src="https://cdn.jsdelivr.net/npm/shepherd.js@8.3.1/dist/js/shepherd.min.js"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@8.3.1/dist/css/shepherd.css">

<!-- bootstrap -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.1/dist/js/bootstrap.bundle.min.js" integrity="sha384-/bQdsTh/da6pkI1MST/rWKFNjaCP5gBSY4sEBT38Q/9RBh9AH40zEOg7Hlq2THRZ" crossorigin="anonymous"></script>


<!-- for IE -->
<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<!-- My Scripts -->
<script>

{% include 'js/srv_pubmed.js' %}

{% include 'js/srv_shared.js' %}

///////////////////////////////////////////////////////////
// The plots for PWMA
///////////////////////////////////////////////////////////
{% include 'js/fgmk_pwma_forest.js' %}
{% include 'js/fgmk_subg_forest.js' %}


// Alias for the pwma plots
var fg_pwma_forest = fgmk_pwma_forest.make_fig(
    'fg_pwma_forest'
);
// Alias for the subg plots
var fg_subg_forest = fgmk_subg_forest.make_fig(
    'fg_subg_forest'
);

// the main app
var app_graphpma = {
    vpp: null,
    vpp_id: '#app_graphpma',

    init: function(data, group, foc) {
        if (typeof(group) == 'undefined') {
            group = 'all';
        }
        if (typeof(foc) == 'undefined') {
            foc = null;
        }
        this.data = data;

        // pre processing the oc_dict
        for (const abbr in this.data.oc_dict) {
            if (Object.hasOwnProperty.call(this.data.oc_dict, abbr)) {
                this.data.oc_dict[abbr]._is_selected = false;
                
            }
        }

        // convert the oc_dict to a tree object
        var extracts = [];
        for (const oc_abbr in data.oc_dict) {
            if (Object.hasOwnProperty.call(data.oc_dict, oc_abbr)) {
                // skip those not be
                if (this.data.oc_dict[oc_abbr].extract.meta.group == group ||
                    group == 'all') {
                    const oc = data.oc_dict[oc_abbr];
                    extracts.push(oc.extract);
                }
            }
        }
        var extract_tree = srv_shared.create_extract_tree(extracts);
        var extract_tree_sorted = srv_shared.create_extract_tree_sorted(
            extract_tree,
            true
        );

        // and we just need the only type pwma,
        // because this is the pwma graph plot
        extract_tree_sorted = extract_tree_sorted[0];
        var first_oc_abbr = extract_tree_sorted.groups[0].cates[0].ocs[0].abbr;

        // init the vpp
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                oc_dict: this.data.oc_dict,
                extract_tree_sorted: extract_tree_sorted,

                // which oc to show first?
                selected_oc_abbr: first_oc_abbr,

                // which group to display?
                enabled_group: group,

                // other settings
                sms: {
                    'OR': { sm: 'OR', name: 'Odds Ratio'},
                    'RR': { sm: 'RR', name: 'Risk Ratio'},
                    'HR': { sm: 'HR', name: 'Hazard Ratio'},
                    'RD': { sm: 'RD', name: 'Risk Difference'},
                    'PLOGIT': { sm: 'PLOGIT', name: 'Logit Trans.'},
                },
            },

            methods: {
                _lbl: function(s) {
                    return s;
                },

                is_show_group: function(g) {
                    if (this.enabled_group == 'all') {
                        return true;
                    }
                    if (this.enabled_group == g) {
                        return true;
                    }
                    return false;
                },

                toggle_oc: function(oc_abbr) {
                    var oc = this.oc_dict[oc_abbr];
                    console.log('* toggle oc', oc);

                    this.clear_selection();
                    this.oc_dict[oc_abbr]._is_selected = true;
                    this.selected_oc_abbr = oc_abbr;

                    this.plot_oc(
                        this.oc_dict[oc_abbr]
                    );
                },

                plot_oc: function(oc) {
                    var sm = oc.extract.meta.measure_of_effect;
                    
                    // by default, the first oc is plotted.
                    var plot_data = oc.results[0];

                    // but 
                    var cfg = {
                        sm: this.sms[sm],
                        mode: 'pwma_prcm',
                        params: plot_data.cfg
                    };

                    // no matter which is selected, just clear
                    fg_pwma_forest.hide();
                    fg_subg_forest.hide();

                    if (oc.extract.meta.group == 'subgroup') {
                        // use subgroup to draw this figure
                        // the subg will use both primma and subg
                        fg_subg_forest.draw(
                            oc.extract,
                            plot_data.rst.data, 
                            cfg
                        );
                    } else {
                        // use the standard forest plot
                        fg_pwma_forest.draw(
                            plot_data.rst.data.primma, 
                            cfg
                        );
                    }
                    
                },

                clear_selection: function() {
                    for (const abbr in this.oc_dict) {
                        if (Object.hasOwnProperty.call(this.oc_dict, abbr)) {
                            this.oc_dict[abbr]._is_selected = false;
                        }
                    }
                }
            },

            mounted: function() {
                // just run once
                this.toggle_oc(this.selected_oc_abbr);
            }
        });
    }
};

var jarvis = {
    
    init: function() {
        
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // get filename
        var prj = jarvis.get_url_paramter('prj');

        // the cq abbr
        var cq = jarvis.get_url_paramter('cq');
        if (cq == '') {
            cq = 'default';
        }

        // the analysis group
        var gp = jarvis.get_url_paramter('gp');
        if (gp == '') {
            gp = 'primary';
        }
        
        // the first oc to show
        var foc = jarvis.get_url_paramter('foc');
        if (foc == '') {
            foc = null;
        }

        // where to get the data
        var src = jarvis.get_url_paramter('src');
        if (src == '') {
            src = 'cache';
        }
        
        // set the sorting
        var od = jarvis.get_url_paramter('od');
        if (od == '') {
            jarvis.oc_orders = [];
        } else {
            od = od.toLocaleLowerCase();
            jarvis.oc_orders = od.split(';');
        }

        jarvis.ssmsg('Loading data ...');

        // send request to get data for initializing app
        $.get(
            "/pub/graphdata/" + prj + "/GRAPH_PMA.json",
            {
                ver: Math.random(), 
                src: src, 
                cq: cq,
                gp: gp
            },
            (function(gp, foc){
                return function(data) {
                    app_graphpma.init(data, gp, foc);
                    jarvis.ssmsg('Data loaded!');
                    setTimeout('jarvis.ssclose();', 300);
                }
            })(gp, foc), 'json'
        );

        
    },

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    }
};

// include the jarvis extensions
{% include 'js/jarvis_ext_compare_oc_names.js' %}

$(document).ready(function() {
    jarvis.init();
})

</script>
</body>
</html>