<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
<meta http-equiv="X-UA-Compatible" content="IE=edge">

<title>PRISMA for IO</title>
<link rel="icon" href="/static/img/favicon.png" type="image/png">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />

<link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/@mdi/font@4.x/css/materialdesignicons.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.min.css" rel="stylesheet">

<style>
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
p {
    margin: .1rem;
}
a {
    color: #333333;
    text-decoration: none;
}
.d-flex {
    display: flex;
}
.flex-container {
    display: flex;
    justify-content: flex-start;
    width: 100%;
    height: 100%;
}
.box {
    display: flex;
    flex-direction: column;
    width: 100%;
}
.box-header {
    width: 100%;
    padding: 3px 0;
    display: flex;
    flex-direction: row;
}
.box-header a {
    font-size: .8em;
}
.box-header h4 {
    padding: 0;
    margin: 0;
    font-size: .95em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
}
.box-header button, 
.box-body button, 
.box-footer button {
    height: 1.6em;
    line-height: 1em;
    font-size: .8em;
    margin: 4px;
}
.box-header input,
.box-body input {
    height: 1em;
    line-height: 1em;
    font-size: 1em;
    margin: 4px 4px 0 4px;
}
.box-header select {
    height: 1.6em;
    line-height: 1.2em;
    font-size: .8em;
    margin: 4px;
}
.box-header p {
    height: 1.6em;
    line-height: 1.2em;
    font-size: 1em;
    margin: 5px 0 0 2px;
}
.box-header span {
    font-size: .9em;
}
.box-header-right {
    font-size: .95em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
    text-align: right;
}
.box-header a {
    padding: 1px 3px;
    margin: 0 5px;
    height: 1.6em;
    line-height: 1.6em;
}
.box-header a:hover {
    text-decoration: underline;
}
.box-body {
    width: 100%;
}
.box-body-item {
    padding: 5px 0 5px 0;
    display: flex;
    flex-direction: column;
    border-bottom: 1px dotted #cccccc;
}
/* for left - right items */
.box-body-item-left {
    width: 73%;
}
.box-body-item-right {
    width: 24%;
    display: flex;
    flex-direction: row;
}
.box-body-item-label {
    width: 54%;
    font-size: .9em;
    line-height: 1.8em;
}
.box-body-item-value {
    width: 45%;
}
.box-body-item select {
    width: 100%;
}
/* the label values items */
.bbi-label {
    width: 100%;
    padding: 0 0 3px 0;
    font-size: .8em;
    color: #666666;
    /* just for using the question marks */
    justify-content: space-between;
}
.bbi-value {
    width: 100%;
    padding: 2px 0px 2px 10px;
    font-size: .9em;
    color: #000000;
}
.bbi-label-hint {
    color: #999999;
    cursor: help;
}
.bbi-label-hint:hover {
    color: #333333;
}
.box-body h5 {
    padding: 0;
    margin: 0;
    font-size: .95em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
}
.box-p {
    width: 100%;
    padding: 0;
    margin: 0;
    font-size: .9em;
}
.box-p-fixlen {    
    white-space: nowrap;
    text-overflow:ellipsis;
    overflow: hidden;
}
.box-footer {
    width: 100%;
    min-height: 20px;
    padding: 5px 0 5px 0;
}
.footer {
    width: 100%;
    align-items: flex-end;
    font-size: .75em;
    line-height: 1.5em;
    height: 1.5em;
}
.footer div {
    height: 1em;
    line-height: 1em;
}
.footer-link a {
    padding: 0 5px;
    color: #999999;
}

/* element ui css */
.text-start {
    font-size: 10px;
}
.v-data-table td {
    font-size: .8rem;
}
/* layouts */
#wrapper {
    flex-direction: row;
}
#start-screen {
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}
/* page */
.ss-box {
    position: absolute;
    width: 150px;
    /* height: 50px; */
    border: 1px solid #666666;
    padding: 5px;
    text-align: center;
    box-shadow: 3px 3px #cccccc;
    cursor: pointer;
    background-color: white;
}
.ss-box2 {
    border: 1px solid #ab7e3b;
    background-color: #fff9dc;
}
.ss-box2:hover {
    background: #fff9dc;
    box-shadow: 3px 3px #aaaaaa;
}
.ss-box3 {
    border-radius: 10px;
    border: 3px solid red;
}
.ss-info {
    /* max-height: 32px; */
    line-height: 15px;
    text-overflow: ellipsis;
    overflow: hidden;
}
.ss-box-stage {
    font-weight: normal;
}
.ss-box-stage:hover {
    font-weight: bold;
}
.ss-box-stage-hover {
    font-weight: bold;
}
.ss-number {
    font-size: .9rem;
}
.ss-arrow {
    position: absolute;
    text-align: center;
    font-size: 2rem;
}
.ss-box-legend-text {
    margin-left: 30px;
    line-height: 10px;
    font-size: 11px;
    white-space: nowrap;
}
/* component */
.result-list-item {
    margin-bottom: 5px;
}
.result-list-item:hover,
.result-list-item:active {
    background-color: #eeeeee;
}
.study-badge {
    color: white;
    background: #6762df;
    padding: 0px 3px;
    border-radius: 5px;
}
.study-title {
    font-size: 1.1em;
    padding: 0 0 0 .2em;
    color: mediumblue;
}
.study-title:hover {
    color: blue;
}
.study-authors {
    padding: 0 0 0 .2em;
    font-size: .95em;
}
.study-pub {
    padding: 0 0 0 .2em;
    font-size: .9em;
}
.study-journal {
    font-weight: bold;
}
.study-pmid {
    color: gray;
}
.study-pmid:hover {
    color: darkblue;
    text-decoration: none;
}
.dialog p {
    font-size: 14px;
}
</style>
</head>
<body>

<div id="start-screen">
    <h1>
        <i class="fa fa-table"></i>
        PRISMA Flow Diagram
    </h1>
    <div id="ss-msg">Table Initializing ...</div>
</div>

<div id="wrapper" class="flex-container">

<div id="fg_prisma" class="box" style="width: 500px; min-width: 500px;">

    {% include 'svg/PRISMA_IO_v2.8.svg' %}

</div><!-- /#fg_prisma -->

<div id="tb_studylist" class="box" style="width: calc(100%-500px); min-width: 500px;">

    <div class="box-header">
        <h4>
            <i class="fa fa-file"></i>
            Study List | 
        </h4>
        <div>
            <p>{{ short_title }}</p>
        </div>
    </div>

    <div class="box-body" style="overflow-y: auto;"
        v-if="total > 0">
        <div class="box-body-item result-list-item"
            v-for="r, idx in studies">

            <div class="study-title" style="cursor: pointer;"
                v-bind:title="'[' + r.title + ']'"
                v-on:click="show_study(r.pmid)">
                <span class="study-badge">{{ idx + 1 }}</span>
                {{ r.title }}
            </div>

            <div class="study-authors">
                {{ r.authors }}
            </div>

            <div class="study-pub">
                {{ r.date }} 
                <span class="study-journal">{{ r.journal }}</span class="">
                &nbsp;
                <a class="study-pmid" 
                    target="_blank" 
                    title="Open the page in PubMed" 
                    v-bind:href="url.pubmed.view_pmid + r.pmid">
                    {{ r.pid }}
                </a>
                &nbsp;
                <a class="study-pmid" 
                    target="_blank" 
                    title="Open the page in ClinicalTrials.gov" 
                    v-bind:href="url.ctgov.view_ct + r.ctid">
                    {{ r.ctid }}
                </a>
            </div>

        </div>
    </div>

    <div class="box-footer" style="text-align: right; padding: 0 0 10px 0;">
        <div v-if="tp>1">
            <button class="btn"
                v-on:click="prev_page">
                <i class="fa fa-arrow-left"></i>
                Prev Page
            </button>
            <button class="btn"
                v-on:click="next_page">
                <i class="fa fa-arrow-right"></i>
                Next Page
            </button>
        </div>
    </div>
</div><!-- /#tbl_study -->

</div>
<div id="dialog-message-e2" class="dialog" title="Excluded by full text review">
    <p>
    Full-text articles excluded.
    </p>
</div>
<div style="display:none;" id="data_pub">
[[j|safe]]
</div>

<!-- use third party libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>

<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js"></script>
<script src="/static/lib/d3/d3-sankey.js"></script>
<!-- vuetify -->
<script src="https://cdn.jsdelivr.net/npm/vuetify@2.x/dist/vuetify.js"></script>
<!-- alasql.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>
<script>

{% include 'js/srv_pubmed.js' %}

var tb_studylist = {
    vpp: null,
    vpp_id: '#tb_studylist',
    data: {},
    all_rs: [],
    
    init: function(data) {
        this.data = data;
        // create a st for summary

        // init the UI
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                total: this.all_rs.length,
                pn: 0,
                tp: 1,
                short_title: '',
                url: jarvis.url,
                studies: this.all_rs
            },
            methods: {
                show_study: function(pid) {
                    if (pid.length == 8) {
                        srv_pubmed.show(pid);
                    }
                },

                prev_page: function() {
                    if (this.pn > 0) {
                        this.pn -= 1;
                        tb_search.search(
                            tb_search.vpp.keyword,
                            tb_search.vpp.pn * tb_search.retmax
                        );
                    }
                },

                next_page: function() {
                    if (this.pn < this.tp) {
                        this.pn += 1;
                        tb_search.search(
                            tb_search.vpp.keyword,
                            tb_search.vpp.pn * tb_search.retmax
                        );
                    }
                },
            }
        });
    },

    unpack: function(rows, key) {
        return rows.map(function(row) {
            return row[key];
        });
    },

    clear: function() {
        this.vpp.n = 0;
        this.vpp.headers = [];
        this.vpp.studies = [];
    },

    set_stage: function(stage, studies) {
        this.vpp.stage = stage;
        this.vpp.studies = studies;
    },

    update_study_list: function(sn, stage) {
        console.log("* update study list " + sn + ', ' + stage);
        // filter the studies
        var studies = [];

        for (var i = 0; i < this.data.prisma_data.studylist[sn][stage].length; i++) {
            var pid = this.data.prisma_data.studylist[sn][stage][i];
            // console.log(pid);
            // it should be there ...
            // 2021-05-22: it may not be there
            if (this.data.study_paper.paper_dict.hasOwnProperty(pid)) {
                var study = this.data.study_paper.paper_dict[pid];
                studies.push(study);

            } else {
                console.log('* missing pid', pid);

                // put an empty object
                studies.push({
                    authors: "",
                    ctid: '',
                    date: '',
                    journal: '',
                    pid_type: 'pid',
                    pmid: pid,
                    title: pid
                });
            }
        }
        this.vpp.studies = studies;
        this.vpp.total = studies.length;
        this.vpp.short_title = "The " + studies.length + 
            " studies included in " + jarvis.txt_stage(stage) + 
            " of " + jarvis.txt_sn(sn);
    }
}

var prisma_data = {
    "sns": [
        's1', 's2', 's3', 's4', 's5', 's6', 's7', 'lv', 'st'
    ],
    "search": {
        "s1": { "date": "09/11/2018" },
        "s2": { "date": "01/13/2019" },
        "s3": { "date": "03/16/2019" },
        "s4": { "date": "06/04/2019" },
        "s5": { "date": "10/04/2019" },
        "s6": { "date": "04/06/2020" },
        "s7": { "date": "08/04/2020" },
        // st is the total part
        'st': { 'date': '' },
        // lv is the living part
        'lv': { 'date': '' }
    },
    "prisma": {
        /**
         * b1: Records retrieved from database search 
           b3: Records Screened (b3 = b5 + e1)
           b5: Full text articles assessed for eligibility (b5 = f1 + e3)
           e1: Records excluded by title and abstract
           e3: Full text excluded with reasons
           f1: Studies included in systematic review
           f2: Studies included in meta-analysis

           for different stage:
           s1-7 is each search
           st is the total, lv is the living part
         */
        "s1": { "b1": 5663, "b2": 0, "b3": 5648, "b4": 0, "b5": 2022, "f1": 42, "f2": 38, "e1": 3626, "e3": 1980, "e2": 0},
        "s2": { "b1": 824,  "b2": 0, "b3":  802, "b4": 0, "b5":  292, "f1":  7, "f2":  5, "e1":  510, "e3":  285, "e2": 0},
        "s3": { "b1": 406,  "b2": 0, "b3":  386, "b4": 0, "b5":  237, "f1":  7, "f2":  5, "e1":  149, "e3":  230, "e2": 0},
        "s4": { "b1": 444,  "b2": 0, "b3":  444, "b4": 0, "b5":  282, "f1":  6, "f2":  5, "e1":  162, "e3":  276, "e2": 0},
        "s5": { "b1": 663,  "b2": 0, "b3":  663, "b4": 0, "b5":  404, "f1":  6, "f2":  4, "e1":  259, "e3":  398, "e2": 0},
        "s6": { "b1": 1218, "b2": 0, "b3": 1196, "b4": 0, "b5":  802, "f1": 12, "f2":  6, "e1":  394, "e3":  790, "e2": 0},
        "s7": { "b1": 539,  "b2": 0, "b3":  539, "b4": 0, "b5":  356, "f1": 16, "f2": 13, "e1":  183, "e3":  340, "e2": 0},
        "st": { "b1": 0,    "b2": 0, "b3":    0, "b4": 0, "b5":    0, "f1":  0, "f2":  0, "e1":    0, "e3":    0, "e2": 0},
        "lv": { "b1": 0,    "b2": 0, "b3":    0, "b4": 0, "b5":    0, "f1":  0, "f2":  0, "e1":    0, "e3":    0, "e2": 0},
    },
    "studylist": {
        "s1": {
            "sr": [
                "29268948",
                "28212060",
                "28655793",
                "28993052",
                "30052729",
                "29880231",
                "27718784",
                "29884413",
                "26406148",
                "29867230",
                "29562145",
                "22547592",
                "22858559",
                "26412456",
                "26028407",
                "26712084",
                "26970723",
                "27458307",
                "28636851",
                "28854067",
                "28885881",
                "27745820",
                "27979383",
                "29777823",
                "29658856",
                "29863955",
                "21639810",
                "20525992",
                "23295794",
                "29658430",
                "26115796",
                "28961465",
                "27717298",
                "25795410",
                "28671856",
                "25399552",
                "28729154",
                "24831977",
                "28034081",
                "27718847",
                "23942774",
                "25840693"
            ],
            "ma": [
                "29268948",
                "28212060",
                "28655793",
                "28993052",
                "30052729",
                "29880231",
                "27718784",
                "29884413",
                "26406148",
                "29562145",
                "22547592",
                "22858559",
                "26412456",
                "26028407",
                "26712084",
                "26970723",
                "27458307",
                "28636851",
                "28854067",
                "28885881",
                "27745820",
                "29658856",
                "29863955",
                "21639810",
                "20525992",
                "23295794",
                "29658430",
                "26115796",
                "28961465",
                "27717298",
                "25795410",
                "28671856",
                "25399552",
                "28729154",
                "24831977",
                "28034081",
                "27718847",
                "25840693"
            ]
        },
        "s2": {
            "sr": [
                "30345906",
                "30509740",
                "30280658",
                "30262187",
                "30280641",
                "30280635",
                "29658845"
            ],
            "ma": [
                "30345906",
                "30509740",
                "30262187",
                "30280641",
                "29658845"
            ]
        },
        "s3": {
            "sr": [
                "30779531",
                "30779529",
                "30138764",
                "30664989",
                "30620668",
                "30659987",
                "30763730"
            ],
            "ma": [
                "30779531",
                "30779529",
                "30138764",
                "30620668",
                "30659987"
            ]
        },
        "s4": {
            "sr": [
                "31050707",
                "31095287",
                "31003911",
                "31079938",
                "30955977",
                "31122901"
            ],
            "ma": [
                "31050707",
                "31095287",
                "31079938",
                "30955977",
                "31122901"
            ]
        },
        "s5": {
            "sr": [
                "31427204",
                "31562796",
                "31171878",
                "30422243",
                "31327687",
                "31327689"
            ],
            "ma": [
                "31427204",
                "31562796",
                "31171878",
                "30422243"
            ]
        },
        "s6": {
            "sr": [
                "31863227",
                "31790344",
                "31582355",
                "32053137",
                "31590988",
                "31786121",
                "31679945",
                "31959349",
                "32114502",
                "32201234",
                "32101663",
                "31880964"
            ],
            "ma": [
                "31863227",
                "31790344",
                "31582355",
                "31590988",
                "31679945",
                "32201234"
            ]
        },
        "s7": {
            "sr": [
                "32416781",
                "32591464",
                "32468956",
                "32271377",
                "32661118",
                "32302702",
                "32534646",
                "32437507",
                "32271672",
                "32416780",
                "32402160",
                "32294530",
                "32379280",
                "32271354",
                "32673417",
                "32339648"
            ],
            "ma": [
                "32416781",
                "32468956",
                "32271377",
                "32661118",
                "32302702",
                "32534646",
                "32437507",
                "32271672",
                "32416780",
                "32402160",
                "32294530",
                "32271354",
                "32673417"
            ]
        },
        // st is the total
        'st': {
            'sr': [],
            'ma': []
        },
        // lv is the living
        'lv': {
            'sr': [],
            'ma': []
        }
    },
}

var jarvis = {
    data: null,
    tokens: [
        'b1', 'b2', 'b3', 'b4', 'b5', 
        'e1', 'e2', 'e3',
        'f1', 'f2', 
    ],
    url: {
        sel_pred: './hsra_pred',
        ctgov: {
            view_ct: 'https://clinicaltrials.gov/ct2/show/'
        },
        pubmed: {
            esearch: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esearch.fcgi?db=pubmed',
            esummary: 'https://eutils.ncbi.nlm.nih.gov/entrez/eutils/esummary.fcgi?db=pubmed',
            efetch: "https://eutils.ncbi.nlm.nih.gov/entrez/eutils/efetch.fcgi?db=pubmed",
            view_pmid: 'https://pubmed.ncbi.nlm.nih.gov/'
        },
    },

    current: {
        sn: 's6',
        total: 7
    },

    txt_stage: function(stage) {
        return {
            'ma': 'meta-analysis',
            'sr': 'systematic review'
        }[stage];
    },

    txt_sn: function(sn) {
        return {
            's1': 'search 1',
            's2': 'search 2',
            's3': 'search 3',
            's4': 'search 4',
            's5': 'search 5',
            's6': 'search 6',
            's7': 'search 7',
            'lv': 'living update',
            'st': 'all searches'
        }[sn];
    },

    prisma_title_id: 'prisma_title',

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    load: function() {
        // for the message boxes
        $( ".dialog" ).dialog({
            autoOpen: false
        });

        var prj = jarvis.get_url_paramter('prj');
        var cq = jarvis.get_url_paramter('cq');

        if (cq == '') {
            cq = 'default';
        }

        $.get(
            '/pub/graphdata/IO/PRISMA.json',
            { 
                rnd: Math.random(),
                src: 'db',
                cq: cq
            },
            function(data) {
                jarvis.init(data);
            }
        );
    },

    init: function(data) {
        console.log(data);
        // the definition of PRISMA is different from 
        // others, so need to update the data structure
        // first, the f2 is the f3 from API
        data.prisma['f2'] = JSON.parse(
            JSON.stringify(data.prisma.f3)
        );
        // then, the e1 (excluded by title) is e21 from API
        data.prisma['e1'] = JSON.parse(
            JSON.stringify(data.prisma.e21)
        );
        // last, the e2 should be e22 from API
        data.prisma['e2'] = data.prisma.e22;

        // bind the raw data
        jarvis.raw_prisma = data;

        // update the prisma_data
        this.init_prisma_data(data);
        
        // bind data to jarvis
        jarvis.data = prisma_data;

        // init the figure
        this.init_prisma_figure(data);

        // bind events
        this.bind_events();

        // change to the total
        jarvis.update_prisma('st');

        // init the studylist
        tb_studylist.init({
            prisma_data: prisma_data,
            study_paper: data
        });

        // set the default view
        tb_studylist.update_study_list('st', 'ma');

        // done!
        jarvis.ssmsg('Data loaded!');
        setTimeout('jarvis.ssclose();', 300);

    },

    bind_events: function() {
        // bind the click event
        $('svg a').on('click', function(evt) {
            var link = $(this).attr('xlink:href');
            console.log("* clicked: " + link);
            
            // click the studylist link
            var ps = link.split('_');
            var sn = ps[1];
            var op = ps[2];
            var stage = ps[3];

            // decide what to do with op
            if (op == 'sch') {
                // clicked the search item
                // update the PRISMA plot
                jarvis.update_prisma(sn);

            } else if (op == 'cnt') {
                // clicked the number
                // update the study list
                if (sn == 'xx') {
                    // clicked the cell in the PRISMA plot
                    tb_studylist.update_study_list(jarvis.current.sn, stage);

                } else {
                    // update plot
                    jarvis.update_prisma(sn);

                    // update list
                    tb_studylist.update_study_list(sn, stage);
                }
            }
            return false;
        });
        $('svg a').hover(
            function(evt) {
                var fill = $($(this)[0].childNodes[1]).attr('fill');
                $($(this)[0].childNodes[1]).attr('fill_bak', fill);
                $($(this)[0].childNodes[1]).attr('fill', '#fdec12');
            },
            function(evt) {
                var fill = $($(this)[0].childNodes[1]).attr('fill_bak');
                $($(this)[0].childNodes[1]).attr('fill', fill);
            }
        );
    },

    init_prisma_figure: function(data) {
        // replace the $$ with jquery findable tag
        var svgtxt = document.getElementById('fg_prisma').innerHTML;

        // replace the prisma title
        svgtxt = svgtxt.replace(
            '$prisma_title$', 
            '<span id="'+jarvis.prisma_title_id+'">&nbsp;</span>'
        );

        // replace the total numbers
        svgtxt = svgtxt.replace('$tt_f1$', prisma_data.prisma.st.f1);
        svgtxt = svgtxt.replace('$tt_b1$', prisma_data.prisma.st.b1);
        // svgtxt = svgtxt.replace('$tt_stage_screening$', jarvis.raw_prisma.stat.unscreened);

        // replace the numbers
        for (var i = 0; i < prisma_data.sns.length; i++) {
            var sn = prisma_data.sns[i];
            svgtxt = svgtxt.replace('$'+sn+'_cnt_sr$', '' + prisma_data.prisma[sn].f1);
            svgtxt = svgtxt.replace('$'+sn+'_cnt_ma$', '' + prisma_data.prisma[sn].f2);
            svgtxt = svgtxt.replace('$'+sn+'_date$', '' + prisma_data.search[sn].date);
        }

        // replace the PRISMA token
        for (var i = 0; i < jarvis.tokens.length; i++) {
            var token = jarvis.tokens[i];
            svgtxt = svgtxt.replace('$'+token+'$', '<span id="val_'+token+'"> - </span>');
        }
        document.getElementById('fg_prisma').innerHTML = svgtxt;
    },


    init_prisma_data: function(data) {
        // merge the total part
        this.__merge_total_prisma(data);

        // merge the living part
        this.__merge_living_prisma(data);
    },

    __merge_living_prisma: function(data) {
        // there are 3 things to do for the prisma
        // 1. update the date
        prisma_data.search.lv.date = data.latest.last_updated;

        // 2. update the prisma number
        // merge the living part

        // the a1 from API is just the living part
        prisma_data.prisma.lv.b1 = data.prisma.a1.n_pmids;

        // the e1 and e2 from the API is the living part
        prisma_data.prisma.lv.e1 = data.prisma.e1.n_pmids 
                                 + data.prisma.e2.n_pmids;
        prisma_data.prisma.lv.e2 = data.prisma.e2.n_pmids;
        prisma_data.prisma.lv.e3 = data.prisma.e3.n_pmids;

        // the f1 and f3 from API are the sum, so need to exclude search 1-7
        prisma_data.prisma.lv.f1 = data.prisma.f1.n_pmids - 96;
        prisma_data.prisma.lv.f2 = data.prisma.f3.n_pmids - 76;

        // the b5 is the sum of f1 and e3
        prisma_data.prisma.lv.b5 = prisma_data.prisma.lv.f1
                                 + prisma_data.prisma.lv.e3;

        // the b3 is the sum of b5 and e1
        prisma_data.prisma.lv.b3 = prisma_data.prisma.lv.b5
                                 + prisma_data.prisma.lv.e1;

        // 3. update the studylist
        // 3.1 get the total list of search 1 - 7

        // the total SR pids
        var s17_sr_pids = [];
        // the total MA pids
        var s17_ma_pids = [];

        for (var i = 1; i <= 7; i++) {
            var sn = 's' + i;
            // merge the pids of 7 searches
            s17_sr_pids = s17_sr_pids.concat(prisma_data.studylist[sn]['sr']);
            s17_ma_pids = s17_ma_pids.concat(prisma_data.studylist[sn]['ma']);
        }

        // 3.2 get different part, which is the living?
        var lv_sr = jarvis.difference_set(
            new Set( data.prisma.f1.paper_list ),
            new Set( s17_sr_pids )
        );
        var lv_ma = jarvis.difference_set(
            new Set( data.prisma.f3.paper_list ),
            new Set( s17_ma_pids )
        );

        // 3.3 update the list
        prisma_data.studylist.lv.sr = Array.from(lv_sr);
        prisma_data.studylist.lv.ma = Array.from(lv_ma);
    },

    __merge_total_prisma: function(data) {
        // 1. update the date
        prisma_data.search['st'] = {
            'date': data.latest.last_created
        }

        // 2. update the prisma number
        var st_prisma = { 
            "b1": 0, "b2": 0, "b3": 0, "b4": 0, "b5": 0, 
            "e1": 0, "e2": 0, "e3": 0,
            "f1": 0, "f2": 0, 
        };
        // merge the prisma total numbers of the previous 7 searches
        for (var i = 1; i <= 7; i++) {
            var sn = 's' + i;
            // merge the numbers of 7 searches
            for (var j = 0; j < jarvis.tokens.length; j++) {
                var token = jarvis.tokens[j];
                st_prisma[token] += prisma_data.prisma[sn][token];
            }
        }

        // merge the b1
        st_prisma.b1 += data.prisma.a1.n_pmids;

        // the f1 from API is the sum of all included in SR
        st_prisma.f1 = data.prisma.f1.n_pmids;

        // the f3 from API is the sum of all included in MA
        st_prisma.f2 = data.prisma.f3.n_pmids;

        // the e3 from API is just the living part of excluded by full-text
        st_prisma.e3 += data.prisma.e3.n_pmids;

        // the e1 and e2 from API is just the living part of exclude by title and abs
        st_prisma.e1 += data.prisma.e1.n_pmids 
                      + data.prisma.e2.n_pmids;

        // then the b5 is the sum of f1 and e3
        st_prisma.b5 = st_prisma.f1 
                     + st_prisma.e3;

        // then the b3 is the sum of b5 and e1
        st_prisma.b3 = st_prisma.b5 
                     + st_prisma.e1;

        // 3. update the sr and ma in st
        // the list in f1 and f2 from API is the sum of all included
        prisma_data.studylist['st'].sr = data.prisma.f1.paper_list;
        prisma_data.studylist['st'].ma = data.prisma.f2.paper_list;
    
        // set result
        prisma_data.prisma['st'] = st_prisma;
    },

    update_prisma: function(sn) {
        if (sn == 'xx') { return }
        jarvis.current.sn = sn;
        var title = "The PRISMA plot of " + jarvis.txt_sn(sn) + 
            ' (' + jarvis.data.search[sn].date + ')';
        $('#' + jarvis.prisma_title_id).html(title);

        for (let i = 0; i < jarvis.tokens.length; i++) {
            var token = jarvis.tokens[i];
            var val = jarvis.data.prisma[sn][token];
            val = jarvis.add_commas_to_number(val);
            $('#val_' + token).html(val);
        }
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    union_set: function(setA, setB) {
        let _union = new Set(setA)
        for (let elem of setB) {
            _union.add(elem)
        }
        return _union;
    },

    difference_set: function(setA, setB) {
        let _difference = new Set(setA)
        for (let elem of setB) {
            _difference.delete(elem)
        }
        return _difference;
    }
};
{% include 'js/jarvis_ext_utils.js' %}

$(document).ready(function() {
    jarvis.load();
})
</script>
</body>
</html>