
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Pairwise Meta-Analysis</title>

<link rel="shortcut icon" href="./favicon.ico">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />

<style>
{% include 'css/box.css' %}
.d-flex {
    display: flex;
}
.fx-row {
    flex-direction: row;
}
.fx-col {
    flex-direction: column;
}
.fx-jc-space-between {
    justify-content: space-between;
}
/* the label values items */
.bbi-label {
    width: 100%;
    padding: 0 0 3px 0;
    font-size: .8em;
    color: #666666;
    /* just for using the question marks */
    justify-content: space-between;
}
.bbi-value {
    width: calc(100% - 10px);
    padding: 2px 0px 2px 10px;
    font-size: .9em;
    color: #000000;
}
.bbi-label-hint {
    color: #999999;
    cursor: help;
}
.bbi-label-hint:hover {
    color: #333333;
}
.box-body h5 {
    padding: 0;
    margin: 0;
    font-size: 1em;
    height: 1.6em;
    line-height: 1.6em;
    margin: 3px 0;
}
.box-p {
    width: 100%;
    padding: 0;
    margin: 0;
    font-size: .9em;
}
.box-p-fixlen {    
    white-space: nowrap;
    text-overflow:ellipsis;
    overflow: hidden;
}
.box-footer {
    width: 100%;
    min-height: 20px;
    padding: 5px 0 5px 0;
}
/* font sizes */
.txt-sm {
    font-size: 0.9em;
}
.txt-nm {
    font-size: 1em;
}
.txt-lg {
    font-size: 1.3em;
}
.txt-xl {
    font-size: 1.6em;
}
/* font bold */
.txt-fb {
    font-weight: bold;
}
.box-header h4 {
    margin: 2px 0;
}
.select-sm {
    width: 80px;
}
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
a {
    color: #333333;
    text-decoration: none;
}
#wrapper {
    display: flex;
    flex-direction: column;
    width: 100%;
    height: 100%;
}
#start-screen {
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}

/* for this page */
#app {
    width: 100%;
    height: calc(100% - 42px);
}
#app_oclist {
    width: 320px;
    padding: 0 5px;
    height: calc(100% - 15px);
    /* height: 810px; */
    /* background-color: whitesmoke; */
}
#app_oclist_aespanel {
    width: 100%;
    height: 100%;
    overflow-x: hidden;
    overflow-y: auto;
}
#vw_ocplots_mainpanel {
    width: calc(100% - 320px);
    padding: 0 5px;
    height: 100%;
}
#vw_ocplots_plotpanel {
    height: 100%;
    overflow-y: hidden;
}
.oc-group {
    cursor: pointer;
    padding: 3px 0;
    text-align: left;
    /* text-transform: uppercase; */
    background-color: #f3f3f3;
    border-top: 1px solid #cccccc;
}
.oc-name {
    width:     200px;
    min-width: 200px;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type {
    width: 30px;
    min-width: 30px;
    text-align: center;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type:hover {
    background-color: #cccccc;
    font-weight: bold;
}
.oc-type-selected {
    background-color: #555555;
    color: #ffffff;
    font-weight: bold;
}
.oc-cate {
    flex-direction: column;
}
.oc-cate-info {
    width: 100%;
    /* border-top: 1px solid #dddddd; */
    padding: 2px 0;
    border-bottom: 1px solid transparent;
}
.oc-cate-info:hover {
    border-bottom: 1px solid #555555;
}
.oc-cate-info .oc-name {
    font-weight: bold;
}
.oc-cate-info .oc-type {
    font-weight: bold;
}
.oc-items {
    width: 100%;
    padding-left: 20px;
}
.oc-items-hide {
    display: none;
}
.oc-item {
    width: 100%;
    border-left: 1px solid #aaaaaa;
}
.oc-item-info {
    width: calc(100% - 20px);
    border-bottom: 1px solid transparent;
}
.oc-item-info:hover {
    background-color: #efefef;
    border-bottom: 1px solid #cccccc;
}
.oc-item-info .oc-name {
    width:       170px;
    min-width:   170px;
    padding-left: 10px;
}
.oc-plot-img {
    width: 100%;
}
.oc-plot-tab {
    padding: 4px 15px;
    border: 0;
    color: #999999;
    border-bottom: 1px solid #999999;
    cursor: pointer;
}
.oc-plot-tab:hover {
    color: #555555;
    border-bottom: 1px solid #555555;
}
.oc-plot-tab-selected {
    color: #000000;
    font-weight: bold;
    border-bottom: 1px solid #000000;
}
.oc-plot-tab-page {
    display: none;
    padding: 10px 10px 0 15px;
    overflow-y: auto;
}
.oc-plot-tab-page-selected {
    display: block;
    overflow-y: auto;
}

.sfilter {
    margin-right: 15px;
}
.sfilter-name {
    font-size: 1.1em;
    padding: 2px 0;
}
.sfilter-select {
    width: 100%;
}
#app_filter {
    padding: 5px 0 0 5px;
}
#fig_scatter {
    width: 500px; 
    height: 500px;
}
#fig_sunburst {
    width: 600px; 
    height: 600px;
}
.fig-tooltip-header {
    border-bottom: 1px solid rgba(255,255,255,.3); 
    font-size: 1.2em;
    padding-bottom: 7px;
    margin-bottom: 7px;
}
.d-flex {
    display: flex;
}
.flex-row {
    flex-direction: row;
}
.flex-wrap {
    flex-wrap: wrap;
}
.flex-col {
    flex-direction: column;
}
.flex-align-items-baseline {
    align-items: baseline;
}
.flex-align-items-center {
    align-items: center;
}
#plot_nav {
    /* margin-top: -15px; */
    display: flex;
    flex-direction: row;
}
.plot-nav {
    padding: 3px 10px;
    color: #777777;
    border-bottom: 1px solid #333;
}
.plot-nav-active {
    border: 1px solid #333;
    color: #000000 !important;
    border-bottom: 0 !important;
    font-weight: bold;
}
#plot_main {
    padding: 5px;
    /* border-bottom: 1px solid #dfdfdf; */
}
#fig_sunburst {

}
#fig_sunburst_legend {
    position: relative;
    z-index: 10;
}
#fig_sunburst_legend img {
    position: absolute;
    top: 5px;
    left: 5px;
    width: 160px;
}
.fig-legend {
    opacity: 0.5;
}
.fig-legend:hover {
    opacity: 1;
}

.fh-g {

}
.fh-g-name {

}
.fh-c {
    padding: 2px;
    margin: 2px;
    /* border-right: 1px dotted #efefef; */
    /* border-bottom: 1px dotted #efefef; */
    border: 1px dotted #efefef;
}
.fh-c-5 {
    width: 90px;
}
.fh-c-8 {
    width: 145px;
}
.fh-c-10 {
    width: 190px;
}
.fh-c:hover {
    border-color: #777777;
}
.fh-c-name {
    font-size: 0.85em;
    padding: 1px 0;
    margin: 0 0 2px 0;
}
.fh-o {
    width: 10px;
    height: 10px;
    padding: 2px;
    margin: 1px;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
    font-size: 0.7em;
    color: #999999;
    border: 1px solid #efefef;
}
.fh-o:hover {
    border-color: #777777;
}
#app_comptb {
    min-height: 800px;
    height: 99%;
    min-width: 1000px;
    padding: 0 5px;
}
.cmp-tb {

}
.cmp-tb-row {
    display: flex;
    flex-direction: row;
}
.cmp-tb-row:hover{
    background-color: whitesmoke;
}
.cmp-tb-row-header {
    position: sticky;
    top: 0;
    background-color: white;
    z-index: 99;
}
.cmp-tb-cell {
    width: 50px;
    min-width: 50px;

    height: 24px;
    min-height: 24px;
    display: flex;
    justify-content: center;
    /* align-self: center;    <---- REMOVE */
    align-items: center;   /* <---- NEW    */
    padding: 3px 0;
    border-bottom: 1px solid #dfdfdf;
}
.cmp-tb-cell-header {
    font-weight: bold;
    border-bottom: 1px solid #777777;
    padding: 4px 0;
}
.cmp-tb-cell-header-sortable {
    cursor: pointer;
}
.cmp-tb-cell-footer {
    font-weight: bold;
    /* border-top: 1px solid #777777; */
    padding: 4px 0;
}
.cmp-tb-cell-xs {
    width: 20px !important;
    min-width: 20px !important;
}
.cmp-tb-cell-sm {
    width: 50px !important;
    min-width: 50px !important;
}
.cmp-tb-cell-ocname {
    width: 160px !important;
    min-width: 160px !important;
}
.cmp-tb-cell-ocname-item {
    cursor: pointer;
}
.cmp-tb-cell-smtxt {
    font-size: 0.95em;
    list-style: 0.8em;
}
.cmp-tb-cell-sep {
    width: 45px !important;
    min-width: 45px !important;
}
.cmp-tb-cell-category {
    width: 120px !important;
    min-width: 120px !important;
}
.cmp-tb-cell-treatment {
    width: 140px !important;
    min-width: 140px !important;
}
.cmp-tb-cell-effect-lg {
    min-width: 360px !important;
    width: 360px !important;
    /* display: block !important; */
    position: relative;
    text-align: center;
}
.cmp-tb-cell-effect {
    min-width: 120px !important;
    width: 120px !important;
    /* display: block !important; */
    position: relative;
    text-align: center;
}
.cmp-tb-cell-eft {
    display: block !important;
    text-align: center;
}
.cmp-filters {
    width: 100%;
    font-style: italic;
    font-size: .85em;
}
.cmp-occate {
    width: 100%;
    white-space: nowrap;
    text-overflow: ellipsis;
    overflow: hidden;
}
.cmp-ocname {
    width: 100%;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
}
.cmp-eft-ci-line {
    height: 1px;
    position: absolute;
    top: 14px;
    border-bottom: 1px solid #333333;
}
.cmp-eft-dot {
    width: 7px;
    height: 7px;
    top: 12px;
    position: absolute;
    /* opacity: 0.8; */
}
.cmp-eft-value {
    font-size: .8em;
    color: #555555;
    margin-top: 0.5em;
    /* margin-left: 1em; */
    /* position: absolute; */
    /* left: 0; */
    width: 88px;
}
.cmp-tb-cell-effect .cmp-ref-one {
    position: absolute;
    left: 59px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}
.cmp-tb-cell-effect-lg .cmp-ref-one {
    position: absolute;
    left: 179px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}

.cmp-ref-50 {
    position: absolute;
    left: 60px;
    top: 0;
    height: 100%;
    border-right: 1px dotted #aaaaaa;
}

.btn {
    padding: 3px 5px;
    text-decoration: none !important;
}
.btn:hover {
    background-color: #cacaca;
}
.btn-remove {
    color: #ffdcdc;
}
.btn-remove:hover {
    color: white;
    background-color: rgb(255, 70, 70);
}
.btn-add-ocs {
    color: #888888;
}
.btn-add-ocs:hover {
    color: #333333;
    background-color: #cccccc;
}
#app_sclist {
    width: 600px;
}
.sc-item-panel {
    margin-top: 5px;
    height: 150px;
    overflow-x: hidden;
    overflow-y: auto;
}
.sc-item-box {
    position: relative;
}
.sc-item {
    margin: 5px 5px 0 0;
    padding: 1px;
    height: 130px;
    border-bottom: 1px solid #efefef;
}
.sc-item:hover {
    cursor: pointer;
    background-color: whitesmoke;
}
.sc-img {
    height: 110px;
}
.sc-close {
    position: absolute;
    top: 0;
    right: 0;
}
.sc-info {
    width: 100%;
    text-align: center;
    font-size: .8em;
    font-style: italic;
    white-space: nowrap;
    text-overflow: clip;
    overflow: hidden;
}
.forest-plot-panel {
    height: 100%;
    overflow-y: auto;
}
.hide {
    display: none;
}
.badge {
    padding: 1px 4px;
    background-color: #eeeeee;
    border-radius: 4px;
}
.badge-t, 
.badge-treatment {
    background-color: #EBF8FF;
}
.badge-i,
.badge-immune {
    background-color: #F4EBFF;
}

.ml-1 {
    margin-left: 1em;
}
.ml-2 {
    margin-left: 2em;
}
.ml-3 {
    margin-left: 3em;
}
.mr-1 {
    margin-right: 1em;
}
.mr-2 {
    margin-right: 2em;
}
.mr-3 {
    margin-right: 3em;
}
</style>
</head>

<body>
    
<div id="start-screen">
    <h1>
        <i class="fa fa-chart-bar"></i>
        Pairwise Meta-Analysis for IO Toxicity
    </h1>
    <div id="ss-msg">Loading data and initializing ...</div>
</div>


<div id="app_pma">

    <div id="app_filter" class="d-flex flex-row">
        <div class="sfilter d-flex fx-col mr-1">
            <div class="sfilter-name">&nbsp;</div>
            <div style="font-size: 14px; font-weight: bold;">
                Filters: 
            </div>
        </div>
    
        <div v-for="dropdown, dpd_idx in dropdowns"
            class="sfilter d-flex fx-col mr-3">
            <div class="sfilter-name">
                {{ dropdown.display_name }}
            </div>
            <div>
                <select class="sfilter-select"
                    v-bind:value="dropdown.value"
                    v-bind:disabled="is_filter_disabled(dpd_idx)"
                    v-on:change="on_filter_value_change($event, dpd_idx)">
                    <option v-for="opt in dropdown.options" 
                        v-bind:value="opt.value">
                        {{ opt.name }}
                    </option>
                </select>
            </div>
        </div>
    
        <div class="d-flex fx-col mr-3">
            <div class="sfilter-name">
                Number of studies
            </div>
            <div style="height: 20px; line-height: 20px;">
                {{ n_papers }}
            </div>
        </div>
    </div>

</div>
<!-- /#wrapper -->

<!-- use third party libs -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>

<!-- D3.js -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.15.1/d3.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3-tip/0.9.1/d3-tip.min.js"></script>

<!-- load the scripts for meta analysis -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/10.1.1/math.min.js"></script>
<script src="https://ohnlp.github.io/Meta.js/dist/metajs-0.0.3.js"></script>

<!-- for data exploration -->
<script src="https://cdn.jsdelivr.net/npm/danfojs@1.1.0/lib/bundle.js"></script>

<!-- for visualization -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/echarts/5.3.2/echarts.min.js"></script>

<!-- PapaParse for export -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.1/papaparse.min.js"></script>

<!-- filesaver -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.0/FileSaver.min.js"></script>


<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<script>

{% include 'js/srv_pubmed.js' %}
{% include 'js/srv_rpltapi.js' %}


///////////////////////////////////////////////////////////
// The plots for PWMA
///////////////////////////////////////////////////////////
{% include 'js/fgmk_pwma_forest_for_metajs.js' %}
{% include 'js/fgmk_incd_forest.js' %}
{% include 'js/fgmk_cumu_forest.js' %}


var app_pma = {
    // bind the Vue.js object
    vpp: null,
    vpp_id: '#app_pma',

    // the default attrs for filters
    attrs: [{
        display_name: 'ICI Class (Rx)',
        name: 'Class of ICI',
        values: [
            'PD1',
            'PD-L1',
            'CTLA-4'
        ]
    }, {
        display_name: 'ICI Name (Rx)',
        name: 'Name of ICI',
        values: [
            'Atezolizumab',
            'Avelumab',
            'Cemiplimab',
            'Durvalumab',
            'Ipilimumab',
            'Nivolumab',
            'Pembrolizumab',
            'Tremelimumab'
        ]
    }, {
        display_name: 'Type of Therapy (Rx)',
        name: 'Monotherapy/combination',
        values: [
            'Combination',
            'Monotherapy'
        ]
    }, {
        display_name: 'Type of combination (Rx)',
        name: 'Type of combination',
        values: [
            'ICI+ICI',
            'ICI+Chemo',
            'ICI+TKI',
            'ICI+MEKi',
            'ICI+Anti-VEGF',
            'ICI+RadiatICIn',
            'ICI+Vaccine',
            'ICI+BRAFi+MEKi',
            'ICI+Chemo+Anti-VEGF',
            'ICI+ICI+Chemo',
        ]
    }, {
        display_name: 'Control Arm',
        name: 'Type of control',
        values: [
            'Chemo',
            'TKI',
            'Interferon',
            'Multikinase inhibitor',
            'mTOR inhibitor',
            'Radiation',
            'Vaccine',
            'Placebo',
            'Chemo/Anti-EGFR',
            'Chemo+Anti-VEGF',
            'Chemo/TKI',
            'BRAFi+MEKi',
            'Best supportive care'
        ]
    }, {
        display_name: 'Cancer Type',
        name: 'Cancer type',
        values: [
            'Bladder',
            'Breast',
            'Colorectal',
            'Esophageal/GEJ',
            'Gastric/GEJ',
            'Head and Neck ',
            'Hepatocellular',
            'Melanoma',
            'Mesothelioma',
            'Multiple Myeloma',
            'Non-Small Cell Lung',
            'Pancreatic',
            'Prostate',
            'Renal cell',
            'Small Cell Lung',
            'Urothelial'
        ]
    }],


    vpp_data: {

        dropdowns: [],
        n_papers: 0
    },

    vpp_methods: {
        ///////////////////////////////////////////////////////////
        // for filters
        ///////////////////////////////////////////////////////////

        is_filter_disabled: function(idx) {
            if (idx == 0) {
                return false;
            } else {
                if (idx == 1 || idx == 2 || idx == 5) {
                    
                    if (this.dropdowns[idx-1].value == '%') {
                        return true;
                    } else {
                        return false;
                    }
                }

                // for the Type of combination
                // this dropdown depends on the value of previous
                if (idx == 3) {
                    if (this.dropdowns[2].value.toLocaleLowerCase() == 'combination') {
                        return false;
                    } else {
                        return true;
                    }
                }

                // for the next, it depends on the m/c value
                // and also the choose of type of comb
                if (idx == 4) {
                    if (this.dropdowns[2].value == '%') {
                        return true;
                    } else if ( this.dropdowns[2].value == 'all' ||
                        this.dropdowns[2].value.toLocaleLowerCase() == 'monotherapy') {
                        return false;  
                    } else {
                        // depends on the value of 
                        if (this.dropdowns[3].value == '%') {
                            return true;
                        } else {
                            return false;
                        }
                    }
                }
            }
        },

        on_filter_value_change: function(event, idx) {
            var new_val = event.target.value;
            this.set_filter_value_at(new_val, idx, true);
        },

        get_current_filter_values: function() {
            var vals = [];
            for (let i = 0; i < this.dropdowns.length; i++) {
                var val = this.dropdowns[i].value;
                vals.push(val);
            }
            return vals;
        },

        set_filter_value_at: function(new_val, idx, update_related_views) {
            if (typeof(update_related_views) == 'undefined') {
                update_related_views = false;
            }

            this.dropdowns[idx].value = new_val;

            // update the affected
            if (idx < this.dropdowns.length - 1) {
                // now, reset all of the following options
                for (let i = idx + 1; i < this.dropdowns.length; i++) {
                    // reset the value
                    this.dropdowns[i].value = '%';
                    // reset the options
                    this.dropdowns[i].options = this.get_filter_options(i, true);
                }
                
                if (new_val != '%') {
                    // now, update the options of the next dropdown
                    var next = 1;
                    if (idx == 2 &&
                        new_val.toLocaleLowerCase() == 'all') {
                        next = 2;
                    }
                    if (idx == 2 &&
                        new_val.toLocaleLowerCase() == 'monotherapy') {
                        next = 2;
                    }
                    
                    var next_options = this.get_filter_options(idx + next);
                    // console.log(next_options);
                    this.dropdowns[idx + next].options = next_options;
                }
            }

            // now need to get the pmids
            // so, first, get the current values of all dropdowns
            var conditions = [];
            for (let i = 0; i < this.dropdowns.length; i++) {
                const dropdown = this.dropdowns[i];
                var name_i = dropdown.name;
                var val_i = dropdown.value;
                if (val_i == '%' || val_i == 'all') {
                    // skip the default
                    // but we still need a condition, so this one
                    conditions.push(
                        '1=1'
                    );
                } else {
                    conditions.push(
                        '`' + name_i + '` like "%' + val_i + '%"'
                    );
                }
            }
            // second, use the conditions to search for the 
            var pmids = this.get_pmids_by_filter_conditions(conditions);
            this.n_papers = pmids.length;
            // finally, update the filter UI
            this.$forceUpdate();

            if (update_related_views) {
                // console.log('* filtered studies:', pmids);

                // send these pmids to the oclist
                // jarvis.update_plots_by_pmids(pmids);

            }
        },

        set_filter_values: function(vals) {
            for (let i = 0; i < vals.length; i++) {
                const val = vals[i];
                
                // set all values
                if (i == (vals.length - 1)) {
                    // update the last one
                    this.set_filter_value_at(val, i, true);
                } else {
                    this.set_filter_value_at(val, i, false);
                }
            }
        },

        get_pmids_by_filter_conditions: function(conditions) {
            var sql_conds = conditions.join(' and \n');
            var sql = "select PMID from papers " + '\n' +
                "where " + sql_conds + '\n';
            
            var rs = alasql(sql);
            
            var pmids = [];
            for (let i = 0; i < rs.length; i++) {
                const r = rs[i];
                // make sure the PMID is a string
                pmids.push(""+r.PMID);
            }

            return pmids;
        },

        get_filter_options: function(idx, skip) {
            if (typeof(skip) == 'undefined') {
                // use this option to skip checking, just return the default options
                skip = false;
            }
            var options = [{
                name: '',
                value: '%'
            }, {
                name: 'All',
                value: 'all'
            }];
            var name_idx = app_pma.attrs[idx].name;
            var vals_idx = app_pma.attrs[idx].values;

            if (idx == 0) {
                for (let i = 0; i < app_pma.attrs[idx].values.length; i++) {
                    const val = app_pma.attrs[idx].values[i];
                    options.push({
                        name: val,
                        value: val
                    })
                }
            } else {
                if (skip) {
                    return options;
                }
                // for all other dropdown, the option is decided by ALL of the selections
                // of dependencies for example:
                // for the 2nd dropdown, the options are decided by the 1st selection
                // for the 3rd dropdown, the options are decided by the selections of the 1st and 2nd.
                // for the 4th, by 1st, 2nd, and 3rd
                // etc.
                // So, first, need to generate the condition by all previous 
                var conditions = [];
                for (let j = 0; j < idx; j++) {
                    var name_j = this.dropdowns[j].name;
                    var val_j = this.dropdowns[j].value;

                    if (val_j == this.blank_val || val_j == 'all') {
                        // skip the blank dropdown
                        // but we still need a condition, so this one
                        conditions.push(
                            '1=1'
                        );
                    } else {
                        conditions.push(
                            '`' + name_j + '` like "%' + val_j + '%"'
                        );
                    }
                }
                var sql_cond = conditions.join(' and \n');

                // then, use these conditions to query the itable data to get the available records
                var sql = "select `" + name_idx + '` as attr, count(PMID) as cnt ' + '\n' +
                    'from papers ' + '\n' +
                    'where ' + sql_cond + '\n' +
                    'group by `' + name_idx + '` ';

                console.log(sql);
                var rs = alasql(sql);
                console.log(rs);

                // last, check each value whether available in the rs
                for (let i = 0; i < app_pma.attrs[idx].values.length; i++) {
                    const val = app_pma.attrs[idx].values[i];
                    var val_upper = val.toLocaleUpperCase();

                    // check whether this val in rs or not
                    for (let j = 0; j < rs.length; j++) {
                        const r = rs[j];

                        if (typeof(r.attr) == 'undefined' ||
                            r.attr == null) {
                            continue;
                        }
                        
                        var R_VAL = r.attr.toLocaleUpperCase();
                        
                        if (R_VAL.lastIndexOf(val_upper)>=0) {
                            // which means this value exists in the selection
                            // Then we could put this val in the result
                            options.push({
                                name: val,
                                value: val
                            });
                            
                            // since we already found this value
                            // just break and check next value
                            break;

                        } else {
                            
                        }
                    }
                }
            }

            return options;
        },

        cmp_val: function(a, b) {
            if (a == b) {
                return true;

            } else if (a == '%') {
                if (b == 'all') {
                    return true;
                }
            } else if (a == 'all') {
                if (b == '%') {
                    return true;
                }
            }

            return false;
        },

        cmp_vals: function(va, vb) {
            for (let i = 0; i < va.length; i++) {
                const a = va[i];
                const b = vb[i];
                if (this.cmp_val(a, b)) {
                    // ok
                } else {
                    return false;
                }
            }
            return true;
        },


        ///////////////////////////////////////////////////////////
        // app-level functions
        ///////////////////////////////////////////////////////////
        add_oc: function(oc_group, oc_cate, oc_name, oc_abbr, ae_grade, pids) {
            // console.log('* add_oc ' + oc_group + ' | ' + oc_cate + ' | ' +oc_abbr+' , ' + oc_name + ', ' + ae_grade, pids);
            // vw_ocplot.show_plot(group, oc_cate, oc_name, ae_grade, pids);

            // first, get the filter values
            var f_vals = this.get_current_filter_values();

            // second, get the raw data and the ma rst
            var ma = app_oclist.ma_dict[oc_abbr][ae_grade];

            // then, create a f_oc and push to cmp
            var f_oc = {
                // basic info
                oc_group: oc_group,
                oc_abbr: oc_abbr,
                oc_cate: oc_cate,
                oc_name: oc_name,
                ae_grade: ae_grade,

                // filters
                f_vals: f_vals,
                
                // pids
                pids: pids,

                // PWMA
                ma: ma
            };

            var ret = app_comptb.vpp.add_f_oc(f_oc);
            if (ret) {
                // ok, added
                console.log('* added f_oc: ', f_oc);
                return 1;
            } else {
                // no this is a duplicated
                console.log('* skipped adding f_oc:', f_oc);
                return 0;
            }
        },
    },

    init: function(data_itable, data_pma) {
        // just init the dropdown
        this.vpp_data.dropdowns = this.init_filter_dropdowns();

        // init the app
        this.vpp = new Vue({
            el: this.vpp_id,
            data: this.vpp_data,
            methods: this.vpp_methods
        });
    },

    init_filter_dropdowns: function() {
        var dropdowns = [];
        for (let i = 0; i < app_pma.attrs.length; i++) {
            const attr = app_pma.attrs[i];
            dropdowns.push({
                display_name: attr.display_name,
                name: attr.name,
                value: '%',
                options: this.vpp_methods.get_filter_options(i, true)
            });
        }
        return dropdowns;
    }

};



var jarvis = {
    color: {
        group: {
            treatment: '#5CC8FF',
            immune: '#DEC1FF'
        },
        cate_by_group: {
            treatment: '#EBF8FF',
            immune: '#F4EBFF'
        },
        bene: {
            sig: '#0cab0c',
            not: '#c7ffc7'
        },
        harm: {
            sig: '#ff3a3a',
            not: '#ffe0e5'
        }
    },

    get_color: function(SM, SM_lower, SM_upper) {
        if (SM < 1) {
            if (SM_upper < 1) {
                return this.color.bene.sig;
            } else {
                return this.color.bene.not;
            }
        } else{

            if (SM_lower > 1) {
                return this.color.harm.sig;
            } else {
                return this.color.harm.not;
            }
        }
    },

    texts: {
        "GA": "All Grade",
        "G34": "Grade 3/4",
        "G3H": "Grade 3 or higher",
        "G5N": "Grade 5 only"
    },

    capitalize: function(s) {
        return s.charAt(0).toUpperCase() + s.slice(1);
    },
    
    init: function() {
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // OK, 
        var prj = jarvis.get_url_paramter('prj');
        if (prj == null) {
            jarvis.ssmsg('Project information error.')
            return;
        }

        prj = 'IO';

        var src = jarvis.get_url_paramter('src');
        if (src == null || src == '') {
            src = 'cache';
        }

        var cq = jarvis.get_url_paramter('cq');
        if (cq == '') {
            cq = 'default';
        }

        // load all data
        $.when(
            $.get(
                '/pub/graphdata/' + prj + '/ITABLE.json',
                {rnd: Math.random(), src: src, cq: cq}
            ),
            $.get(
                '/pub/graphdata/'+prj+'/GRAPH_PMA.json',
                {ver: Math.random(), src: src, cq: cq},
            )
        ).done(function(r1, r2) {
            var data1 = r1[0];
            var data2 = r2[0];

            jarvis.data1 = data1;
            jarvis.data2 = data2;

            // init the table
            console.log(data1);
            console.log(data2);

            // init the local db for the papers
            alasql('create table papers');
            alasql('select * into papers from ?', [data1.rs]);
            
            // init the local db for the outcome / AE records
            alasql('create table aes');
            alasql('select * into aes from ?', [data2.rs])

            // init the filter with ITABLE data
            app_pma.init(data1, data2);

            // ok, remove the 
            jarvis.ssmsg('Almost initialized.');
            setTimeout('jarvis.ssclose();', 400);

        });

        
    },

    update_plots_by_pmids: function(pmids) {
        app_oclist.update(pmids);
    },

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    clear_all_ae: function() {

    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    tf2: function(v) {
        if (isNaN(v)) {
            return 'NA';
        } 
        return v.toFixed(2);
    },

    set_mode: function(mode) {
        if (typeof(mode) == 'undefined') {
            mode = 0;
        }
        if (mode == 0) {
            this.set_mode(1);
            this.set_mode(3);
        }
        if (mode == 1) {
            $('#app_comptb_box').height('calc(50% - 20px)');
            $('#app_detail_box').height('calc(50% - 20px)');
        }
        if (mode == 2) {
            $('#app_comptb_box').height('calc(100% - 150px)');
            $('#app_detail_box').height('20px');
        }
        if (mode == 3) {
            $('#show_overview').hide();
            $('#vw_ocplot').show();
            $('#app_comptb').width('auto');
        }
        if (mode == 4) {
            $('#vw_ocplot').hide();
            $('#show_overview').show();
            $('#app_comptb').width('calc(100% - 300px)');
        }
    }
};

$(document).ready(function() {
    jarvis.init();
});
</script>

</body>
</html>