{% extends '_layout_adminlte.html' %}

{% block title %}
Project Editor
{% endblock %}

{% block style %}
{% endblock %}

{% block page_name %}
<i class="far fa-clipboard"></i>
Project Editor
{% endblock %}

{% block content %}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div class="col">
                <ul class="nav nav-tabs" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link active"
                            id="basic_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#basic_info_panel"
                            aria-controls="basic_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-credit-card"></i>
                            Basic Information
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                            id="ie_criteria_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#ie_criteria_info_panel"
                            aria-controls="ie_criteria_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-align-left"></i>
                            Inclusion / Exclusion Criteria
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" 
                            id="ie_keywords_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#ie_keywords_info_panel"
                            aria-controls="ie_keywords_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-highlighter"></i>
                            Inclusion / Exclusion Keywords
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            id="ex_reason_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#ex_reason_info_panel"
                            aria-controls="ex_reason_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-paragraph"></i>
                            Exclusion Reasons
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link"
                            id="tag_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#tag_info_panel"
                            aria-controls="tag_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-tags"></i>
                            Tags
                        </a>
                    </li>

                    <li class="nav-item">
                        <a class="nav-link"
                            id="pdf_keywords_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#pdf_keywords_panel"
                            aria-controls="pdf_keywords_panel" 
                            aria-selected="true">
                            <i class="fa fa-highlighter"></i>
                            PDF Highlights
                        </a>
                    </li>

                    <!-- <li class="nav-item">
                        <a class="nav-link"
                            id="prisma_info_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#prisma_info_panel"
                            aria-controls="prisma_info_panel" 
                            aria-selected="true">
                            <i class="fa fa-project-diagram"></i>
                            PRISMA
                        </a>
                    </li> -->

                    <li class="nav-item">
                        <a class="nav-link"
                            id="advanced_mode_tab"
                            data-toggle="tab"
                            role="tab" 
                            href="#advanced_mode_panel"
                            aria-controls="advanced_mode_panel" 
                            aria-selected="true">
                            <i class="fa fa-code"></i>
                            ADVANCED MODE
                        </a>
                    </li>
                </ul>
            </div>
        </div>

        <div class="row">
            <div class="col tab-content" id="myTabContent">

                <div class="tab-pane fade show active" id="basic_info_panel" role="tabpanel" aria-labelledby="basic_info_tab">
                    
                    <p class="lead">Project basic information</p>
                    <div>
                        <div class="form-group">
                            <label for="input_title">Project Title</label>
                            <input type="text" class="form-control" id="input_title" name="title" value="[[ project.title ]]">
                            <small id="input_title_help" class="form-text text-muted">
                                The project title must be at least 8 characters long, contain letters and numbers, no special characters.
                            </small>
                        </div>

                        <div class="form-group">
                            <label for="input_keystr">Short Identifier</label>
                            <input type="text" class="form-control" id="input_keystr" name="title" value="[[ project.keystr ]]" disabled>
                            <small id="input_keystr_help" class="form-text text-muted">
                                The project short identifier is used for checking updates in email or other data sources. It must be at least 3 characters long, contain upper case letters and numbers
                            </small>
                        </div>
                    
                        <div class="form-group">
                            <label for="input_query">Query</label>
                            <textarea class="form-control" id="input_query" name="query" rows="2"></textarea>
                            <small id="input_query_help" class="form-text text-muted">
                                The query for automatic search in PubMed
                            </small>
                        </div>
                    
                        <div class="form-group">
                            <label for="input_abstract">Project Abstract (Optional)</label>
                            <textarea class="form-control" id="input_abstract" name="abstract" rows="3"></textarea>
                            <small id="input_abstract_help" class="form-text text-muted">
                                Describe this project.
                            </small>
                        </div>
                    
                        <button type="submit" class="btn btn-primary">
                            <i class="far fa-save"></i>
                            Save basic information
                        </button>
                    </div>


                </div>
                <!-- /#basic_info_panel -->
                

                <div class="tab-pane fade" id="ie_criteria_info_panel" role="tabpanel" aria-labelledby="ie_criteria_info_tab">
                    <p class="lead">The inclusion / exclusion criteria</p>

                    <p>
                        The inclusion / exclusion criteria will be displayed as a floating window to help user check the criterias.
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_criterias') ]]">
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="form_textarea_inclusion_criterias">Inclusion Criteria</label>
                                    <textarea class="form-control"
                                        style="background: rgb(223, 245, 223);"
                                        id="form_textarea_inclusion_criterias" 
                                        name="form_textarea_inclusion_criterias" 
                                        rows="15">[[ form_textarea_inclusion_criterias ]]</textarea>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="form_textarea_exclusion_criterias">Exclusion Criteria</label>
                                    <textarea class="form-control"  
                                        style="background: rgb(255, 205, 205);"
                                        id="form_textarea_exclusion_criterias" 
                                        name="form_textarea_exclusion_criterias" 
                                        rows="15">[[ form_textarea_exclusion_criterias ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save inclusion and exclusion criterias
                        </button>
                    </form>

                </div>
                <!-- /#ie_criteria_info_panel -->
                

                <div class="tab-pane fade" id="ie_keywords_info_panel" role="tabpanel" aria-labelledby="ie_keywords_info_tab">
                    <p class="lead">The inclusion / exclusion keywords</p>
                    <p>
                        The inclusion keywords will be highlighted as <b style="color: rgb(1, 56, 1); background: rgb(223, 245, 223); padding: 1px 8px;">green</b> in title and abstract. <br>
                        The exclusion keywords will be highlighted as <b style="color: rgb(250, 89, 89); background: rgb(255, 205, 205); padding: 1px 8px;">red</b> in title and abstract.<br>
                        One keyword per line. 
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_highlight_keywords') ]]">
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="form_textarea_inclusion_keywords">Inclusion keywords</label>
                                    <textarea class="form-control"
                                        style="color: rgb(1, 56, 1); background: rgb(223, 245, 223);"
                                        id="form_textarea_inclusion_keywords" 
                                        name="form_textarea_inclusion_keywords" 
                                        rows="15">[[ form_textarea_inclusion_keywords ]]</textarea>
                                </div>
                            </div>
                            <div class="col-3">
                                <div class="form-group">
                                    <label for="form_textarea_exclusion_keywords">Exclusion keywords</label>
                                    <textarea class="form-control"  
                                        style="color: rgb(250, 89, 89); background: rgb(255, 205, 205);"
                                        id="form_textarea_exclusion_keywords" 
                                        name="form_textarea_exclusion_keywords" 
                                        rows="15">[[ form_textarea_exclusion_keywords ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save inclusion and exclusion keywords
                        </button>
                    </form>

                </div>
                <!-- /#ie_criteria_info_panel -->
                

                <div class="tab-pane fade" id="ex_reason_info_panel" role="tabpanel" aria-labelledby="ex_reason_info_tab">
                    <p class="lead">The full text exclusion reasons</p>
                    <p>
                        The full text exclusion reasons will be used in the full text review stage.<br>
                        One reason per line. 
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_exclusion_reasons') ]]">
                        <div class="row">
                            <div class="col-lg-3 col-md-4 col-sm-10">
                                <div class="form-group">
                                    <label for="form_textarea_inclusion_keywords">Full text exclusion reasons</label>
                                    <textarea class="form-control"
                                        id="form_textarea_exclusion_reasons" 
                                        name="form_textarea_exclusion_reasons" 
                                        rows="15">[[ form_textarea_exclusion_reasons ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save exclusion reasons
                        </button>
                    </form>
                </div>
                <!-- /#ie_criteria_info_panel -->


                <div class="tab-pane fade" id="tag_info_panel" role="tabpanel" aria-labelledby="tag_info_tab">

                    <p class="lead">The tags</p>
                    <p>
                        The tags will be used to label studies in the screener. 
                        In the following text box, input the tags for this project.
                        <br>
                        One tag per line. 
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_tags') ]]">
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <textarea class="form-control"  
                                        id="form_textarea_tags" 
                                        name="form_textarea_tags" 
                                        rows="15">[[ form_textarea_tags ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save tags
                        </button>
                    </form>

                </div>
                <!-- /#tag_info_panel -->


                <div class="tab-pane fade" id="pdf_keywords_panel" role="tabpanel" aria-labelledby="tag_info_tab">

                    <p class="lead">PDF Highlight Keywords</p>
                    <p>
                        The following keywords will be highlighted as <span style="background-color: gold;">YELLOW background color</span> in the PDF file during data extraction.<br>
                        ONE keyword per line
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_pdf_keywords') ]]">
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <textarea class="form-control"  
                                        id="form_textarea_pdf_keywords" 
                                        name="form_textarea_pdf_keywords" 
                                        rows="15">[[ form_textarea_pdf_keywords ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save those keywords
                        </button>
                    </form>

                </div>
                <!-- /#pdf_keywords_panel -->


                <div class="tab-pane fade" id="prisma_info_panel" role="tabpanel" aria-labelledby="tag_info_tab">

                    <p class="lead">The PRISMA</p>
                    <p>
                        The tags will be used to generate the PRISMA for public website.
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_tags') ]]">
                        <div class="row">
                            <div class="col-3">
                                <div class="form-group">
                                    <textarea class="form-control"  
                                        id="form_textarea_tags" 
                                        name="form_textarea_tags" 
                                        rows="15">[[ form_textarea_tags ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary">
                            <i class="fa fa-save"></i>
                            Save PRISMA settings
                        </button>
                    </form>

                </div>
                <!-- /#prisma_info_panel -->


                <div class="tab-pane fade" id="advanced_mode_panel" role="tabpanel" aria-labelledby="tag_info_tab">

                    <p class="lead">The Advanced Modeadvanced_mode_panel</p>
                    <p>
                        <b>DO NOT</b> edit anything below if you are not sure what would be affected.
                    </p>
                    <form method="POST" action="[[ url_for('project.api_set_settings') ]]"
                        onsubmit="return jarvis.on_submit_advanced_mode()">
                        <div class="row">
                            <div class="col-9">
                                <div class="form-group">
                                    <textarea class="form-control"  
                                        id="form_textarea_settings" 
                                        name="form_textarea_settings" 
                                        rows="15">[[ form_textarea_settings ]]</textarea>
                                </div>
                            </div>
                        </div>

                        <button type="submit" class="btn btn-primary"
                            onabort="">
                            <i class="fa fa-save"></i>
                            Save project settings
                        </button>
                    </form>

                </div>
                <!-- /#advanced_mode_panel -->
            </div>
        </div>
    </div>
</div>


{% endblock %}

{% block active_nav_link %}project-editor{% endblock %}

{% block script %}
<!-- Code Mirror -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.js"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.61.0/codemirror.min.css" />

<script>
var vw_prjeditor = {
    vpp: null,
    vpp_id: '#vw_prjeditor',
    api_url: {
        project: ''
    },

    load: function() {

    },

    init: function() {

    },
};

var myCodeMirror = null;

var vw_cmeditor = {
    init: function() {

    },

    resize: function() {
    }
};

var jarvis = {
    init: function() {
        // initialize the global editor
        var myTextArea = document.getElementById('form_textarea_settings');
        myCodeMirror = CodeMirror.fromTextArea(myTextArea, {
            lineWrapping: true,
            mode: 'javascript'
        });

        // switch tab
        // ^ means starting, meaning only match the first hash
        var hash = location.hash.replace(/^#/, '');
        if (hash) {
            $('#' + hash + '_tab').tab('show');
        } 

    },

    on_submit_advanced_mode: function() {
        // check the json format first
        try {
            JSON.parse(myCodeMirror.getValue());
        } catch (err) {
            console.log(err);
            toast('The settings are not a valid JSON text, please review.\n' + err, 'error');
            return false;
        }

        // final confirm
        var ret = confirm('Do you really want to submit the settings?');

        return ret;
    },

    is_valid_project_setting_json: function() {

    }
};

$(document).ready(function() {
    jarvis.init();
});

</script>
{% endblock %}