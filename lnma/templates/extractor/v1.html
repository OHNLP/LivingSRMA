{% extends '_layout_adminlte.html' %}

{% block title %}
Data Extractor v1
{% endblock %}

{% block style %}
<style>
html {
    overflow: hidden;
}
#navi_header {
    margin: 5px 5px 0 0;
    padding: 0 5px 0 10px;
}
#main {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: calc(100% - 100px);
    overflow: hidden;
}
.panel-s {
    width: 24%;
    margin: 5px 5px 0 0;
    padding: 0 5px 0 10px;
    border-right: 1px dotted #999999;
}
.panel-m {
    width: 49%;
    margin: 5px 5px 0 0;
    padding: 0 5px 0 10px;
    border-right: 1px dotted #999999;
}
.panel-l {
    width: 74%;
    margin: 5px 5px 0 0;
    padding: 0 5px 0 10px;
    border-right: 1px dotted #999999;
}
.panel-box {
    margin: 5px 0 15px 0;
    border-bottom: 1px dotted #cccccc;
    padding: 10px 0;
}
.panel-container {
    max-width: 100%;
    overflow-y: auto;
}
#pan_outcomes {
    height: 100%;
}
#pan_ocpapers {

}
#pan_collector {

}
#pan_analyzer {

}
.oc-attr {
    display: inline-block;
    margin: 0 10px 3px 0;
}
.oc-attr-name {
    background: #ececec;
    padding: 0 3px;
    border-bottom: 1px solid #ececec;
}
.oc-attr-value {
    width: auto;
    font-weight: bold;
    margin-left: -3px;
    padding: 0 3px;
    border: 0;
    border-bottom: 1px solid #ececec;
}
</style>
{% endblock %}

{% block page_name %}
<i class="far fa-edit"></i>
Data Extractor
{% endblock %}

{% block content %}
<link rel="stylesheet" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">

<div id="navi_header">
    <button onclick="jarvis.switch_layout('manage_outcomes');">
        <i class="fa fa-list"></i>
        Manage Outcomes
    </button>

    <button onclick="jarvis.switch_layout('extract_information');">
        <i class="fa fa-list"></i>
        Extract Information
    </button>

    <button onclick="jarvis.switch_layout('analyze_outcome');">
        <i class="fa fa-list"></i>
        Analyze Outcome
    </button>
</div>
<!-- /#navi_header -->

<div id="main">

    <div id="pan_outcomes" class="panel-m panel-container">

        <h5>
            Interactive Table
            <button class="btn-sm"
                v-on:click="create_itable_column()">
                <i class="fa fa-add"></i>
                Add Column
            </button>
        </h5>
        <div class="panel-box">

        </div>

        <h5>
            PWMA Outcomes
            <button class="btn-sm"
                v-on:click="create_extract('pma')">
                <i class="fa fa-add"></i>
                Add Outcome
            </button>
        </h5>
        <div class="panel-box">
            <div class="oper-bar">
                
            </div>
            <table class="table">
                <tr>
                    <th>Group</th>
                    <th>Full Name</th>
                    <th>Measure</th>
                    <th>Treatment</th>
                    <th>Control</th>
                    <th>&nbsp;</th>
                </tr>
                <tr v-for="oc in data.pma.outcomes">
                    <td>{{ oc.group }}</td>
                    <td>
                        <a href="javascript:void(0);"
                            v-on:click="show_extract_data(oc.oc_type, oc.abbr)">
                            {{ oc.full_name }}
                        </a>
                    </td>
                    <td>{{ oc.measure }}</td>
                    <td>{{ oc.treatment.full_name }}</td>
                    <td>{{ oc.control.full_name }}</td>
                    <td>
                        <a href="javascript:void(0);" class="text-danger">
                            <i class="far fa-trash-alt"></i>
                        </a>
                    </td>
                </tr>
            </table>

        </div>

        <h5>
            NMA Outcomes
            <button class="btn-sm"
                v-on:click="create_extract('nma')">
                <i class="fa fa-add"></i>
                Add Outcome
            </button>
        </h5>
        <div class="panel-box">
            <div class="oper-bar">

            </div>
            <table class="table">
                <tr>
                    <th>Group</th>
                    <th>Full Name</th>
                    <th>Measure</th>
                    <th>Treatment</th>
                    <th>Control</th>
                </tr>
                <tr v-for="oc in data.nma.outcomes">
                    <td>{{ oc.group }}</td>
                    <td>
                        <a href="javascript:void(0);"
                            v-on:click="show_extract_data(oc.oc_type, oc.abbr)">
                            {{ oc.full_name }}
                        </a>
                    </td>
                    <td>{{ oc.measure }}</td>
                    <td>{{ oc.treatment.full_name }}</td>
                    <td>{{ oc.control.full_name }}</td>
                </tr>
            </table>
        </div>
    </div>
    <!-- /#pan_outcomes -->

    <div id="pan_ocpapers" class="panel-m">
        <div class="panel-info" v-if="extract != null">
            <div v-for="attr_value, attr_name in extract.meta" 
                class="oc-attr">
                <span class="oc-attr-name">{{ attr_name }}</span>
                <input class="oc-attr-value" 
                    :id="'pan_oc_attr_' + attr_name" 
                    v-model="extract.meta[attr_name]">
            </div>
        </div>
        <!-- /.panel-info -->

        <div class="panel-paperlist" v-if="extract != null">
            <table class="table">
                <tr>
                    <th style="width: 90px;">RCT ID</th>
                    <th style="">Paper</th>
                    <th style="">Year</th>
                    <th v-for="attr in extract.meta.attrs">
                        {{ attr }}
                    </th>
                </tr>
                <tr v-for="paper in papers">
                    <td>{{ paper.meta.rct_id }}</td>
                    <td>{{ paper.seq_num }}</td>
                    <td>{{ paper.pub_date }}</td>
                    <td v-for="attr in extract.meta.attrs">
                        -
                    </td>
                </tr>
            </table>
        </div>
        <!-- /.panel-paperlist -->
    </div>
    <!-- /#pan_ocpapers -->

    <div id="pan_collector" class="panel-m">
        <div class="panel-info">
            <div class="oc-attr">
                <span class="oc-attr-name">Abstract</span>
            </div>
            <div class="oc-attr">
                <span class="oc-attr-name">Filename.pdf</span>
            </div>
        </div>
        <!-- /.panel-info -->

        
    </div>
    <!-- /#pan_collector -->

    <div id="pan_analyzer" class="panel-m">
        <div class="panel-info">
            Analyzer
        </div>
        <!-- /.panel-info -->

        
    </div>
    <!-- /#pan_analyzer -->
</div>
<!-- /#main -->


{% endblock %}

{% block active_nav_link %}extractor{% endblock %}

{% block script %}
<script src="https://code.jquery.com/jquery-1.12.4.js"></script>
<script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>

<script>
var sample_project_data = {
    pma: {
        outcomes: {
            "PFS": {
                category: 'default',
                group: 'Primary',
                oc_type: 'pma',
                abbr: 'PFS',
                full_name: 'Progession free survival',
                included_in_plots: 'yes',
                included_in_sof: 'yes',
                data_type: 'raw',
                measure: 'HR',
                method: 'freq',
                fixed_or_random: 'fixed',
                which_is_better: 'lower',
                attrs: [
                    "Et",
                    "Nt",
                    "Ec",
                    "Nc",
                    "treatment",
                    "control"
                ],
                treatment: {
                    abbr: "tr_abbr",
                    full_name: "full_name"
                },
                control: {
                    abbr: "tr_abbr",
                    full_name: "full_name"
                }
            },
            "OS": {
                category: 'default',
                group: 'Primary',
                oc_type: 'pma',
                abbr: 'OS',
                full_name: 'Overall survival',
                included_in_plots: 'yes',
                included_in_sof: 'yes',
                data_type: 'pre',
                measure: 'HR',
                method: 'freq',
                fixed_or_random: 'fixed',
                which_is_better: 'lower',
                attrs: [
                    "sm",
                    "lowerci",
                    "upperci",
                    "treatment",
                    "control",
                    "survival_in_control",
                    "Et",
                    "Ec",
                ],
                treatment: {
                    abbr: "tr_abbr",
                    full_name: "full_name"
                },
                control: {
                    abbr: "tr_abbr",
                    full_name: "full_name"
                }
            },
        }
    },

    nma: {
        outcomes: {
            "PFS": {
                category: 'default',
                group: 'Primary',
                oc_type: 'nma',
                abbr: 'PFS',
                full_name: 'Progession free survival',
                included_in_plots: 'yes',
                included_in_sof: 'yes',
                included_in_em: 'yes',
                data_type: 'raw',
                measure: 'HR',
                method: 'freq',
                fixed_or_random: 'fixed',
                which_is_better: 'lower',
                attrs: [
                    "t1",
                    "t2",
                    "sm",
                    "lowerci",
                    "upperci",
                    "survival_in_t1",
                    "survival_in_t2",
                    "Ec_t1",
                    "Et_t1",
                    "Ec_t2",
                    "Et_t2"
                ]
            }
        }
    },

    itable: {
        attrs: {

        },
        filters: {

        }
    }
};

var sample_oc_data = {
    project_id: 'xxx',

    analysis_type: 'pma',
    oc_abbr: 'PFS',
    rs: {}
};

var pan_outcomes = {
    vpp_id: '#pan_outcomes',
    vpp: null,

    load: function() {
        var project_id = Cookies.get('project_id');

        $.get(
            jarvis.url.get_extracts,
            {project_id:project_id},
            function(data) {
                console.log(data);
                pan_outcomes.add_extracts(data.extracts);
            }, 'json'
        );
    },

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                data: {
                    pma: { outcomes: {} },
                    nma: { outcomes: {} },
                    itable: { outcomes: {} },
                }
            },
            methods: {
                create_extract: function(oc_type) {
                    pan_outcomes.create_extract(oc_type);
                },

                create_itable_column: function() {
                    pan_outcomes.create_itable_column();
                },

                show_extract_data: function(oc_type, abbr) {
                    pan_outcomes.show_extract_data(oc_type, abbr);
                }
            }
        });
    },

    show_extract_data: function(oc_type, abbr) {
        console.log('* show extract [' + oc_type + '] [' + abbr + ']');
        pan_ocpapers.show_extract_and_papers(oc_type, abbr);
    },

    create_itable_column: function() {
        var text = jarvis.prompt('The column name:');
        if (text == null) { return; }
        text = text.trim();
        if (text == '') { return; }

        // detect if exists

        // send to backend

        
    },
    
    create_extract: function(oc_type) {
        // get the full name
        var text = jarvis.prompt('The outcome full name:');
        if (text == null) { return; }
        text = text.trim();
        if (text == '') { return; }

        // create an abbr
        var abbr = jarvis.create_default_oc_abbr();

        // create an meta
        var meta = {
            category: 'default',
            group: 'Primary',
            oc_type: oc_type,
            abbr: abbr,
            full_name: text,
            included_in_plots: 'yes',
            included_in_sof: 'yes',
            data_type: 'raw',
            measure: 'HR',
            method: 'freq',
            fixed_or_random: 'fixed',
            which_is_better: 'lower',
            attrs: [
                "Et",
                "Nt",
                "Ec",
                "Nc",
                "treatment",
                "control"
            ],
            treatment: {
                abbr: "tr_abbr",
                full_name: "full_name"
            },
            control: {
                abbr: "tr_abbr",
                full_name: "full_name"
            }
        };

        var data = {};
        var project_id = Cookies.get('project_id');

        $.post(
            jarvis.url.create_extract,
            {
                project_id: project_id,
                oc_type: oc_type,
                abbr: abbr,
                meta: JSON.stringify(meta),
                data: JSON.stringify(data)
            }, 
            function(data) {
                console.log(data);
                // update UI
                pan_outcomes.add_extracts([data.extract]);
            }, 'json'
        );
    },

    add_extracts: function(extracts) {
        for (let i = 0; i < extracts.length; i++) {
            var extract = extracts[i];
            var oc_type = extract.oc_type;
            var abbr = extract.abbr;
            // add to the related type
            this.vpp.data[oc_type].outcomes[abbr] = extract.meta;
        }

        // update the vpp
        this.vpp.$forceUpdate();
    },

    show: function() {
        $(this.vpp_id).show();
    },

    hide: function() {
        $(this.vpp_id).hide();
    },

    set_size: function(size) {
        $(this.vpp_id).removeClass('panel-s panel-m panel-l')
            .addClass('panel-' + size);
    }
};


var pan_ocpapers = {
    vpp_id: "#pan_ocpapers",
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                extract: null,
                papers: []
            },
            methods: {

            }
        });
    },

    update: function(data) {
        // the data is a combo of extract and papers
        this.vpp.extract = data.extract;
        this.vpp.papers = data.papers;

        // update
        this.vpp.$forceUpdate();
    },

    show_extract_and_papers: function(oc_type, abbr) {
        var project_id = Cookies.get('project_id');
        $.get(
            jarvis.url.get_extract_and_papers,
            {project_id:project_id, abbr:abbr, rnd:Math.random()},
            function(data) {
                pan_ocpapers.update(data);

            }, 'json'
        );
    },

    show: function() {
        $(this.vpp_id).show();
    },

    hide: function() {
        $(this.vpp_id).hide();
    },

    set_size: function(size) {
        $(this.vpp_id).removeClass('panel-s panel-m panel-l')
            .addClass('panel-' + size);
    }
};


var pan_collector = {
    vpp_id: "#pan_collector",
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                data: {},
                type: null
            },
            methods: {

            }
        });
    },

    update: function(data) {
        this.vpp.data = data;
        // this.$forceUpdate();
    },

    show: function() {
        $(this.vpp_id).show();
    },

    hide: function() {
        $(this.vpp_id).hide();
    },

    set_size: function(size) {
        $(this.vpp_id).removeClass('panel-s panel-m panel-l')
            .addClass('panel-' + size);
    }
};


var pan_analyzer = {
    vpp_id: "#pan_analyzer",
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                data: {},
                type: null
            },
            methods: {

            }
        });
    },

    update: function(data) {
        this.vpp.data = data;
        // this.$forceUpdate();
    },

    show: function() {
        $(this.vpp_id).show();
    },

    hide: function() {
        $(this.vpp_id).hide();
    },

    set_size: function(size) {
        $(this.vpp_id).removeClass('panel-s panel-m panel-l')
            .addClass('panel-' + size);
    }
};


var jarvis = {
    url: {
        create_extract: "[[ url_for('extractor.create_extract') ]]",
        get_extracts: "[[ url_for('extractor.get_extracts') ]]",
        get_extract_and_papers: "[[ url_for('extractor.get_extract_and_papers') ]]",
    },

    tpl: {

    },

    layout: {
        manage_outcomes: 'manage_outcomes',
        extract_information: 'extract_information',
        analyze_outcome: 'analyze_outcome'
    },

    create_default_oc_abbr: function() {
        var result = '';
        var characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        var len = characters.length;
        for (var i = 0; i < 8; i++) {
            result += characters.charAt(Math.floor(Math.random() * len));
        }
        return result;
    },

    init: function() {
        // $('#pan_outcomes').accordion();

        pan_outcomes.init();

        pan_ocpapers.init();

        pan_collector.init();

        pan_analyzer.init();

        // switch to default layout
        this.switch_layout('manage_outcomes')

        // the load the init outcomes
        pan_outcomes.load();

        // when resize
        this.adjust_panel_height();
        $(window).resize(function() {
            jarvis.adjust_panel_height();
        });
    },

    switch_layout: function(layout) {
        if (layout == 'manage_outcomes') {
            pan_outcomes.show();
            pan_ocpapers.show();
            pan_collector.hide();
            pan_analyzer.hide();

            // set the default size
            pan_outcomes.set_size('m');
            pan_ocpapers.set_size('m');

        } else if (layout == 'extract_information') {
            pan_outcomes.hide();
            pan_ocpapers.show();
            pan_collector.show();
            pan_analyzer.hide();

            // set the default size
            pan_ocpapers.set_size('m');
            pan_collector.set_size('m');

        } else if (layout == 'analyze_outcome') {
            pan_outcomes.hide();
            pan_ocpapers.show();
            pan_collector.hide();
            pan_analyzer.show();

            // set the default size
            pan_ocpapers.set_size('m');
            pan_analyzer.set_size('m');

        } else {

        }
    },

    prompt: function(text) {
        return window.prompt(text);
    },

    adjust_panel_height: function() {
        var height = $( window ).height();
        $('.panel-container').css(
            'max-height', (height - 90) + 'px'
        );
    }
}

$(document).ready(function() {
    jarvis.init();
})
</script>
{% endblock %}