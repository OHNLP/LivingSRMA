{% extends '_layout_adminlte.html' %}

{% block title %}
Screener Overview
{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">
<link rel="stylesheet" href="https://code.jquery.com/ui/1.12.0/themes/smoothness/jquery-ui.css">

<style>
#ui_category_stat {
    width: 240px;
}
#tbjs_paperlist {
    width: 100%;
}
#pan_iecriteria {
    width: calc(80% - 300px);
    height: 240px;
    position: fixed;
    top: 5px;
    left: 400px;
    right: 0;
    border: 1px solid #999999;
    background-color: white;
    z-index: 9990;
}
iframe {
    height: 100%;
}
.criteria-box {
    padding: 10px;
    height: 210px;
    overflow-y: auto;
    white-space: pre-wrap;
    word-wrap: break-word;
    margin: 0;
}
#pan_pdfviewer {
    position: fixed;
    top: 10px;
    min-width: 1000px;
    min-height: 400px;
    padding: 42px 5px 5px 5px;
    background-color: rgba(249, 249, 250, 1);;
    z-index: 9999;
    border: 3px solid #efefef;
}
#pan_datasync {
    position: fixed;
    top: 10px;
    min-width: 1000px;
    min-height: 400px;
    padding: 42px 5px 5px 5px;
    background-color: rgba(249, 249, 250, 1);;
    z-index: 9999;
    border: 3px solid #efefef;
}
.datasync-textarea {
    width: 100%;
}
#pan_pdfviewer_btns {
    width: 100%;
}
#ifr_pdfviewer {
    width: 100%;
    height: 400px;
    min-height: 400px;
}
#export_dialog {
    /* width: 500px; */
}
td.details-control {
    cursor: pointer;
}
tr.shown td.details-control {
    cursor: pointer;
}
.col-title {
    cursor: pointer;
}
.col-seq {
    text-indent: .5em;
}
.col-actions {
    line-height: 1em;
}
/* for highlight */
.keyword-exclusion {
    color: rgb(250, 89, 89);
    background: rgb(255, 205, 205);
    /* padding: 2px 3px; */
    /* border-radius: 3px; */
    padding: 0;
    margin: 0;
    cursor: pointer;
}
.keyword-inclusion {
    color: rgb(1, 56, 1);
    background: rgb(223, 245, 223);
    /* padding: 2px 3px; */
    /* border-radius: 3px; */
    padding: 0;
    margin: 0;
    cursor: pointer;
}
.keyword-rct-id {
    color: #925f01;
    background-color: bisque;
    font-size: .95em;
}
.search-highlight {
    text-decoration: underline;
    background-color: rgb(230, 195, 132);
}
/* badge */
.tag-filter-item {
    background: #e0dfdf;
    padding-left: 3px;
    padding-right: 3px;
    border-radius: 3px;
}
.tr-tags .badge-tag {
    padding: 9px 7px;
    font-size: .8em;
}
.badge-tag {
    cursor: pointer;
    color: #333333;
    background-color: #dfdfd5;
    font-weight: bold;
}
.badge-tag:hover {
    color: black;
    background-color: rgb(212, 211, 211);
}
.badge-tag-not-used {
    cursor: pointer;
    color: #999999;
    background-color: #dddddd;
    border: 1px dotted #cccccc;
    font-weight: normal;
}
.badge-ckl {
    color: #fff;
    background-color: #b88d17;
}
.badge-unscreened {
    color: #fff;
    background-color: #696b00;
}
.row th {
    border-top: 1px solid #111111;
    border-right: 1px solid #111111;
}
.exclusion-reason {
    width: 150px;
}
.hide {
    display: none;
}
.offscreen {
    left: -8888px !important;
}
.fs-s, .text-sm {
    font-size: 10px;
}
.fs-m, .text-nm {
    font-size: 12px;
}
.fs-l, .text-lg {
    font-size: 14px;
}
.study-type-original {
    
}
.study-type-followup {

}
</style>
{% endblock %}

{% block page_name %}
<i class="fas fa-map-signs"></i>
Screener Overview
{% endblock %}

{% block content %}

<div id="pan_iecriteria" class="shadow-sm" :class="{hide:is_hide}">
    <div style="position: absolute; left: 5px; top: 0px;">
        <a href="javascript:void(0);"
            v-on:click="toggle();">
            <i class="fa fa-close"></i>
        </a>
    </div>
    <div class="d-flex flex-row">
        <div class="d-flex flex-column w-50 border-right">
            <div class="text-center fw-bolder border-bottom .bg-success">INCLUSION</div>
            <pre class="criteria-box fs-m" v-if="criterias != null">{{ criterias.inclusion }}</pre>
        </div>
        <div class="d-flex flex-column w-50 ml-1">
            <div class="text-center fw-bolder border-bottom">EXCLUSION</div>
            <pre class="criteria-box fs-m" v-if="criterias != null">{{ criterias.exclusion }}</pre>
        </div>
    </div>
</div>


<div id="pan_pdfviewer" class="shadow-sm" :class="{offscreen:is_hide}">
    <div style="position: absolute; left: 5px; top: 5px;" class="d-flex flex-row">
        <div class="mt-1 mr-5 ml-1">
            <a href="javascript:void(0);"
                v-on:click="toggle();">
                <i class="fa fa-close"></i>
            </a>
        </div>

        <div id="pan_pdfviewer_btns" class="d-flex flex-row">
            
        </div>
    </div>

    <iframe id="ifr_pdfviewer" src="/pdfworker/view_pdf" 
        width="100%" scrolling="yes"
        frameborder="0"></iframe>
</div>


<div id="pan_datasync" class="shadow-sm" :class="{offscreen:is_hide}">
    <div style="position: absolute; left: 5px; top: 5px;" class="d-flex flex-row">
        <div class="mt-1 mr-5 ml-1">
            <a href="javascript:void(0);"
                v-on:click="toggle();">
                <i class="fa fa-close"></i>
            </a>
        </div>

        <div id="pan_datasync_btns" class="d-flex flex-row"
            v-if="new_data != null">
            {{ new_data.pmid }}
        </div>
    </div>

    <div v-if="new_data != null"
        style="padding: 5px 10px;">
        <div class="form-group row">
            <label for="ds_title" class="col-sm-2 col-form-label">Title</label>
            <div class="col-sm-10">
                <textarea name="ds_title" id="ds_title" rows="2"
                    class="datasync-textarea"
                    v-model="new_data.title"></textarea>
            </div>
        </div>

        <div class="form-group row">
            <label for="ds_authors" class="col-sm-2 col-form-label">Authors</label>
            <div class="col-sm-10">
                <textarea name="ds_authors" id="ds_authors" rows="2"
                    class="datasync-textarea"
                    v-model="new_data.authors"></textarea>
            </div>
        </div>

        <div class="form-group row">

            <label for="ds_journal" class="col-sm-2 col-form-label">Journal</label>
            <div class="col-sm-4">
                <textarea name="ds_journal" id="ds_journal" rows="1"
                    class="datasync-textarea"
                    v-model="new_data.journal"></textarea>
            </div>

            <label for="ds_pub_date" class="col-sm-2 col-form-label">Publication Date</label>
            <div class="col-sm-4">
                <textarea name="ds_pub_date" id="ds_pub_date" rows="1"
                    class="datasync-textarea"
                    v-model="new_data.pub_date"></textarea>
            </div>
        </div>

        <div class="form-group row">
            <label for="ds_pub_date" class="col-sm-2 col-form-label">Abstract</label>
            <div class="col-sm-10">
                <textarea name="ds_pub_date" id="ds_pub_date" rows="10"
                    class="datasync-textarea"
                    v-model="new_data.abstract"></textarea>
            </div>
        </div>

        <div class="row">
            <div class="col-sm-12 text-right">
                <button class="btn btn-primary"
                    v-bind:disabled="is_btn_disabled"
                    v-on:click="update_paper_detail">
                    <i class="fa fa-save"></i>
                    Update the information for paper [ {{ new_data.pmid }} ]
                </button>
            </div>
        </div>

    </div>
</div>


<div id="export_dialog" class="modal" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document">
    <div class="modal-content">
    <div class="modal-header">
    <h5 class="modal-title">Export Table</h5>
    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
        <span aria-hidden="true">&times;</span>
    </button>
    </div>
    <div class="modal-body">
        <p>There are <b id="export_dialog_total_number">&nbsp;</b> records in the current table, export them as the following foramt:</p>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="export_format" id="export_format_1" value="endnote_xml" checked>
            <label class="form-check-label" for="export_format_1">
            EndNote XML 
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="export_format" id="export_format_3" value="ovid_xml" checked>
            <label class="form-check-label" for="export_format_3">
            OVID XML 
            </label>
        </div>
        <div class="form-check">
            <input class="form-check-input" type="radio" name="export_format" id="export_format_2" value="ct01_csv">
            <label class="form-check-label" for="export_format_2">
            Excel XLS (NCT, PMID, Journal, Year, Number of Authors, Authors)
            </label>
        </div>
    </div>
    <div class="modal-footer">
        <button type="button" class="btn btn-primary"
            onclick="tbjs_paperlist.export_current_table();">
            <i class="fa fa-file-export"></i>
            Export
        </button>

        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
    </div>
    </div>
</div>
</div>

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div id="ui_category_stat">
                <h5>
                    <i class="far fa-file-alt"></i>
                    All References
                </h5>
                <div class="list-group">
                    <!-- <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('all_of_them')">
                        All
                        <span class="badge badge-secondary badge-pill">{{ stat.all_of_them }}</span>
                    </button> -->
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('unscreened')">
                        Unscreened
                        <span>
                            <span class="badge badge-unscreened badge-pill">{{ stat.unscreened }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.unscreened_ckl }}</span>
                        </span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('decided')">
                        Decided
                        <span class="badge badge-secondary badge-pill">{{ stat.decided }}</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Further Check
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('passed_title_not_fulltext')">
                        Full Text Review
                        <span>
                            <span class="badge badge-secondary badge-pill">{{ stat.passed_title_not_fulltext }}</span>
                            <span class="badge badge-primary badge-ckl">{{ stat.passed_title_not_fulltext_ckl }}</span>
                        </span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Included References
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('included_sr')">
                        Included in SR
                        <span>
                            <span class="badge badge-primary badge-pill">{{ stat.included_sr }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.included_sr_ckl }}</span>
                        </span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('included_srma')">
                        Included in SR &amp; MA
                        <span>
                            <span class="badge badge-primary badge-pill">{{ stat.included_srma }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.included_srma_ckl }}</span>
                        </span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Excluded References
                </h5>
                <div class="list-group">
                    <!-- <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_rct_classifier')">
                        By RCT Classifier
                        <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_rct_classifier }}</span>
                    </button> -->
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_title')">
                        By Title
                        <span>
                            <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_title }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.excluded_by_title_ckl }}</span>
                        </span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_abstract')">
                        By Abstract
                        <span>
                            <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_abstract }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.excluded_by_abstract_ckl }}</span>
                        </span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_fulltext')">
                        By Full Text
                        <span>
                            <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_fulltext }}</span>
                            <span class="badge badge-secondary badge-ckl">{{ stat.excluded_by_fulltext_ckl }}</span>
                        </span>
                    </button>
                </div>

                <hr>

                <h5 class="mt-3">
                    <i class="fa fa-cog"></i>
                    Screener Tools
                </h5>
                <div class="btn-group mb-1" role="group" aria-label="Basic example">
                    <button id="btn_update_original_followup" class="btn btn-default"
                        onclick="jarvis.sort_rct_seq();">
                        <i class="fa fa-project-diagram"></i>
                        Update Original/Followup
                    </button>
                </div>

                <div class="btn-group" role="group" aria-label="Basic example">
                    <button class="btn btn-default"
                        onclick="tbjs_paperlist.show_export_panel();">
                        <i class="fa fa-file-export"></i>
                        Export Reference List
                    </button>
                </div>
            </div>
            <!-- / left pane -->

            <div style="width: calc(100% - 250px); margin-left: 10px;">
                <h5>
                    <i class="far fa-file-alt"></i>
                    Reference List | 
                    <span id="tbjs_paperlist_title"></span>

                    <a style="font-size: .8em;" class="mr-2" href="javascript:void(0);" onclick="pan_iecriteria.toggle();">
                        <i class="far fa-clipboard"></i>
                        Inclusion / Exclusion Criteria
                    </a>
                </h5>

                <div id="tbjs_paperlist_tools">
                    <div class="form-row">
                        
                        <div class="form-group col mb-0">
                            <label class="mr-2">
                                <i class="fa fa-filter"></i>
                                Filters: 
                            </label>

                            <div class="form-check form-check-inline">

                                <input class="form-check-input" type="checkbox" name="checkbox_lbl_rct" id="checkbox_lbl_rct">
                                <label class="form-check-label" for="checkbox_lbl_rct">
                                    Show <span class="badge badge-pill badge-info"><i class="fa fa-bong"></i> RCT</span> Only
                                </label>
                            </div>
    
                            <div class="form-check form-check-inline">
                                <input class="form-check-input" type="checkbox" name="checkbox_lbl_ckl" id="checkbox_lbl_ckl">
                                <label class="form-check-label" for="checkbox_lbl_ckl">
                                    Show <span class="badge badge-pill badge-ckl"><i class="far fa-clock"></i> Check Later</span> Only
                                </label>
                            </div>
                        </div>

                        <div class="form-group col form-inline mb-0">
                            <label class="mr-2">
                                <i class="fa fa-sort-amount-down"></i>
                                Sort by: 
                            </label>

                            <button class="btn btn-default btn-sm" onclick="tbjs_paperlist.sort_by_decision_reason();">
                                <i class="fa fa-sort-alpha-down"></i>
                                Decision Reason
                            </button>
                            
                        </div>

                    </div>

                    <div class="form-row">
                        <div class="form-group col">
                            <label for="" class="mr-2">
                                <i class="fa fa-tags"></i>
                                Tag Filters:
                            </label>

                            <button class="btn btn-default btn-sm"
                                onclick="tbjs_paperlist.reset_tag_filter();">
                                <i class="fa fa-undo"></i>
                                Reset
                            </button>

                            {% for i, tag in enumerate(project['settings']['tags']) %}
                            <div class="form-check form-check-inline mr-2 tag-filter-item">
                                <input class="form-check-input tag-filter" type="checkbox" name="checkbox_tag_[[i]]" id="checkbox_tag_[[i]]" value="[[ tag ]]">
                                <label class="form-check-label" for="checkbox_tag_[[i]]">
                                    [[ tag ]]
                                </label>
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                </div>
                <!-- /div#tbjs_paperlist_filters -->


                <table id="tbjs_paperlist" class="display compact hover" style="width: 100%;">

                </table>
            </div>
            <!-- / right pane -->
        </div>
    </div>
</div>
<!-- /.timeline -->

</div>
</div>
</div>


{% endblock %}

{% block active_nav_link %}screener-overview{% endblock %}

{% block script %}
<script src="/static/lib/d3/d3.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>

<!-- datatable.js and extensions -->
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.13/features/mark.js/datatables.mark.js"></script>
<!-- <script src="https://cdn.datatables.net/searchpanes/1.2.0/js/dataTables.searchPanes.min.js"></script>
<script src="https://cdn.datatables.net/select/1.3.1/js/dataTables.select.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/searchpanes/1.2.0/css/searchPanes.dataTables.min.css">
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/select/1.3.1/css/select.dataTables.min.css"> -->


<!-- my scripts -->
<script>

{% include 'js/srv_pubmed.js' %}
{% include 'js/srv_screener.js' %}

// update the project information
srv_screener.project = [[ project_json_str|safe ]];


var ui_category_stat = {
    vpp_id: '#ui_category_stat',
    vpp: null,

    load: function() {
        // load data from backend by srv_screener
        srv_screener.get_stat(function(data){
            ui_category_stat.init(data.stat);
        });
    },

    init: function(data) {
        this.data = data;
        console.log('* initing ui_category_stat', data);
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                stat: data
            },
            methods: {
                show_stage: function(stage) {
                    console.log('* show ' + stage);

                    // update paper list
                    tbjs_paperlist.load_by_stage(stage);
                }
            }
        });        
    },

    update: function() {
        srv_screener.get_stat(function(data){
            ui_category_stat.vpp.stat = data.stat;
        });
    }
};


var tbjs_paperlist = {
    table_id: '#tbjs_paperlist',
    table: null,

    // the list of all papers
    data: null,

    // for the full content of a paper
    // key is the pid
    papers: {},

    cfg: {
        number_of_rows: 10
    },

    // by default, show unscreened stage
    stage: srv_screener.STAGE_UNSCREENED,

    // for highlight NCT number
    regex_RCT_ID: /NCT\d{8}/gmi,

    columns: [
        // column 0
        {
            title: '#',
            className: 'col-seq',
            orderable: true,
            data: 'seq_num'
        },

        // column 1
        {
            title: '',
            width: 25,
            className: 'details-control dt-center',
            orderable: false,
            data: 'first_column'
        },

        // column 2
        { 
            title: 'Date', 
            width: 80,
            data: 'date_created_norm' 
        },

        // column 3
        { 
            title: 'Labels', 
            width: 50,
            data: 'labels' 
        },

        // column 4
        { 
            title: 'Title', 
            data: 'title_with_tags',
            className: 'col-title',
        },

        // column 5
        {
            title: '',
            className: 'col-actions',
            width: 190,
            orderable: false,
            data: 'basic_actions'
        },
        
        // hidden columns for sorting
        // hidden column 6
        {
            title: '',
            data: 'decision_reason',
            visible: false,
            searchable: false
        },

        // hidden columns for filtering
        // hidden column 7
        {
            title: '',
            data: 'tags',
            visible: false,
            searchable: true
        },

        // hidden columns for searching
        // hidden column 8
        {
            title: '',
            data: 'pid',
            visible: false,
            searchable: true
        },

        // hidden columns for searching
        // hidden column 9
        {
            title: '',
            data: 'paper_rct_id',
            visible: false,
            searchable: true
        }
    ],

    sample: [
        { pid: '123456', authors: 'B, X, C and E', date: '2020-10-01', title: 'A title here', journal: 'JAMA', abstract: 'This is the abstract content' },
        { pid: '123457', authors: 'A, B, U and E', date: '2020-10-01', title: 'A title here', journal: 'NEJM', abstract: 'This is the abstract content' },
        { pid: '123458', authors: 'D, B, N and E', date: '2020-10-01', title: 'A title here', journal: 'Lancet', abstract: 'This is the abstract content' }
    ],

    init: function() {
        // the search filter for RCT
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var chk = $('input#checkbox_lbl_rct').prop('checked');

                if (chk) {
                    if (data[3].indexOf('RCT')>=0) {
                        return true;
                    } else {
                        return false;
                    }
                }
                return true;
            }
        );

        // the search filter for Check later
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var chk = $('input#checkbox_lbl_ckl').prop('checked');

                if (chk) {
                    if (data[3].indexOf('Check')>=0) {
                        return true;
                    } else {
                        return false;
                    }
                }
                return true;
            }
        );

        // the search filter for tags
        $.fn.dataTable.ext.search.push(
            function( settings, data, dataIndex ) {
                var chk_tags = [];
                $('.tag-filter').each(function(){ 
                    var chk = $(this).prop('checked');
                    if (chk) {
                        chk_tags.push($(this).val())
                    }
                });
                if (chk_tags.length == 0) {
                    // no tag is checked, ok
                    return true;
                } else {
                    // at least one tag is checked
                    for (var i = 0; i < chk_tags.length; i++) {
                        var chk_tag = chk_tags[i];
                        if (data[7].indexOf(chk_tag)>=0) {
                            return true;
                        }
                    }
                    return false;
                }
            }
        );

        // init the datatable obj
        this.table = $(this.table_id).DataTable({
            responsive: true,
            autoWidth: false,
            pageLength: this.cfg.number_of_rows,
            data: [],
            columns: this.columns,
            order: [
                [1, 'desc']
            ],

            // bind the row attributes
            createdRow: function(row, data, dataIndex) {
                $(row).attr('id', 'tb-row-' + data.paper_id);
            },

            // show the color for highlight
            mark: {
                element: 'span',
                className: 'search-highlight'
            }
            
        });

        // update the open/close details event
        $(this.table_id + ' tbody').on('click', 'td.details-control', function() {
            var tr = $(this).closest('tr');
            var row = tbjs_paperlist.table.row( tr );
    
            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                $(this).html('<i class="fa fa-plus"></i>')
            }
            else {
                // Open this row
                var row_html = tbjs_paperlist._get_expand_html_by_stage(row.data());
                row.child(row_html).show();
                tbjs_paperlist.update_paper_detail(row.data());
                tr.addClass('shown');
                $(this).html('<i class="fa fa-minus"></i>')

                // trigger the highlight
                tbjs_paperlist._mark_element('#tb-rowext-abstract-' + row.data().paper_id);
            }
        });

        // update the click title event
        $(this.table_id + ' tbody').on('click', 'td.col-title', function() {
            var tr = $(this).closest('tr');
            var row = tbjs_paperlist.table.row( tr );
    
            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                tr.find('td.details-control').html('<i class="fa fa-plus"></i>')
            }
            else {
                // Open this row
                var row_html = tbjs_paperlist._get_expand_html_by_stage(row.data());
                row.child(row_html).show();
                tbjs_paperlist.update_paper_detail(row.data());
                tr.addClass('shown');
                tr.find('td.details-control').html('<i class="fa fa-minus"></i>')

                // trigger the highlight
                tbjs_paperlist._mark_element('#tb-rowext-abstract-' + row.data().paper_id);
            }
        });

        // add highlight event to the title
        this.table.on('draw', function () {
            // console.log( 'Redraw occurred at: '+new Date().getTime() );

            // in the title column
            // mark the inclusion keywords
            $(".col-title").mark(
                srv_screener.project.settings.highlight_keywords.inclusion,
                {
                    className: 'keyword-inclusion',
                    separateWordSearch: false
                }
            );

            // mark the exclusion keywords
            $(".col-title").mark(
                srv_screener.project.settings.highlight_keywords.exclusion,
                {
                    className: 'keyword-exclusion',
                    separateWordSearch: false
                }
            );
        });

        // the filter event for RCT
        $('#checkbox_lbl_rct').change(function() {
            tbjs_paperlist.toggle_label_rct();
        });

        // the filter event for check later
        $('#checkbox_lbl_ckl').change(function() {
            tbjs_paperlist.toggle_label_ckl();
        });

        // the filter event for tags
        $('.tag-filter').change(function() {
            tbjs_paperlist.toggle_tag_filter();
        })
    },

    _mark_element: function(elem) {
        // mark the inclusion keywords
        $(elem).mark(
            srv_screener.project.settings.highlight_keywords.inclusion,
            {
                className: 'keyword-inclusion',
                separateWordSearch: false
            }
        );

        // mark the exclusion keywords
        $(elem).mark(
            srv_screener.project.settings.highlight_keywords.exclusion,
            {
                className: 'keyword-exclusion',
                separateWordSearch: false
            }
        );

        // mark the NCT keywords
        $(elem).markRegExp(
            this.regex_RCT_ID, 
            {
                className: 'badge badge-pill keyword-rct-id',
                separateWordSearch: false
            }
        );
    },

    update_paper_detail: function(d) {
        // send a request to get more information
        srv_screener.get_paper_by_id(d.paper_id, function(data) {
            // update the local database
            tbjs_paperlist.papers[data.paper.pid] = data.paper;

            // update the abstract
            $('#tb-rowext-abstract-' + data.paper.paper_id).html(data.paper.abstract);

            // trigger the highlight
            tbjs_paperlist._mark_element('#tb-rowext-abstract-' + data.paper.paper_id);
        });
    },

    load: function() {
        srv_screener.get_papers(
            srv_screener.stage.STAGE_UNSCREENED,
            function(data) {
                tbjs_paperlist.update(data.papers);
            }
        );
    },

    load_by_stage: function(stage) {
        // set stage
        this.stage = stage;

        // update header title
        $('#tbjs_paperlist_title').html(
            srv_screener.stage[stage].title
        );

        // empty the search filter input box
        $(this.table_id + '_filter input').val('');
        // reset the search filter
        this.table.search('');

        // get data
        srv_screener.get_papers(
            stage,
            function(data) {
                tbjs_paperlist.update(data.papers);
            }
        );
    },

    update: function(data) {
        // add more columns to data and bind to local
        this.update_data_attrs(data);
        
        // remove the old data
        this.table.clear();

        // put new data
        this.table.rows.add(data);

        // render
        this.table.draw();
    },

    update_data_attrs: function(data) {
        for (var i = 0; i < data.length; i++) {
            var d = data[i];

            // update the attrs of d
            d = this.update_datum_attrs(d);
        }

        this.data = data;
    },

    update_datum_attrs: function(d) {
        // add the pred_is_rct column
        d['first_column'] = this._update_attr_first_column(d);

        // add the pred_is_rct column
        d['labels'] = this._update_attr_labels(d);

        // add the title_with_tags column
        d['title_with_tags'] = this._update_attr_title_with_tags(d);

        // add the date_created_norm column
        d['date_created_norm'] = this._update_attr_date_created_norm(d);

        // add the date_published_norm column
        d['date_published_norm'] = this._update_attr_date_published_norm(d);

        // add the basic buttons column
        d['basic_actions'] = this._get_basic_actions_by_stage(d);

        // add the decision reason column for sort
        d['decision_reason'] = this._update_attr_decision_reason(d);

        // add the tags column for filter
        d['tags'] = this._update_attr_tags(d);

        // add the rct_id column for search
        d['paper_rct_id'] = this._update_attr_paper_rct_id(d);

        return d;
    },

    update_data_by_paper: function(paper) {
        // find the paper in the data 
        for (var i = 0; i < this.table.data().length; i++) {
            if (this.table.row(i).data().paper_id == paper.paper_id) {
                this.table.row(i).data(
                    this.update_datum_attrs(paper)
                ).draw(false);
                break;
            }
        }
    },

    ///////////////////////////////////////////////////////////////////////////
    // Update the data attributes
    ///////////////////////////////////////////////////////////////////////////
    _update_attr_first_column: function(d) {
        return '<i class="fa fa-plus"></i>';
    },

    _update_attr_labels: function(d) {
        var label_rct = '<span class="badge badge-pill badge-info"><i class="fa fa-bong"></i> RCT</span>';

        var label_ckl = '<span class="badge badge-pill badge-ckl"><i class="far fa-clock"></i> Check Later</span>';

        // create the return string
        var ret = '';
        
        // the RCT label
        if (d.meta.hasOwnProperty('pred')) {
            // if is RCT
            if (d.meta.pred[0].is_rct) {
                ret += label_rct;
            }
        }

        // the Check later label
        if (srv_screener.has_label_ckl(d)) {
            ret += label_ckl;
        }

        return ret;
    },

    _update_attr_title_with_tags: function(d) {
        var ret = '';
        var tags = [];
        if (d.meta.hasOwnProperty('tags')) {
            for (var i = 0; i < d.meta.tags.length; i++) {
                var tag = d.meta.tags[i];

                // create a tag badge
                var tag_badge = '<span class="badge badge-tag mr-1">' +
                    // '<i class="fa fa-tag"></i> ' + 
                    tag +
                    '</span>';

                tags.push(tag_badge);
            }
        }
        // combine the tags
        tags = tags.join('');

        // combine the tags and title
        if (tags == '') {
            // if no tags, just leave title
            ret = d.title;
        } else {
            // if has tags, put tags as one line
            ret = tags + '<br>' + d.title;
        }
        return ret;
    },

    _update_attr_date_created_norm: function(d) {
        var ret = '';
        ret = dayjs(d.date_created).format('YYYY-MM-DD');
        return ret;
    },

    _update_attr_date_published_norm: function(d) {
        var ret = d.pub_date;
        try {
            ret = dayjs(d.pub_date).format('YYYY-MM-DD');
        } catch {
            ret = ' - ';
        }

        return ret;
    },

    _update_attr_decision_reason: function(d) {
        var ret = '';
        if (d.ss_ex.hasOwnProperty('reason')) {
            ret = d.ss_ex.reason;
        }
        return ret;
    },

    _update_attr_tags: function(d) {
        var ret = [];

        // the tags 
        if (d.meta.hasOwnProperty('tags')) {
            for (var i = 0; i < d.meta.tags.length; i++) {
                var tag = d.meta.tags[i];
                ret.push(tag);
            }
        }

        // combine the tags by | sym
        return ret.join('|');
    },

    _update_attr_paper_rct_id: function(d) {
        var ret = '';
        if (d.meta.hasOwnProperty('rct_id')) {
            ret = d.meta.rct_id;
        }
        return ret;
    },

    ///////////////////////////////////////////////////////////////////////////
    // Get the basic actions column
    ///////////////////////////////////////////////////////////////////////////

    _get_basic_actions_by_stage: function(d) {
        var stage = this.stage;
        var func_name = '_get_basic_actions_by_stage_' + stage;
        var html = this[func_name](d);
        return html;
    },

    _get_basic_actions_by_stage_all_of_them: function(d) {
        var html = '';
        return html;
    },

    _get_basic_actions_by_stage_unscreened: function(d) {
        var html = '';
        html = '<button class="btn btn-danger btn-sm" title="Exclude this study by title" onclick="tbjs_paperlist.exclude_by_tt(\''+d.paper_id+'\')">Exclude By Title</button>';

        return html;
    },
    
    _get_basic_actions_by_stage_passed_title_not_fulltext: function(d) {
        var html = '';
        return html;
    },

    _get_basic_actions_by_stage_included_sr: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_included_srma: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_title: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_abstract: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_fulltext: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_decided: function(d) {
        var html = '';

        // the decision date
        html +=  '<small>' + d.ss_ex.date_decided + '</small><br>';

        // the main decision
        html += '<span style="color: ' + srv_screener.ss.rs[d.ss_rs].color + ';">' + srv_screener.ss.rs[d.ss_rs].name + '</span>';

        // the reason
        if (d.ss_ex.reason != '') {
            html += '<br>' + d.ss_ex.reason;
        }

        return html;
    },

    ///////////////////////////////////////////////////////////////////////////
    // Get the expand HTML content
    ///////////////////////////////////////////////////////////////////////////

    _get_expand_html_by_stage: function(d) {
        var stage = this.stage;
        var func_name = '_get_expand_html_by_stage_' + stage;
        var func = this[func_name];

        // the html is always a table
        // content of this table is decided by the stage
        // and for each stage, the main differences are the buttons
        var html = '<table id="tb-rowext-'+d.paper_id+'" style="width:100%;" cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
            this[func_name](d) +
        '</table>'
        return html;
    },

    _get_expand_html_by_stage_all_of_them: function(d) {
        var html = 
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },
    
    _get_expand_html_by_stage_unscreened: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-secondary btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Proceed to Full-Text Review</button> '+
                '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\', \'Through Abstract\')">Include in SR</button> '+
                
                '<button class="btn btn-danger btn-sm" onclick="tbjs_paperlist.exclude_by_ab(\''+d.paper_id+'\')">Exclude by Abstract</button> '+
                ' | ' +
                _html_btn_ckl +
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },
    
    _get_expand_html_by_stage_passed_title_not_fulltext: function(d) {
        var html = [
            '<tr>', 
                '<td>Actions:</td>',
                '<td class="d-flex flex-row">',
                '<div>',
                    '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\', \'Through Full Text Review\')">Include in SR</button>',
                '</div>',

                '<div class="ml-2">',
                    this.__get_select_fulltext_exclusion_reasons(d),
                    '<button class="btn btn-danger btn-sm" type="button" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\')">',
                        'Exclude by Full-Text Review',
                    '</button>',
                '</div>',

                '<div class="ml-2">',
                    '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button>',
                '</div>',

                '<div class="ml-2">',
                    this.__get_btn_check_later(d),
                '</div>',

                '<div class="ml-2">',
                    '<span class="mr-2">|</span>',
                    this.__get_div_rct_yes_no(d),
                '</div>',

                '</td>',
            '</tr>',

            this.__get_tr_tags(d),
            this.__get_tr_pdfs(d),
            this.__get_tr_info(d),
            this.__get_tr_authors(d),
            this.__get_tr_abstract(d)

        ].join('');
        return html;
    },

    _get_expand_html_by_stage_included_sr: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);

        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_srma(\''+d.paper_id+'\')">Include in MA</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                _html_btn_ckl + 
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_pdfs(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_included_srma: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\', \'Back from MA\')">Send Back to SR</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                _html_btn_ckl + 
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_pdfs(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_title: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);

        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                _html_btn_ckl + 
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_abstract: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);

        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                _html_btn_ckl + 
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_fulltext: function(d) {
        var _html_btn_ckl = this.__get_btn_check_later(d);

        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                _html_btn_ckl + 
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_decided: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                this.__get_div_rct_yes_no(d) + 
                '</td>'+
            '</tr>'+
            this.__get_tr_tags(d) +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    ///////////////////////////////////////////////////////////////////////////
    // HTML fragment makers
    ///////////////////////////////////////////////////////////////////////////


    /* this is just for the toolbar */
    _get_pdfview_toolbar: function(d) {
        // var _html_btn_ckl = this.__get_btn_check_later(d);
        var html = [
            '<div>',
                '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\', \'Through Full Text Review\'); pan_pdfviewer.hide();">Include in SR</button>',
            '</div>',

            '<div class="ml-2">',
                this.__get_select_fulltext_exclusion_reasons(d),
                '<button class="btn btn-danger btn-sm" type="button" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\'); pan_pdfviewer.hide();">',
                    'Exclude by Full-Text Review',
                '</button>',
            '</div>',

            '<div class="ml-2">',
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\'); pan_pdfviewer.hide();">Send Back to Unscreened</button>',
            '</div>',
        ].join('');

        return html;
    },

    __get_select_fulltext_exclusion_reasons: function(d) {
        var reasons = [];
        for (let i = 0; i < srv_screener.project.settings.exclusion_reasons.length; i++) {
            const er = srv_screener.project.settings.exclusion_reasons[i];
            let opt_r = '<option value="'+er+'">'+er+'</option>';
            reasons.push(opt_r);
        }
        reasons = reasons.join('\n');
        var html = [
            '<select class="custom-select exclusion-reason custom-select-sm mr-2" id="tb-row-exclude-reason-'+d.paper_id+'">',
                reasons,
            '</select>'
        ].join('');
        return html;
    },

    /**
     * Deprecated
     */
    __get_select_fulltext_exclusion_reasons_v1: function(d) {
        var reasons = [];
        for (let i = 0; i < srv_screener.project.settings.exclusion_reasons.length; i++) {
            const er = srv_screener.project.settings.exclusion_reasons[i];
            let opt_r = '<option value="'+er+'">'+er+'</option>';
            reasons.push(opt_r);
        }
        reasons = reasons.join('\n');
        var html = [
            '<div class="ml-2">',
            '<select class="custom-select exclusion-reason custom-select-sm mr-2" id="tb-row-exclude-reason-'+d.paper_id+'">',
                reasons,
            '</select>',
            
            '<button class="btn btn-danger btn-sm" type="button" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\')">',
                'Exclude by Full-Text Review',
            '</button>',

            '</div>'
        ].join('');
        return html;
    },

    /**
     * Deprecated
     */
    __get_select_fulltext_exclusion_reasons_v1: function(d) {
        var html = [
            '<div class="dropdown">',
            '<button class="btn btn-danger dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">',
                'Exclude by Full-Text Review',
            '</button>',
            '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Conference Abstracts\')">Conference Abstracts</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Editorials, Commentaries, Case Reports\')">Editorials, Commentaries, Case Reports</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Non-Randomized Studies\')">Non-Randomized Studies</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Cohort Studies\')">Cohort Studies</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Narrative Reviews\')">Narrative Reviews</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Systematic Reviews and Meta-Analyses\')">Systematic Reviews and Meta-Analyses</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Subgroup Analysis/Exploratory Analysis/Sub-Study\')">Subgroup Analysis/Exploratory Analysis/Sub-Study</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'ICI in the control arm\')">ICI in the control arm</a>',
 
                '<div class="dropdown-divider"></div>',
                '<a class="dropdown-item" href="javascript:void();">Add a new reason</a>',
            '</div>',
            '</div>',
        ].join('');
        return html;
    },

    __get_btn_check_later: function(d) {
        var html = '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.set_label_check_later(\''+d.paper_id+'\')"><i class="far fa-clock"></i> Check Later</button>';
        if (srv_screener.has_label_ckl(d)) {
            html = '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.unset_label_check_later(\''+d.paper_id+'\')"><i class="far fa-clock"></i> Has Checked</button>';
        }

        return html;
    },

    __get_div_rct_yes_no: function(d) {
        var usr_fb = '';
        if (d.meta.pred[0].hasOwnProperty(srv_screener.ATTR_PRED_RCT_USR_FB)) {
            usr_fb = srv_screener.RCT_USER_FEEDBACK[d.meta.pred[0][srv_screener.ATTR_PRED_RCT_USR_FB]];
        }
        var html = [
            '<label class="mr-2">This study is <span id="tb-row-rct-feedback-'+d.paper_id+'">'+usr_fb+'</span></label>', 
            '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.set_rct_feedback(\''+d.paper_id+'\', 1)">It\'s a RCT</button> ',
            '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.set_rct_feedback(\''+d.paper_id+'\', 0)">It\'s not a RCT</button>',
        ].join('');

        return html;
    },

    __get_span_rct_id: function(d) {
        var html = [];
        if (d.meta.rct_id == '') {
            html = [
                '<a href="javascript:void(0);" onclick="tbjs_paperlist.set_rct_id(\''+d.paper_id+'\', \'\')" title="Click to update the NCT number for this study">Add NCT Number</a>'
            ].join('');
        } else {
            html = [
                '<a href="javascript:void(0);" onclick="tbjs_paperlist.set_rct_id(\''+d.paper_id+'\', \''+d.meta.rct_id+'\')" title="Click to update the NCT number for this study">',
                    d.meta.rct_id,
                '</a>'
            ].join('');
        }

        return html;
    },

    __get_span_pmid: function(d) {
        var html_study_type = '';
        if (d.meta.rct_id == '') {

        } else {
            if (d.meta.hasOwnProperty('study_type') && d.meta.study_type != null) {
                // this means this paper has been sorted
                if (d.meta.rct_seq == 0) {
                    html_study_type = '<span class="ml-1 mr-1 study-type-'+
                        d.meta.study_type+'"> '+
                        '(<span class="badge badge-pill badge-info">'+d.meta.study_type.toUpperCase()+'</span>)'+
                        '</span>';

                } else {
                    html_study_type = '<span class="ml-1 mr-1 study-type-'+
                        d.meta.study_type+'"> '+
                        '(<span class="badge badge-pill badge-success">'+d.meta.study_type.toUpperCase()+' - '+d.meta.rct_seq+'</span>)'+
                        '</span>';
                }
            }
        }

        var html = [
            html_study_type + ' ', 
            '<a href="javascript:void(0);" onclick="tbjs_paperlist.set_pmid(\''+d.paper_id+'\', \''+d.pid+'\')" title="Click to update the PMID for this study">',
                d.pid_type + ': ', 
                d.pid,
            '</a>'
        ].join('');
        
        return html;
    },

    __get_tr_pdfs: function(d) {
        return '<tr>' +
            '<td>Files: </td>' +
            '<td id="tb-rowext-pdfs-'+d.paper_id+'" class="d-flex flex-row">' +
                '<form id="tb-rowext-pdfs-form-'+d.paper_id+'" method="post" enctype="multipart/form-data">' +
                '<div class="custom-file mr-2" style="width: 200px;">' + 
                    '<input type="hidden" name="paper_id" value="'+d.paper_id+'">' + 
                    '<input type="file" name="files[]" multiple accept=".pdf" class="custom-file-input" id="tb-row-upload-'+d.paper_id+'">' +
                    '<label class="custom-file-label" for="tb-row-upload-'+d.paper_id+'">Choose file</label>' +
                '</div>' +
                '</form>' +
                '<button class="btn btn-primary mr-2" onclick="srv_pdfworker.update_pdfs(\''+d.paper_id+'\');">Upload</button>' + 
                
                '<div id="tb-rowext-pdfs-list-'+d.paper_id+'">' +
                this.__get_div_pdfs(d) +
                '</div>'

            '</td>' +
        '</tr>';
    },

    __get_tr_authors: function(d) {
        return '<tr>'+
            '<td>Authors:</td>'+
            '<td>'+d.authors+'</td>'+
        '</tr>';
    },

    __get_tr_info: function(d) {
        return '<tr>'+
            '<td>Information:</td>'+
            '<td id="tb-rowext-info-'+d.paper_id+'">' +
                this.__get_line_info(d) + 
            '</td>'+
        '</tr>';
    },

    __get_tr_abstract: function(d) {
        return '<tr>'+
            '<td>Abstract:</td>'+
            '<td id="tb-rowext-abstract-'+d.paper_id+'" class="pb-4">...</td>'+
            // '<td id="tb-rowext-abstract-'+d.paper_id+'">'+d.abstract+'</td>'+
        '</tr>';
    },

    __get_tr_tags: function(d) {
        return '<tr>'+
            '<td>Tags:</td>'+
            '<td class="d-flex flex-row">' + 
                // this.__get_dropdown_tags(d) + 
                '<div id="tb-rowext-tags-'+d.paper_id+'" class="tr-tags">' +
                    this.__get_line_tags(d) + 
                '</div>' +
            '</td>' + 
        '</tr>';
        // return '';
    },

    /**
     * Generate info line content for the information
     */
    __get_line_info: function(d) {
        return this.__get_span_rct_id(d) + ' | ' +
            this.__get_span_pmid(d) + ' | ' +
            '<span>' + d.journal + '</span> | ' + 
            this.__get_span_pub_date(d) + ' | ' +
            '<a href="javascript:void(0);" class="text-sm" onclick="tbjs_paperlist.sync_data_from_pubmed(\''+d.paper_id+'\', \''+d.pid+'\')"><i class="fa fa-sync"></i> Sync</a>';
    },

    /**
     * Generate span for the pub_date
     */
    __get_span_pub_date: function(d) {
        var html = '';
        if (d.pub_date == '') {
            html = [
                '<a href="javascript:void(0);" onclick="tbjs_paperlist.set_pub_date(\''+d.paper_id+'\', \'\')" title="Click to set the publication date">Add Publication Date</a>'
            ].join('');
        } else {
            html = [
                '<a href="javascript:void(0);" onclick="tbjs_paperlist.set_pub_date(\''+d.paper_id+'\', \''+d.pub_date+'\')" title="Click to update the publication date for this study">',
                    d.pub_date,
                '</a>'
            ].join('');
        }

        return html;
    },

    /**
     * Generate the div of pdfs
     */
    __get_div_pdfs: function(d) {
        var html_tags = [];

        if (!d.meta.hasOwnProperty('pdfs')) {
            html_tags = html_tags.join('');
            return html_tags;
        }

        // add the pdfs
        for (let i = 0; i < d.meta.pdfs.length; i++) {
            const pdf_meta = d.meta.pdfs[i];
            html_tags.push(
                '<div class="btn-group mr-2">' +
                '    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                '        <i class="far fa-file-pdf"></i> ' + pdf_meta.display_name +
                '    </button>' +
                '    <div class="dropdown-menu dropdown-menu-right">' +
                '        <a class="dropdown-item" href="javascript:void(0);" onclick="srv_pdfworker.view_pdf(\''+d.paper_id+'\', \''+pdf_meta.file_id+'\', \''+pdf_meta.folder+'\')"><i class="far fa-envelope-open"></i> View this PDF</a>' +
                '        <a class="dropdown-item" href="javascript:void(0);" onclick="srv_pdfworker.download_pdf(\''+d.paper_id+'\', \''+pdf_meta.file_id+'\', \''+pdf_meta.folder+'\', \'File-'+i+'.pdf\')"><i class="fa fa-download"></i> Download this PDF</a>' +
                '        <div class="dropdown-divider"></div>' +
                '        <a class="dropdown-item" href="javascript:void(0);" onclick="srv_pdfworker.remove_pdf(\''+d.paper_id+'\', \''+pdf_meta.file_id+'\', \''+pdf_meta.folder+'\')"><i class="far fa-trash-alt"></i> Delete this file</a>' +
                '    </div>' +
                '</div>'
            );
        }
        html_tags = html_tags.join('');
        return html_tags;
    },

    /**
     * Generate tags for in-title display
     */
    __get_div_tags: function(d) {
        var html_tags = [ '<div>' ];
        if (d.meta.hasOwnProperty('tags')) {
            for (var i = 0; i < d.meta.tags.length; i++) {
                var tag = d.meta.tags[i];
                html_tags.push(
                    '<span class="badge badge-tag ml-2">'+
                        '<i class="fa fa-tag"></i> ' + 
                        tag +
                    '</span>'
                    // '<div class="alert alert-secondary">'+tag+'</div>'
                )
            }
        }
        // the close of the spans
        html_tags.push('</div>');

        // convert to string
        html_tags = html_tags.join('');
    
        return html_tags;
    },

    /**
     * Generate a line of tags for user to label the study
     */
    __get_line_tags: function(d) {
        // for the tag names 
        var tag_names = [];
        // for indicating whether the tag is used for this study
        var tag_useds = [];

        // first, put the tags of this project in the list
        for (var i = 0; i < srv_screener.project.settings.tags.length; i++) {
            var tag = srv_screener.project.settings.tags[i];
            tag_names.push(tag);
            tag_useds.push(0);
        }

        // second, check the tags of this study
        if (d.meta.hasOwnProperty('tags')) {
            for (var i = 0; i < d.meta.tags.length; i++) {
                var used_tag = d.meta.tags[i];
                // check if this tag exists in the tag_names
                var idx = tag_names.indexOf(used_tag);

                if (idx < 0) {
                    // which means it is a new tag
                    tag_names.push(used_tag);
                    tag_useds.push(1);
                } else {
                    // which means it is a existing tag
                    tag_names[idx] = used_tag;
                    tag_useds[idx] = 1;
                }
            }
        }

        // third, generate the line of tags according to the analysis result
        var html_tags = ['<div>'];
        for (var i = 0; i < tag_names.length; i++) {
            var tag_name = tag_names[i];
            var tag_used = tag_useds[i];

            var class_tag = 'badge-tag-not-used';
            if (tag_used == 0) {
                // which means not used
            } else {
                // which means this tag is used for this study
                class_tag = 'badge-tag';
            }
            html_tags.push(
                '<span class="badge '+class_tag+' ml-2" onclick="tbjs_paperlist.toggle_tag(\''+d.paper_id+'\', \'' + tag_name + '\')">'+
                    '<i class="fa fa-tag"></i> ' + 
                    tag_name +
                '</span>'
            );
        }
        html_tags.push('</div>');

        // convert to string
        html_tags = html_tags.join('');

        return html_tags;
    },

    __get_dropdown_tags: function(d) {
        var html_options_tags = '';

        // create a option list of tags
        for (var i = 0; i < srv_screener.project.settings.tags.length; i++) {
            var tag = srv_screener.project.settings.tags[i];
            html_options_tags += '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.add_tag(\''+d.paper_id+'\', \'' + tag + '\')">' + tag + '</a>'
        }

        var html = [
            '<div class="dropdown">',
            '<button class="btn btn-default dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">',
                'Add Tag',
            '</button>',
            '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">',
                html_options_tags,
                // '<div class="dropdown-divider"></div>',
                // '<a class="dropdown-item" href="javascript:void();">Add a new tag</a>',
            '</div>',
            '</div>',
        ].join('');

        return html;
    },

    ///////////////////////////////////////////////////////////////////////////
    // the functions related to pdf
    ///////////////////////////////////////////////////////////////////////////

    

    ///////////////////////////////////////////////////////////////////////////
    // the functions related to screening
    ///////////////////////////////////////////////////////////////////////////

    add_tag: function(paper_id, tag) {
        srv_screener.add_tag(paper_id, tag, function(data) {
            var paper = data.paper;
            // update the tag list UI
            $('#tb-rowext-tags-' + paper.paper_id).html(
                tbjs_paperlist.__get_div_tags(paper)
            );

            // update the tb data list
            tbjs_paperlist.update_data_by_paper(paper);
        });
    },

    toggle_tag: function(paper_id, tag) {
        srv_screener.toggle_tag(paper_id, tag, function(data) {
            var paper = data.paper;
            // update the tag line UI
            $('#tb-rowext-tags-' + paper.paper_id).html(
                tbjs_paperlist.__get_line_tags(paper)
            );

            // update the tb data list
            tbjs_paperlist.update_data_by_paper(paper);
        });
    },
    
    remove_paper_from_tbjs: function(paper_id) {
        this.table.row($('#tb-row-' + paper_id))
            .remove()
            .draw(false);
    },

    exclude_by_tt: function(paper_id) {
        // exclude from server
        srv_screener.exclude_by_tt(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    exclude_by_ab: function(paper_id) {
        // exclude from server
        srv_screener.exclude_by_ab(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    exclude_by_ft: function(paper_id, reason) {
        if (typeof(reason) == 'undefined') {
            reason = $('#tb-row-exclude-reason-' + paper_id).val();
        }
        // exclude from server
        srv_screener.exclude_by_ft(paper_id, reason, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    include_in_sr: function(paper_id, reason) {
        // mark include in server
        srv_screener.include_in_sr(paper_id, reason, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    include_in_srma: function(paper_id) {
        // mark include in server
        srv_screener.include_in_srma(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    set_pub_date: function(paper_id, rct_id) {
        var txt = jarvis.prompt(
            'Please input the NCT number (e.g., 2021-03-01)', 
            rct_id
        );

        if (txt == null) {
            return;
        }
        txt = txt.trim();

        if (txt == '') {
            return;
        }

        srv_screener.set_pub_date(paper_id, txt, function(data) {
            // console.log('* set RCT_ID!', data);
            toast("Updated publication date [" + data.paper.pub_date + '] for ' + data.paper.seq_num);
            var paper = data.paper;

            // update the UI, well, just update the whole line of info
            $('#tb-rowext-info-' + paper.paper_id).html(
                tbjs_paperlist.__get_line_info(paper)
            );

            // update the tb data list
            tbjs_paperlist.update_data_by_paper(data.paper);
        });
    },

    set_rct_id: function(paper_id, rct_id) {
        var txt = jarvis.prompt('Please input the NCT number (e.g., NCT12345678)', rct_id);

        if (txt == null) {
            return;
        }
        txt = txt.trim();

        if (txt == '') {
            return;
        }

        srv_screener.set_rct_id(paper_id, txt, function(data) {
            // console.log('* set RCT_ID!', data);
            toast("Updated NCT Number [" + data.paper.meta.rct_id + '] for ' + data.paper.seq_num);
            var paper = data.paper;

            // update the UI, well, just update the whole line of info
            $('#tb-rowext-info-' + paper.paper_id).html(
                tbjs_paperlist.__get_line_info(paper)
            );

            // update the tb data list
            tbjs_paperlist.update_data_by_paper(data.paper);
        });
    },

    set_pmid: function(paper_id, pmid) {
        var txt = jarvis.prompt('Please input the new PubMed ID(e.g., 12345678)', pmid);

        if (txt == null) {
            return;
        }
        txt = txt.trim();

        if (txt == '') {
            return;
        }

        srv_screener.set_pmid(paper_id, txt, function(data) {

            if (data.success) {
                // console.log('* set RCT_ID!', data);
                toast("Updated PMID [" + data.paper.pid + '] for ' + data.paper.seq_num);
                var paper = data.paper;

                // update the UI, well, just update the whole line of info
                $('#tb-rowext-info-' + paper.paper_id).html(
                    tbjs_paperlist.__get_line_info(paper)
                );

                // update the tb data list
                tbjs_paperlist.update_data_by_paper(data.paper);

            } else {
                toast("Existed PMID [" + data.paper.pid + '] for another study [' + data.paper.seq_num + ']', 'error');
            }
        });
    },
    
    set_unscreened: function(paper_id) {
        // mark include in server
        srv_screener.set_unscreened(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },
    
    set_needchkft: function(paper_id) {
        // mark include in server
        srv_screener.set_needchkft(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    set_label_check_later: function(paper_id) {
        // mark include in server
        srv_screener.set_label_check_later(paper_id, function(data) {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    unset_label_check_later: function(paper_id) {
        // mark include in server
        srv_screener.unset_label_check_later(paper_id, function(data) {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    toggle_label_rct: function() {
        this.table.draw();
    },

    toggle_label_ckl: function() {
        this.table.draw();
    },

    toggle_tag_filter: function() {
        this.table.draw();
    },

    reset_tag_filter: function() {
        $('.tag-filter').prop('checked', '');
        this.toggle_tag_filter();
    },

    set_rct_feedback: function(paper_id, feedback) {
        srv_screener.set_rct_feedback(paper_id, feedback, function(data) {
            // update the UI
            for (var i = 0; i < data.papers.length; i++) {
                // get the value
                var d = data.papers[i];
                var usr_fb_val = d.meta.pred[0][srv_screener.ATTR_PRED_RCT_USR_FB]
                
                // update the UI
                var usr_fb = srv_screener.RCT_USER_FEEDBACK[usr_fb_val];
                $('#tb-row-rct-feedback-' + d.paper_id).html(usr_fb);

                // update the tb data list
                tbjs_paperlist.update_data_by_paper(d);
            }
        });
    },

    sort_by: function(col_idx, order) {
        this.table.order([col_idx, order]).draw()
    },

    sort_by_decision_reason: function() {
        this.sort_by(6, 'asc');
    },

    ///////////////////////////////////////////////////////////////////////////
    // Export
    ///////////////////////////////////////////////////////////////////////////
    show_export_panel: function() {
        // update the number
        var n_total = this.table.rows({search:'applied'}).data().length;
        $('#export_dialog_total_number').html(n_total);

        $( "#export_dialog" ).modal({
            width: 500
        });
    },

    export_current_table: function() {
        // show the panel first
        var n_total = this.table.rows({search:'applied'}).data().length;

        // collect the seq numbers
        var seq_nums = [];
        var data = this.table.rows({search:'applied'}).data();
        for (let i = 0; i < data.length; i++) {
            const d = data[i];
            seq_nums.push(d.seq_num);
        }

        // send the request to get 
        var project_id = Cookies.get('project_id');
        var format = $('input[name=export_format]:checked').val();

        // build a form
        srv_collector.export(project_id, format, seq_nums);
    },

    ///////////////////////////////////////////////////////////////////////////
    // Get data from PubMed
    ///////////////////////////////////////////////////////////////////////////
    sync_data_from_pubmed: function(paper_id, pmid) {
        toast('Getting data from PubMed to update this study ['+pmid+'] information ...');

        // show the data for this study
        pan_datasync.set_current_paper(
            tbjs_paperlist.papers[pmid]
        );

        // get the details from pubmed
        srv_pubmed.efetch([pmid], function(data) {
            srv_pubmed.ret = data;
            console.log('* efetch return', data);

            // convert the data to a paper object
            var paper_dict = srv_pubmed.parse_efetch_data(data);
            console.log('* paper_dict', paper_dict);
            if (Object.keys(paper_dict).length == 0) {
                toast('Not found in PubMed', 'warning');
                return;
            }

            // show the panel
            pan_datasync.show();

            srv_pubmed.paper_dict = paper_dict;

            // get the only one paper in the dictionary
            var pmid = Object.keys(paper_dict)[0];
            var pubmed_paper = paper_dict[pmid];

            // set the data
            pan_datasync.set_pubmed_paper(
                pubmed_paper
            );

            toast('Parsed the data from PubMed successfully!');
        });
    }
};


var pan_iecriteria = {
    vpp_id: '#pan_iecriteria',
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                criterias: srv_screener.project.settings.criterias,
                is_hide: true
            },
            methods: {
                toggle: function() {
                    pan_iecriteria.toggle();
                }
            }
        });
    },

    toggle: function() {
        this.vpp.$data.is_hide = !this.vpp.$data.is_hide;
    }
};


var pan_pdfviewer = {
    vpp_id: '#pan_pdfviewer',
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                is_hide: true
            },
            methods: {
                toggle: function() {
                    pan_pdfviewer.toggle();
                }
            }
        });
    },

    toggle: function() {
        this.vpp.$data.is_hide = !this.vpp.$data.is_hide;
    },

    hide: function() {
        this.vpp.$data.is_hide = true;
    },

    show: function() {
        this.vpp.$data.is_hide = false;

        // resize
        var w = $('#tbjs_paperlist_tools').width();
        var h = $(window).height() - 25;

        $(this.vpp_id).css('width', w + 'px');
        $(this.vpp_id).css('height', h + 'px');

        // relocate
        $(this.vpp_id).css('left', '330px');

        // resize the iframe
        $('#ifr_pdfviewer').height(h - 52);
    },

    update_toolbar: function(paper_id) {
        $('#pan_pdfviewer_btns').html(
            tbjs_paperlist._get_pdfview_toolbar({paper_id:paper_id})
        );
    },

    load_pdf: function(folder, file_id) {
        var pdf_url = "/pdfworker/pdf/" + folder + "/" + file_id + '.pdf';
        document.getElementById("ifr_pdfviewer").contentWindow.PDFViewerApplication.open(pdf_url);
    }
};


var pan_datasync = {
    vpp_id: '#pan_datasync',
    vpp: null,

    init: function() {
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                is_hide: true,
                is_btn_disabled: false,
                current_paper: null,
                pubmed_paper: null,
                new_data: null
            },
            methods: {
                toggle: function() {
                    pan_datasync.toggle();
                },

                update_paper_detail: function() {
                    // first, disable button
                    this.is_btn_disabled = true;
                }
            }
        });
    },

    set_current_paper: function(paper) {
        this.vpp.current_paper = paper;
    },

    set_pubmed_paper: function(paper) {
        this.vpp.pubmed_paper = paper;
        
        // update content
        this.vpp.new_data = paper 
        this.vpp.new_data.authors =  paper.authors.join('; ');
    },

    toggle: function() {
        this.vpp.$data.is_hide = !this.vpp.$data.is_hide;
    },

    hide: function() {
        this.vpp.$data.is_hide = true;
    },

    show: function() {
        this.vpp.$data.is_hide = false;
        this.vpp.$data.is_btn_disabled = false;

        // resize
        this.resize();

        // relocate
        $(this.vpp_id).css('left', '330px');
    },

    resize: function() {
        // resize
        var w = $('#tbjs_paperlist_tools').width();
        var h = $(window).height() - 25;
        h = 620;

        $(this.vpp_id).css('width', w);
        $(this.vpp_id).css('height', h);
    }
};


var srv_pdfworker = {
    api_url: {
        upload_pdfs: '[[ url_for("pdfworker.upload_pdfs") ]]',
        remove_pdf: '[[ url_for("pdfworker.remove_pdf") ]]',
    },
    ///////////////////////////////////////////////////////////////////////////
    // the functions related to pdf
    ///////////////////////////////////////////////////////////////////////////

    update_pdfs: function(paper_id) {
        // check the form files
        var n_files = $('#tb-row-upload-' + paper_id).prop('files').length;

        if (n_files < 1) {
            return;
        }

        // get the pdf form data
        var form_data = new FormData(
            $('#tb-rowext-pdfs-form-' + paper_id)[0]
        );

        // send the update
        $.ajax({
            type: 'POST',
            url: srv_pdfworker.api_url.upload_pdfs,
            data: form_data,
            contentType: false,
            cache: false,
            processData: false,
            success: function(data) {
                
                console.log(data);

                var paper = data.paper;

                // update hte pdf list UI
                $('#tb-rowext-pdfs-list-' + paper.paper_id).html(
                    tbjs_paperlist.__get_div_pdfs(paper)
                );

                // update the tb data list
                tbjs_paperlist.update_data_by_paper(paper);
            },
        });
    },

    view_pdf: function(paper_id, file_id, folder) {
        // update the toolbar
        pan_pdfviewer.update_toolbar(paper_id);

        // show the PDF panel
        pan_pdfviewer.show();

        // load the PDF
        pan_pdfviewer.load_pdf(folder, file_id);
    },

    download_pdf: function(paper_id, file_id, folder, display_name) {
        var url = '/pdfworker/download_pdf/' + folder + '/' + file_id;
        url += "?fn=" + encodeURI(display_name);
        window.open(url);
    },

    remove_pdf: function(paper_id, file_id, folder) {
        var ret = window.confirm('Deleted files could NOT be recovered. Are you sure to continue?');

        if (!ret) {
            return;
        }

        $.post(
            srv_pdfworker.api_url.remove_pdf,
            {
                paper_id: paper_id,
                pdf_metas: JSON.stringify([{
                    folder: folder,
                    file_id: file_id
                }])
            },
            function(data) {
                console.log(data);

                var paper = data.paper;

                // update hte pdf list UI
                $('#tb-rowext-pdfs-list-' + paper.paper_id).html(
                    tbjs_paperlist.__get_div_pdfs(paper)
                );

                // update the tb data list
                tbjs_paperlist.update_data_by_paper(paper);
            }, 'json'
        );
    }
};


var srv_collector = {

    api_url: {
        export: "[[ url_for('collector.export') ]]"
    },

    export: function(project_id, format, seq_nums) {
        this.submit_form(
            this.api_url.export,
            {
                project_id: project_id,
                seq_nums: seq_nums.join(','),
                format: format
            },
            'POST'
        );
    },

    submit_form: function(path, params, method) {
        method = method || "POST";

        var form = document.createElement("form");

        form.setAttribute("target", '_blank');
        form.setAttribute("method", method);
        form.setAttribute("action", path);

        for(var key in params) {
            if(params.hasOwnProperty(key)) {
                var hiddenField = document.createElement("input");
                hiddenField.setAttribute("type", "hidden");
                hiddenField.setAttribute("name", key);
                hiddenField.setAttribute("value", params[key]);

                form.appendChild(hiddenField);
            }
        }

        document.body.appendChild(form);
        form.submit();
    }
};


var srv_extractor = {
    api_url: {
        sort_rct_seq: "[[ url_for('extractor.sort_rct_seq') ]]"
    },

    sort_rct_seq: function(callback) {
        $.ajax({
            url: this.api_url.sort_rct_seq,
            type: 'get',
            dataType: 'json',
            data: { rnd: Math.random() },
            success: callback,
            error: function(data) {
                toast('System error when updating the studies, please try later.', 'error');
            }
        })
    }
}


var jarvis = {
    create_src_url: function(d) {
        return 'https://pubmed.ncbi.nlm.nih.gov/' + d.pid;
    },

    project: [[ project_json_str|safe ]],

    init: function () {
        tbjs_paperlist.init();

        // load stats
        ui_category_stat.load();

        // load unscreened papers by default
        tbjs_paperlist.load_by_stage(srv_screener.STAGE_UNSCREENED);

        // load the Inc/Exc criteria panel
        pan_iecriteria.init();

        // load the pdf workers
        pan_pdfviewer.init();

        // load the sync panel
        pan_datasync.init();

        // bind resize event
        this.bind_resize_event();
    },

    sort_rct_seq: function() {
        var txt = $('#btn_update_original_followup').html();
        $('#btn_update_original_followup')
            .attr('disabled', 'disabled')
            .attr('text', txt)
            .html('<i class="fas fa-spinner fa-pulse"></i> Updating ...');
        srv_extractor.sort_rct_seq(function(data) {
            toast('Finished updating the original/follow-up!');
            $('#btn_update_original_followup')
                .attr('disabled', null)
                .attr('text', txt)
                .html(function(){ return $(this).attr('text'); });

            tbjs_paperlist.load();
        });
    },

    prompt: function(text, value) {
        return window.prompt(text, value);
    },

    confirm: function(text) {
        return window.confirm(text);
    },

    bind_resize_event: function() {
        $(window).on('resize', function(){
            // pan_outcomes.resize();
        });
    }
};

$(document).ready(function () {
    jarvis.init();
})
</script>
{% endblock %}