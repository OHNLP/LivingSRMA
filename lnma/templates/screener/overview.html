{% extends '_layout_adminlte.html' %}

{% block title %}
Screener Overview
{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">

<style>
#tbjs_paperlist {
    width: 100%;
}
td.details-control {
    cursor: pointer;
}
tr.shown td.details-control {
    cursor: pointer;
}
.col-title {
    cursor: pointer;
}
.col-seq {
    text-indent: .5em;
}
/* for highlight */
.keyword-exclusion {
    color: rgb(250, 89, 89);
    background: rgb(255, 205, 205);
    /* padding: 2px 3px; */
    /* border-radius: 3px; */
    padding: 0;
    margin: 0;
    cursor: pointer;
}
.keyword-inclusion {
    color: rgb(1, 56, 1);
    background: rgb(223, 245, 223);
    /* padding: 2px 3px; */
    /* border-radius: 3px; */
    padding: 0;
    margin: 0;
    cursor: pointer;
}
.search-highlight {
    text-decoration: underline;
    background-color: rgb(230, 195, 132);
}
</style>
{% endblock %}

{% block page_name %}
<i class="fas fa-map-signs"></i>
Screener Overview
{% endblock %}

{% block content %}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div id="ui_category_stat" style="width: 220px;">
                <h5>
                    <i class="far fa-file-alt"></i>
                    All Papers
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('all_of_them')">
                        All papers
                        <span class="badge badge-primary badge-pill">{{ stat.all_of_them }}</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('unscreened')">
                        Unscreened papers
                        <span class="badge badge-primary badge-pill">{{ stat.unscreened }}</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('decided')">
                        Decided papers
                        <span class="badge badge-primary badge-pill">{{ stat.decided }}</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Further Check
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('passed_title_not_fulltext')">
                        Full Text Review
                        <span class="badge badge-secondary badge-pill">{{ stat.passed_title_not_fulltext }}</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Included Papers
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('included_sr')">
                        Included in SR
                        <span class="badge badge-secondary badge-pill">{{ stat.included_sr }}</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('included_srma')">
                        Included in SR and MA
                        <span class="badge badge-secondary badge-pill">{{ stat.included_srma }}</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Excluded Papers
                </h5>
                <div class="list-group">
                    <!-- <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_rct_classifier')">
                        By RCT Classifier
                        <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_rct_classifier }}</span>
                    </button> -->
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_title')">
                        By Title
                        <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_title }}</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_abstract')">
                        By Abstract
                        <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_abstract }}</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center" v-on:click="show_stage('excluded_by_fulltext')">
                        By Full Text
                        <span class="badge badge-secondary badge-pill">{{ stat.excluded_by_fulltext }}</span>
                    </button>
                </div>
            </div>
            <!-- / left pane -->

            <div style="width: calc(100% - 230px); margin-left: 10px;">
                <h5>
                    <i class="far fa-file-alt"></i>
                    Paper List | 
                    <span id="tbjs_paperlist_title"></span>
                </h5>

                <table id="tbjs_paperlist" class="display compact hover" style="width: 100%;">

                </table>
            </div>
            <!-- / right pane -->
        </div>
    </div>
</div>
<!-- /.timeline -->

</div>
</div>
</div>


{% endblock %}

{% block active_nav_link %}screener-overview{% endblock %}

{% block script %}
<script src="/static/lib/d3/d3.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/jquery.mark.min.js"></script>
<script src="https://cdn.datatables.net/plug-ins/1.10.13/features/mark.js/datatables.mark.js"></script>
<script>

var srv_screener = {

    api_url: {
        get_stat: '[[ url_for("screener.get_stat") ]]',
        get_papers_by_stage: '[[ url_for("screener.get_papers_by_stage") ]]',

        // for screening
        set_unscreened: '[[ url_for("screener.sspr_set_papers_unscreened") ]]',
        set_needchkft: '[[ url_for("screener.sspr_set_papers_needchkft") ]]',
        exclude_ta: '[[ url_for("screener.sspr_exclude_papers_ta") ]]',
        exclude_tt: '[[ url_for("screener.sspr_exclude_papers_tt") ]]',
        exclude_ab: '[[ url_for("screener.sspr_exclude_papers_ab") ]]',
        exclude_ft: '[[ url_for("screener.sspr_exclude_papers_ft") ]]',
        include_sr: '[[ url_for("screener.sspr_include_papers_sr") ]]',
        include_srma: '[[ url_for("screener.sspr_include_papers_srma") ]]',
    },

    stage: {
        // view stage
        all_of_them: { title: 'All papers' },
        decided: { title: 'Decided papers' },

        // main stages
        unscreened: { title: 'Unscreened papers' },
        passed_title_not_fulltext: { title: 'Full-text review' },
        excluded_by_title: { title: 'Excluded after checking title' },
        excluded_by_abstract: { title: 'Excluded after checking abstract' },
        excluded_by_fulltext: { title: 'Excluded after checking fulltext' },
        included_sr: { title: 'Included in SR' },
        included_srma: { title: 'Included in Both SR and MA' },
        
        // extended stages
        included_only_sr: { title: 'Included only in SR' },
        excluded_by_title_abstract: { title: 'Excluded after checking title and abstract' },
        excluded_by_rct_classifier: { title: 'Excluded by RCT classifier' },
    },

    // current stages
    STAGE_UNSCREENED: 'unscreened',
    STAGE_EXCLUDED_BY_TITLE: 'excluded_by_title',
    STAGE_EXCLUDED_BY_ABSTRACT: 'excluded_by_abstract',
    STAGE_EXCLUDED_BY_FULLTEXT: 'excluded_by_fulltext',
    STAGE_INCLUDED_SR: 'included_sr',
    STAGE_INCLUDED_SRMA: 'included_srma',
    
    // Not used stages
    // STAGE_INCLUDED_ONLY_SR: 'included_only_sr',
    STAGE_EXCLUDED_BY_TITLE_ABSTRACT: 'excluded_by_title_abstract',
    STAGE_EXCLUDED_BY_RCT_CLASSIFIER: 'excluded_by_rct_classifier',

    // just for display purpose, not a real stage
    STAGE_ALL_OF_THEM: 'all_of_them',
    STAGE_DECIDED: 'decided',
    STAGE_UNKNOWN: 'unknown',

    // stage states
    ss: {
        rs: {
            e1:  { name: 'Duplicate record(s)', color: 'grey' },
            e2:  { name: 'Excluded by title', color: 'grey' },
            e21: { name: 'Excluded by RCT classifier', color: 'grey' },
            e22: { name: 'Excluded by abstract', color: 'grey' },
            e3:  { name: 'Excluded by full-text review', color: 'grey' },
            e4:  { name: 'Excluded due to study update', color: 'grey' },

            f1:  { name: 'Included in SR', color: '#007bff' },
            f3:  { name: 'Included in SR and MA', color: 'green' },

            na:  { name: 'Not decided', color: 'white' }
        }
    },

    get_stage: function(paper) {
        if (paper.ss_rs == 'na' && paper.ss_pr == 'na') {
            return this.STAGE_UNSCREENED;
        } else if (paper.ss_rs == 'f1') {
            return this.STAGE_INCLUDED_SR;
        } else if (paper.ss_rs == 'f3') {
            return this.STAGE_INCLUDED_SRMA;
        } else if (paper.ss_rs == 'e2') {
            return this.STAGE_EXCLUDED_BY_TITLE;
        } else if (paper.ss_rs == 'e22') {
            return this.STAGE_EXCLUDED_BY_ABSTRACT;
        } else if (paper.ss_rs == 'e3') {
            return this.STAGE_EXCLUDED_BY_FULLTEXT;
        } else {
            return this.STAGE_UNKNOWN;
        }
    },

    get_stat: function(callback) {
        var url = this.api_url.get_stat;
        var project_id = Cookies.get('project_id');

        $.get(
            url,
            {project_id: project_id, ver: Math.random()},
            callback, 
            'json'
        );
    },

    get_papers: function(stage, callback) {
        var project_id = Cookies.get('project_id');
        var url = this.api_url.get_papers_by_stage;

        $.get(
            url,
            {project_id: project_id, stage: stage},
            callback, 
            'json'
        );
    },

    ///////////////////////////////////////////////////////////////////////////
    // the functions related to screening
    ///////////////////////////////////////////////////////////////////////////

    set_unscreened: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.set_unscreened;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },

    set_needchkft: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.set_needchkft;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },

    exclude_by_tt: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.exclude_tt;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },

    exclude_by_ab: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.exclude_ab;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },

    exclude_by_ft: function(paper_id, reason, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.exclude_ft;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id, reason: reason},
            callback,
            'json'
        );
    },

    include_in_sr: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.include_sr;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },

    include_in_srma: function(paper_id, callback) {
        // send request to backend
        var project_id = Cookies.get('project_id');
        var paper_ids = [paper_id].join(',');
        
        var url = this.api_url.include_srma;
        $.post(
            url,
            {paper_ids: paper_ids, project_id: project_id},
            callback,
            'json'
        );
    },
};

var ui_category_stat = {
    vpp_id: '#ui_category_stat',
    vpp: null,

    load: function() {
        // load data from backend by srv_screener
        srv_screener.get_stat(function(data){
            ui_category_stat.init(data.stat);
        });
    },

    init: function(data) {
        this.data = data;
        console.log('* initing ui_category_stat', data);
        this.vpp = new Vue({
            el: this.vpp_id,
            data: {
                stat: data
            },
            methods: {
                show_stage: function(stage) {
                    console.log('* show ' + stage);

                    // update paper list
                    tbjs_paperlist.load_by_stage(stage);
                }
            }
        });        
    },

    update: function() {
        srv_screener.get_stat(function(data){
            ui_category_stat.vpp.stat = data.stat;
        });
    }
};


var tbjs_paperlist = {
    table_id: '#tbjs_paperlist',
    table: null,

    cfg: {
        number_of_rows: 10
    },

    // by default, show unscreened stage
    stage: srv_screener.STAGE_UNSCREENED,

    // keywords for highlight
    keywords: {
        inclusion: [
            'immune check point inhibitor',
            'ICI',
            'atezolizumab',
            'avelumab',
            'cemiplimab',
            'durvalumab',
            'ipilimumab',
            'nivolumab',
            'pembrolizumab',
            'tremelimumab',
            'PD1',
            'PDL1',
            'CTLA4',
            'phase 2',
            'phase2',
            'phase 3',
            'phase3'
        ],
        exclusion: [
            'animals',
            'phase1',
            'phase 1',
            'non-randomized',
            'nonrandomized',
            'systematic review',
            'meta-analysis',
            'meta analysis'
        ]
    },

    columns: [
        {
            title: '#',
            className: 'col-seq',
            orderable: true,
            data: 'seq_num'
        },
        {
            title: '',
            width: 25,
            className: 'details-control dt-center',
            orderable: false,
            data: 'first_column'
        },
        { 
            title: 'Date', 
            width: 80,
            data: 'date_created_norm' 
        },
        { 
            title: 'Labels', 
            width: 50,
            data: 'labels' 
        },
        { 
            title: 'Title', 
            data: 'title',
            className: 'col-title',
        },
        {
            title: '',
            className: 'operate-control',
            width: 190,
            orderable: false,
            data: 'basic_actions'
        }
    ],

    sample: [
        { pid: '123456', authors: 'B, X, C and E', date: '2020-10-01', title: 'A title here', journal: 'JAMA', abstract: 'This is the abstract content' },
        { pid: '123457', authors: 'A, B, U and E', date: '2020-10-01', title: 'A title here', journal: 'NEJM', abstract: 'This is the abstract content' },
        { pid: '123458', authors: 'D, B, N and E', date: '2020-10-01', title: 'A title here', journal: 'Lancet', abstract: 'This is the abstract content' }
    ],

    init: function() {
        // init the datatable obj
        this.table = $(this.table_id).DataTable({
            responsive: true,
            autoWidth: false,
            pageLength: this.cfg.number_of_rows,
            data: [],
            columns: this.columns,
            order: [
                [1, 'desc']
            ],

            // bind the row attributes
            createdRow: function(row, data, dataIndex) {
                $(row).attr('id', 'tb-row-' + data.paper_id);
            },

            // show the color for highlight
            mark: {
                element: 'span',
                className: 'search-highlight'
            }
        });

        // update the open/close details event
        $(this.table_id + ' tbody').on('click', 'td.details-control', function() {
            var tr = $(this).closest('tr');
            var row = tbjs_paperlist.table.row( tr );
    
            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                $(this).html('<i class="fa fa-plus"></i>')
            }
            else {
                // Open this row
                var row_html = tbjs_paperlist._get_expand_html_by_stage(row.data());
                row.child(row_html).show();
                tr.addClass('shown');
                $(this).html('<i class="fa fa-minus"></i>')

                // trigger the highlight
                tbjs_paperlist._mark_element('#tb-rowext-abstract-' + row.data().paper_id);
            }
        });

        // update the click title event
        $(this.table_id + ' tbody').on('click', 'td.col-title', function() {
            var tr = $(this).closest('tr');
            var row = tbjs_paperlist.table.row( tr );
    
            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                tr.find('td.details-control').html('<i class="fa fa-plus"></i>')
            }
            else {
                // Open this row
                var row_html = tbjs_paperlist._get_expand_html_by_stage(row.data());
                row.child(row_html).show();
                tr.addClass('shown');
                tr.find('td.details-control').html('<i class="fa fa-minus"></i>')

                // trigger the highlight
                tbjs_paperlist._mark_element('#tb-rowext-abstract-' + row.data().paper_id);
            }
        });


        // add highlight event to the title
        this.table.on('draw', function () {
            console.log( 'Redraw occurred at: '+new Date().getTime() );

            // in the title column
            // mark the inclusion keywords
            $(".col-title").mark(
                tbjs_paperlist.keywords.inclusion,
                {
                    className: 'keyword-inclusion',
                    separateWordSearch: false
                }
            );

            // mark the exclusion keywords
            $(".col-title").mark(
                tbjs_paperlist.keywords.exclusion,
                {
                    className: 'keyword-exclusion',
                    separateWordSearch: false
                }
            );
        });
    },

    _mark_element: function(elem) {
        // mark the inclusion keywords
        $(elem).mark(
            tbjs_paperlist.keywords.inclusion,
            {
                className: 'keyword-inclusion',
                separateWordSearch: false
            }
        );

        // mark the exclusion keywords
        $(elem).mark(
            tbjs_paperlist.keywords.exclusion,
            {
                className: 'keyword-exclusion',
                separateWordSearch: false
            }
        );
    },

    load: function() {
        srv_screener.get_papers(
            srv_screener.stage.STAGE_UNSCREENED,
            function(data) {
                tbjs_paperlist.update(data.papers);
            }
        );
    },

    load_by_stage: function(stage) {
        // set stage
        this.stage = stage;

        // update header title
        $('#tbjs_paperlist_title').html(
            srv_screener.stage[stage].title
        );

        // get data
        srv_screener.get_papers(
            stage,
            function(data) {
                tbjs_paperlist.update(data.papers);
            }
        );
    },

    update: function(data) {
        // add more columns to data
        this.update_data_attrs(data);
        
        // remove the old data
        this.table.clear();

        // put new data
        this.table.rows.add(data);

        // render
        this.table.draw();
    },

    update_data_attrs: function(data) {
        for (var i = 0; i < data.length; i++) {
            var d = data[i];

            // add the pred_is_rct column
            d['first_column'] = this._update_attr_first_column(d);

            // add the pred_is_rct column
            d['labels'] = this._update_attr_labels(d);
            
            // add the date_created_norm column
            d['date_created_norm'] = this._update_attr_date_created_norm(d);
            
            // add the date_published_norm column
            d['date_published_norm'] = this._update_attr_date_published_norm(d);

            // add the basic buttons column
            d['basic_actions'] = this._get_basic_actions_by_stage(d);
        }

        this.data = data;
    },

    update_data_columns: function(stage) {

    },

    ///////////////////////////////////////////////////////////////////////////
    // Update the data attributes
    ///////////////////////////////////////////////////////////////////////////
    _update_attr_first_column: function(d) {
        return '<i class="fa fa-plus"></i>';
    },

    _update_attr_labels: function(d) {
        var label_rct = '<span class="badge badge-pill badge-info"><i class="fa fa-bong"></i> RCT</span>';

        // create the return string
        var ret = '';
        
        if (d.meta.pred[0].is_rct) {
            ret += label_rct;
        } else {
            ret += '-';
        }

        return ret;
    },

    _update_attr_date_created_norm: function(d) {
        var ret = '';
        ret = dayjs(d.date_created).format('YYYY-MM-DD');
        return ret;
    },

    _update_attr_date_published_norm: function(d) {
        var ret = d.pub_date;
        try {
            ret = dayjs(d.pub_date).format('YYYY-MM-DD');
        } catch {
            ret = ' - ';
        }

        return ret;
    },

    ///////////////////////////////////////////////////////////////////////////
    // Get the basic actions column
    ///////////////////////////////////////////////////////////////////////////

    _get_basic_actions_by_stage: function(d) {
        var stage = this.stage;
        var func_name = '_get_basic_actions_by_stage_' + stage;
        var html = this[func_name](d);
        return html;
    },

    _get_basic_actions_by_stage_all_of_them: function(d) {
        var html = '';
        return html;
    },

    _get_basic_actions_by_stage_unscreened: function(d) {
        var html = '';
        html = '<button class="btn btn-danger btn-sm" title="Exclude this study by title" onclick="tbjs_paperlist.exclude_by_tt(\''+d.paper_id+'\')">Exclude By Title</button>';

        return html;
    },
    
    _get_basic_actions_by_stage_passed_title_not_fulltext: function(d) {
        var html = '';
        return html;
    },

    _get_basic_actions_by_stage_included_sr: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_included_srma: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_title: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_abstract: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_excluded_by_fulltext: function(d) {
        return this._get_basic_actions_by_stage_decided(d);
    },

    _get_basic_actions_by_stage_decided: function(d) {
        var html = '';

        // the decision date
        html +=  '<small>' + d.ss_ex.date_decided + '</small><br>';

        // the main decision
        html += '<span style="color: ' + srv_screener.ss.rs[d.ss_rs].color + ';">' + srv_screener.ss.rs[d.ss_rs].name + '</span>';

        // the reason
        if (d.ss_ex.reason != '') {
            html += '<br>' + d.ss_ex.reason;
        }

        return html;
    },

    ///////////////////////////////////////////////////////////////////////////
    // Get the expand HTML content
    ///////////////////////////////////////////////////////////////////////////

    _get_expand_html_by_stage: function(d) {
        var stage = this.stage;
        var func_name = '_get_expand_html_by_stage_' + stage;
        var func = this[func_name];

        // the html is always a table
        // content of this table is decided by the stage
        // and for each stage, the main differences are the buttons
        var html = '<table id="tb-rowext-'+d.paper_id+'" cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
            this[func_name](d) +
        '</table>'
        return html;
    },

    _get_expand_html_by_stage_all_of_them: function(d) {
        var html = 
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },
    
    _get_expand_html_by_stage_unscreened: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-secondary btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Proceed to Full-Text Review</button> '+
                '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\')">Include in SR</button> '+
                
                '<button class="btn btn-danger btn-sm" onclick="tbjs_paperlist.exclude_by_ab(\''+d.paper_id+'\')">Exclude by Abstract</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },
    
    _get_expand_html_by_stage_passed_title_not_fulltext: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td class="d-flex flex-row">'+
                '<div class="mr-2"><button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\')">Include in SR</button></div>'+
                this.__get_select_fulltext_exclusion_reasons(d) +
                '<div class="ml-2"><button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button></div>'+
                '<div class="ml-2"><button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button></div>'+
                '</td>'+
            '</tr>'+

            '<tr>' +
                '<td>Files: </td>' +
                '<td class="d-flex flex-row">' +                        
                    '<div class="custom-file mr-2" style="width: 200px;">' + 
                        '<input type="file" class="custom-file-input" id="tb-row-upload-'+d.paper_id+'">' +
                        '<label class="custom-file-label" for="tb-row-upload-'+d.paper_id+'">Choose file</label>' +
                    '</div>' +
                    '<button class="btn btn-primary mr-2">Upload</button>' + 

                    '<div class="btn-group mr-2">' +
                    '    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                    '        <i class="far fa-file-pdf"></i> The-file-name-of-the-uploaded-file.pdf' +
                    '    </button>' +
                    '    <div class="dropdown-menu dropdown-menu-right">' +
                    '        <a class="dropdown-item" href="javascript:void(0);">View PDF</a>' +
                    '        <a class="dropdown-item" href="javascript:void(0);">Download</a>' +
                    '        <div class="dropdown-divider"></div>' +
                    '        <a class="dropdown-item" href="javascript:void(0);"><i class="far fa-trash-alt"></i> Delete this file</a>' +
                    '    </div>' +
                    '</div>' +

                    '<div class="btn-group mr-2">' +
                    '    <button type="button" class="btn btn-secondary dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">' +
                    '        <i class="far fa-file-pdf"></i> Another-uploaded-file.pdf' +
                    '    </button>' +
                    '    <div class="dropdown-menu dropdown-menu-right">' +
                    '        <a class="dropdown-item" href="javascript:void(0);">View PDF</a>' +
                    '        <a class="dropdown-item" href="javascript:void(0);">Download</a>' +
                    '        <div class="dropdown-divider"></div>' +
                    '        <a class="dropdown-item" href="javascript:void(0);"><i class="far fa-trash-alt"></i> Delete this file</a>' +
                    '    </div>' +
                    '</div>' +

                '</td>' +
            '</tr>' +
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_included_sr: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-primary btn-sm" onclick="tbjs_paperlist.include_in_srma(\''+d.paper_id+'\')">Include in MA</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_included_srma: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.include_in_sr(\''+d.paper_id+'\')">Send Back to SR</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_title: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_abstract: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_excluded_by_fulltext: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_needchkft(\''+d.paper_id+'\')">Send Back to Full-Text Review</button> '+
                '<button class="btn btn-warning btn-sm" onclick="tbjs_paperlist.set_unscreened(\''+d.paper_id+'\')">Send Back to Unscreened</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm" onclick="tbjs_paperlist.remove_paper_from_tbjs(\''+d.paper_id+'\')">Check Later</button>'+
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    _get_expand_html_by_stage_decided: function(d) {
        var html = 
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '' +
                '</td>'+
            '</tr>'+
            this.__get_tr_info(d) + 
            this.__get_tr_authors(d) +
            this.__get_tr_abstract(d);

        return html;
    },

    ///////////////////////////////////////////////////////////////////////////
    // HTML fragment makers
    ///////////////////////////////////////////////////////////////////////////

    __get_select_fulltext_exclusion_reasons: function(d) {
        var html = [
            '<div class="dropdown">',
            '<button class="btn btn-danger dropdown-toggle btn-sm" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">',
                'Exclude by Full-Text Review',
            '</button>',
            '<div class="dropdown-menu" aria-labelledby="dropdownMenuButton">',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Conference Abstracts\')">Conference Abstracts</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Editorials, Commentaries, Case Reports\')">Editorials, Commentaries, Case Reports</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Non-Randomized Studies\')">Non-Randomized Studies</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Cohort Studies\')">Cohort Studies</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Narrative Reviews\')">Narrative Reviews</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Systematic Reviews and Meta-Analyses\')">Systematic Reviews and Meta-Analyses</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'Subgroup Analysis/Exploratory Analysis/Sub-Study\')">Subgroup Analysis/Exploratory Analysis/Sub-Study</a>',
                '<a class="dropdown-item" href="javascript:void(0);" onclick="tbjs_paperlist.exclude_by_ft(\''+d.paper_id+'\', \'ICI in the control arm\')">ICI in the control arm</a>',
 
                '<div class="dropdown-divider"></div>',
                '<a class="dropdown-item" href="javascript:void();">Add a new reason</a>',
            '</div>',
            '</div>',
        ].join('');
        return html;
    },

    __get_tr_authors: function(d) {
        return '<tr>'+
            '<td>Authors:</td>'+
            '<td>'+d.authors+'</td>'+
        '</tr>';
    },

    __get_tr_info: function(d) {
        return '<tr>'+
            '<td>Information:</td>'+
            '<td id="tb-rowext-info-'+d.paper_id+'">' +
                '<a target="_blank" href="' + jarvis.create_src_url(d) + '"><span>' + d.pid_type + ': ' + d.pid + '</span></a> | ' +
                '<span>' + d.journal + '</span> | ' + 
                '<span>' + d.pub_date + '</span>' + 
            '</td>'+
        '</tr>';
    },

    __get_tr_abstract: function(d) {
        return '<tr>'+
            '<td>Abstract:</td>'+
            '<td id="tb-rowext-abstract-'+d.paper_id+'">'+d.abstract+'</td>'+
        '</tr>';
    },

    ///////////////////////////////////////////////////////////////////////////
    // the functions related to screening
    ///////////////////////////////////////////////////////////////////////////
    remove_paper_from_tbjs: function(paper_id) {
        this.table.row($('#tb-row-' + paper_id))
            .remove()
            .draw();
    },

    exclude_by_tt: function(paper_id) {
        // exclude from server
        srv_screener.exclude_by_tt(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    exclude_by_ab: function(paper_id) {
        // exclude from server
        srv_screener.exclude_by_ab(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    exclude_by_ft: function(paper_id, reason) {
        // exclude from server
        srv_screener.exclude_by_ft(paper_id, reason, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    include_in_sr: function(paper_id) {
        // mark include in server
        srv_screener.include_in_sr(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },

    include_in_srma: function(paper_id) {
        // mark include in server
        srv_screener.include_in_srma(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },
    
    set_unscreened: function(paper_id) {
        // mark include in server
        srv_screener.set_unscreened(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    },
    
    set_needchkft: function(paper_id) {
        // mark include in server
        srv_screener.set_needchkft(paper_id, function() {
            // update the count number
            ui_category_stat.update();
        });

        // remove from the list
        this.remove_paper_from_tbjs(paper_id);
    }
};

var jarvis = {
    create_src_url: function(d) {
        return 'https://pubmed.ncbi.nlm.nih.gov/' + d.pid;
    },

    init: function () {
        tbjs_paperlist.init();

        // load stats
        ui_category_stat.load();

        // load unscreened papers by default
        tbjs_paperlist.load_by_stage(srv_screener.STAGE_UNSCREENED);
    },
};

$(document).ready(function () {
    jarvis.init();
})
</script>
{% endblock %}