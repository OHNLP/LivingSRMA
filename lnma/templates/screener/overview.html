{% extends '_layout_adminlte.html' %}

{% block title %}
Screener Overview
{% endblock %}

{% block style %}
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/jquery.dataTables.min.css">

<style>
#tbjs_paperlist {
    width: 100%;
}
td.details-control {
    cursor: pointer;
}
tr.shown td.details-control {
    cursor: pointer;
}
</style>
{% endblock %}

{% block page_name %}
<i class="fas fa-map-signs"></i>
Screener Overview
{% endblock %}

{% block content %}

<div class="content">
    <div class="container-fluid">
        <div class="row">
            <div style="width: 220px;">
                <h5>
                    <i class="far fa-file-alt"></i>
                    All Papers
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        All papers
                        <span class="badge badge-primary badge-pill">2000</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Unscreened papers
                        <span class="badge badge-primary badge-pill">100</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Decided papers
                        <span class="badge badge-primary badge-pill">1900</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Further Check
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Full Text Review
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Included in MA
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Included Papers
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Included in SR
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        Included in MA
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                </div>

                <h5 class="mt-3">
                    <i class="far fa-file-alt"></i>
                    Excluded Papers
                </h5>
                <div class="list-group">
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        By RCT Classifier
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                    <button class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                        By Title / Abstract
                        <span class="badge badge-secondary badge-pill">14</span>
                    </button>
                </div>
            </div>
            <!-- / left pane -->

            <div style="width: calc(100% - 230px); margin-left: 10px;">

                <h5>
                    <i class="far fa-file-alt"></i>
                    Paper List
                </h5>

                <table id="tbjs_paperlist" class="display compact hover" style="width: 100%;">

                </table>
            </div>
            <!-- / right pane -->
        </div>
    </div>
</div>
<!-- /.timeline -->

</div>
</div>
</div>


{% endblock %}

{% block active_nav_link %}screener-overview{% endblock %}

{% block script %}
<script src="/static/lib/d3/d3.min.js"></script>
<link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.10.22/css/dataTables.bootstrap4.min.css">
<script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.10.22/js/jquery.dataTables.min.js"></script>
<script src="https://unpkg.com/dayjs@1.8.21/dayjs.min.js"></script>

<script>

var jarvis = {
    init: function () {
        tbjs_paperlist.load();
    },
};

var vw_screener = {

    api_url: {
        get_all_papers: '[[ url_for("screener.get_papers") ]]',
        get_papers_by_stage: '[[ url_for("screener.get_papers_by_stage") ]]',
        exclude_ta: '[[ url_for("screener.sspr_exclude_papers_ta") ]]',
        exclude_ft: '[[ url_for("screener.sspr_exclude_papers_ft") ]]',
        set_needchkft: '[[ url_for("screener.sspr_set_papers_needchkft") ]]',
        include_sr: '[[ url_for("screener.sspr_include_papers_sr") ]]',
        include_srma: '[[ url_for("screener.sspr_include_papers_srma") ]]',
    },

    get_papers: function(stage, callback) {
        var project_id = Cookies.get('project_id');
        var url = '';
        if (stage == 'all') {
            url = this.api_url.get_all_papers;
        } else {
            url = this.api_url.get_papers_by_stage;
        }

        $.post(
            url,
            {project_id: project_id, stage: stage},
            callback, 
            'json'
        )
    }
};

var tbjs_paperlist = {
    table_id: '#tbjs_paperlist',
    table: null,

    cfg: {
        number_of_rows: 25
    },

    columns: [
        {
            "title": '',
            "width": 25,
            "className": 'details-control dt-center',
            "orderable": false,
            "data": null,
            "defaultContent": '<i class="fa fa-plus"></i>'
        },
        { 
            title: 'Date', 
            width: 90,
            data: 'date_created_norm' 
        },
        { 
            title: 'Title', 
            data: 'title' 
        },
        {
            title: '',
            className: 'operate-control',
            width: 120,
            orderable: false,
            data: null,
            defaultContent: '<button class="btn btn-danger btn-sm">Exclude</button> ' + 
                '<button class="btn btn-primary btn-sm">Include</button> '
        }
    ],
    sample: [
        { pid: '123456', authors: 'B, X, C and E', date: '2020-10-01', title: 'A title here', journal: 'JAMA', abstract: 'This is the abstract content' },
        { pid: '123457', authors: 'A, B, U and E', date: '2020-10-01', title: 'A title here', journal: 'NEJM', abstract: 'This is the abstract content' },
        { pid: '123458', authors: 'D, B, N and E', date: '2020-10-01', title: 'A title here', journal: 'Lancet', abstract: 'This is the abstract content' }
    ],

    init: function() {

    },

    load: function() {
        vw_screener.get_papers('all', function(data) {
            tbjs_paperlist.update(data.papers);
        });
    },

    _create_columns: function(stage) {

    },

    _preprocessing: function(data) {
        for (var i = 0; i < data.length; i++) {
            var d = data[i];
            d['date_created_norm'] = dayjs(d.date_created).format('YYYY-MM-DD') + ' ' +
                '<span class="badge badge-pill badge-info"><i class="fa fa-bong"></i> RCT</span>';
        }

        this.data = data;
    },

    update: function(data) {
        this._preprocessing(data);
        
        if (this.table != null) {
            this.table = null;
        }

        // update the table
        this.table = $(this.table_id).DataTable({
            responsive: true,
            pageLength: this.cfg.number_of_rows,
            data: data,
            columns: this.columns,
            order: [
                [1, 'desc']
            ]
        });

        // update the open/close details event
        $(this.table_id + ' tbody').on('click', 'td.details-control', function() {
            var tr = $(this).closest('tr');
            var row = tbjs_paperlist.table.row( tr );
    
            if ( row.child.isShown() ) {
                // This row is already open - close it
                row.child.hide();
                tr.removeClass('shown');
                $(this).html('<i class="fa fa-plus"></i>')
            }
            else {
                // Open this row
                row.child( tbjs_paperlist._get_expand_html(row.data()) ).show();
                tr.addClass('shown');
                $(this).html('<i class="fa fa-minus"></i>')
            }
        });
    },

    _get_expand_html: function(d) {
        return '<table cellpadding="5" cellspacing="0" border="0" style="padding-left:50px;">'+
            '<tr>'+
                '<td>Actions:</td>'+
                '<td>'+
                '<button class="btn btn-danger btn-sm">Exclude</button> '+
                '<button class="btn btn-primary btn-sm">Proceed to Full Text</button> '+
                ' | ' +
                '<button class="btn btn-default btn-sm">Check Later</button>'+
                '</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Detail:</td>'+
                '<td>'+d.authors+'</td>'+
            '</tr>'+
            '<tr>'+
                '<td>Abstract:</td>'+
                '<td>'+d.abstract+'</td>'+
            '</tr>'+
        '</table>';
    }
};

$(document).ready(function () {
    jarvis.init();
})
</script>
{% endblock %}