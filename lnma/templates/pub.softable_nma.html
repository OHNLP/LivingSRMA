<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Summary of Findings: NMA</title>

<link rel="icon" href="/static/img/favicon.png" type="image/png">
<script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="/static/lib/jquery-ui/jquery-ui.min.css">
<link rel="stylesheet" href="/static/css/mybox-0.9.1.css">

<style>
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
a {
    color: #333333;
    text-decoration: none;
}
#wrapper {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
}
#start-screen {
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}

/* for this page */
#app {
    width: 100%;
    height: 100%;
}

/* for the simple oclist */

#vw_simple_oclist {
    width: 200px;
    min-width: 200px;
    padding: 0 5px;
    height: 100%;
}
.ae-item {
    display: flex;
    align-items: center;
    width: calc(100% - 10px);
    height: 50px;
    border: 1px solid #dddddd;
    margin: 0 0 10px;
    padding: 0 0 0 10px;
    cursor: pointer;
}
.ae-item:hover {
    background: whitesmoke;
    font-weight: bold;
}
.ae-item-selected {
    background: #c6c6c6;
    font-weight: bold;
}

/* for the NMA table */

#tb_sofnma {
    width: calc(100% - 200px);
}

/* for the SoF table */
.sof-table {
    width: 100%;
}
.sof-table th {
    text-align: center;
    background: whitesmoke;
    padding: 5px 0;
}
.sof-table td {
    text-align: center;
    line-height: 1.45em;
    padding: 3px 0;
    border-bottom: 1px solid #e6e6e6;
    border-right: 1px solid #e6e6e6;
    cursor: default;
}
.sof-table .col-ae-name {
    width: 150px;
    max-width: 180px;
}
.sof-table .col-treat {
    width: 100px;
    max-width: 150px;
}
.sof-table .col-comarator {
    background: #ffface;
}
.sof-table .col-ta-left {
    text-align: left !important;
    padding-left: 10px;
}
.sof-table .col-flipable {
    cursor: pointer;
}
.sof-table .col-flipable:hover {
    background: whitesmoke;
}
</style>
</head>
<body>
<div id="start-screen">
    <h1>
        <i class="fa fa-table"></i>
        Summary of Findings: Network Meta-Analysis
    </h1>
    <div id="ss-msg">Loading data and initializing ...</div>
</div>

<div id="wrapper">

<div id="app" class="d-flex fx-row">

<div id="vw_simple_oclist">
    <div class="box">
        <div class="box-header">
            <h4>
                <i class="fa fa-list"></i>
                Outcome List
            </h4>
            <div>
                <button>
                    <i class="fa fa-sync"></i>
                    Reset
                </button>
            </div>
        </div>
        <div class="box-body">
            <div class="ae-item"
                v-for="ae in aes">
                {{ ae.ae_name }}
            </div>
        </div>
    </div>
</div>

    <div id="tb_sofnma">
        <div class="box" style="height: 100%;">
            <div class="box-header">
                <h4>
                    <i class="fa fa-table"></i>
                </h4>
                <div class="d-flex fx-row">
                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Measure of effect: 
                        </div>
                        <div>
                            <select v-model='measure'>
                                <option value="OR">Odds Ratio (OR)</option>
                                <option value="RR">Risk Ratio (RR)</option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Display risks per: 
                        </div>
                        <div>
                            <select v-model="baseline">
                                <option value="100">100</option>
                                <option value="1000">1000</option>
                                <option value="10000">10,000</option>
                                <option value="100000">100,000</option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Comparator: 
                        </div>
                        <div>
                            <select v-model='comparator'>
                                <option v-for="treat in treat_list"
                                    v-bind:value="treat">
                                    {{ treat }}
                                </option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="box-body" style="height: 100%; overflow-y: auto;">

                <table class="sof-table">
                    <tr>
                        <th class="col-ae-name">Adverse Events</th>
                        <th class="col-treat col-comarator">{{ comparator }}</th>
                        <th class="col-treat" 
                            v-for="treat in treat_list" 
                            v-if="treat!=comparator">
                            {{ treat }}
                        </th>
                    </tr>
                    <tr v-for="ae in aes">
                        <td>{{ ae.ae_name }}</td>
                        <td class="col-comarator">
                            {{ get_ACR(ae.treats[comparator]).toFixed(0) }} per {{ baseline }} <br>
                            Rank {{ ae.treats[comparator].rank }}
                        </td>
                        <td v-for="treat in treat_list" 
                            v-if="treat!=comparator && ae.lgtable[measure]">
                            {{ show_sm(ae.lgtable[measure], comparator, treat) }}<br>
                            Rank {{ ae.treats[treat].rank }}
                        </td>
                    </tr>
                </table>

            </div>

        </div>
    </div>
</div>

</div>

<script src="/static/lib/jquery/jquery-3.4.1.min.js"></script>
<script src="/static/lib/jquery-ui/jquery-ui.min.js"></script>
<script src="/static/lib/vue.js/vue.min.js"></script>
<script src="/static/lib/alasql/alasql.min.js"></script>

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<script>

var vw_simple_oclist = {
    vpp_id: '#vw_simple_oclist',
    vpp: null,

    sample: {
        aes: {
            "fatality": {
                ae_cate: 'default',
                ae_name: 'Fatality',
                treat_list: ['Suni', 'Pazo', 'Ipin', 'ApiX'],
                treats: {
                    "Suni": { event: 110, total: 200, rank: 1},
                    "Ipin": { event: 111, total: 220, rank: 2},
                    "Pazo": { event: 112, total: 250, rank: 3},
                    "ApiX": { event: 113, total: 270, rank: 4}
                },
                // for each one, row is comparator, col is 
                lgtable: {
                    OR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    },
                    RR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    }
                }
            },
            "major-bleeding": {
                ae_cate: 'default',
                ae_name: 'Major bleeding',
                treat_list: ['Suni', 'Pazo', 'Ipin', 'ApiX'],
                treats: {
                    "Suni": { event: 10, total: 200, rank: 1},
                    "Ipin": { event: 11, total: 220, rank: 2},
                    "Pazo": { event: 12, total: 250, rank: 3},
                    "ApiX": { event: 13, total: 270, rank: 4}
                },
                // for each one, row is comparator, col is 
                lgtable: {
                    OR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    },
                    RR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    }
                }
            },
        }
    },

    init: function() {

        this.vpp = new Vue({
            el: this.vpp_id,
            data: this.sample,
            methods: {

            }
        });

    },


};


var tb_sofnma = {
    vpp: null,
    vpp_id: '#tb_sofnma',
    sample: {
        measure: 'OR',
        baseline: 1000,
        external_risk_calculated: 10,
        use_internal_baseline: true,
        comparator: 'Suni',
        treat_list: ['Suni', 'Pazo', 'Ipin', 'ApiX'],
        aes: {
            "fatality": {
                ae_cate: 'default',
                ae_name: 'Fatality',
                treat_list: ['Suni', 'Pazo', 'Ipin', 'ApiX'],
                treats: {
                    "Suni": { event: 110, total: 200, rank: 1},
                    "Ipin": { event: 111, total: 220, rank: 2},
                    "Pazo": { event: 112, total: 250, rank: 3},
                    "ApiX": { event: 113, total: 270, rank: 4}
                },
                // for each one, row is comparator, col is 
                lgtable: {
                    OR: {
                        Suni: {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        }
                    },
                    RR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        }
                    }
                }
            },
            "major-bleeding": {
                ae_cate: 'default',
                ae_name: 'Major bleeding',
                treat_list: ['Suni', 'Pazo', 'Ipin', 'ApiX'],
                treats: {
                    "Suni": { event: 10, total: 200, rank: 1},
                    "Ipin": { event: 11, total: 220, rank: 2},
                    "Pazo": { event: 12, total: 250, rank: 3},
                    "ApiX": { event: 13, total: 270, rank: 4}
                },
                // for each one, row is comparator, col is 
                lgtable: {
                    OR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    },
                    RR: {
                        "Suni": {
                            "Suni": {}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Pazo": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "Ipin": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {}, "ApiX": {sm: 1.1, lw: 0.4, up: 1.2}
                        },
                        "ApiX": {
                            "Suni": {sm: 1.1, lw: 0.4, up: 1.2}, "Pazo": {sm: 1.1, lw: 0.4, up: 1.2}, "Ipin": {sm: 1.1, lw: 0.4, up: 1.2}, "ApiX": {}
                        },
                    }
                }
            },
        }
    },

    init: function(data) {
        this.data = data;

        this.vpp = new Vue({
            el: this.vpp_id,
            data: this.sample,
            methods: {
                get_ACR: function(r) {
                    if (this.use_internal_baseline) {
                        return r.event / r.total * this.baseline;
                    } else {
                        return external_risk_calculated;
                    }
                },

                get_CIR: function(r, obj) {
                    // get the obj of this CIR
                    // obj could be
                    // sm, lower, upper
                    if (typeof(obj)=='undefined') {
                        obj = 'sm';
                    }

                    // calculate the CIR based on measure
                    if (this.measure == 'OR') {
                        var a = this.get_ACR(r) / this.baseline * r[obj];
                        var b = 1 - this.get_ACR(r) / this.baseline;
                        var c = a + b;
                        var d = a / c;
                        var e = d * this.baseline;
                        return e;
                    } else if (this.measure == 'RR') {
                        var a = this.get_ACR(r) * r[obj];
                        return a;
                    }
                },

                show_sm: function(tb, c, t) {
                    console.log(tb);
                    return tb[c][t].sm;
                },

                get_ARD: function(r, obj) {
                    // get the obj of this CIR
                    // obj could be
                    // sm, lower, upper
                    if (typeof(obj)=='undefined') {
                        obj = 'sm';
                    }
                    if (this.measure == 'OR') {
                        var a = (1 - r[obj]) * this.get_ACR(r) / this.baseline;
                        var b = 1 - this.get_ACR(r) / this.baseline;
                        var c = a + b;
                        var d = a / c;
                        var e = d * this.baseline;
                        return e;
                    } else if (this.measure == 'RR') {
                        var a = this.get_ACR(r) * (1 - r[obj]);
                        return a;
                    }
                },

                get_ARD_txt: function(r, obj) {
                    var ARD = this.get_ARD(r, obj);
                    var txt = ' less';
                    if (ARD < 0) {
                        txt = ' more';
                    }
                    return Math.abs(ARD).toFixed(0) + txt;
                },

                get_ARDp_txt: function(r, obj) {
                    var ARDp = 100 * this.get_ARD(r, obj) / this.baseline;
                    var txt = ' less';
                    if (ARDp < 0) {
                        txt = ' more';
                    }
                    return Math.abs(ARDp).toFixed(1) + '%' + txt;
                },

                get_grade_label: function(g) {
                    return jarvis.texts[g];
                },

                flip_cell: function(ae_grade, r, cell) {
                    // first, find this ae in rs
                    if (this.rs[ae_grade].hasOwnProperty(r.name)) {
                        // flip this cell!
                        this.rs[ae_grade][r.name].is_show[cell] = 
                            !this.rs[ae_grade][r.name].is_show[cell];
                    } else {
                        // how can it be ???
                    }
                    this.$forceUpdate();
                }
            },
        });
    },

    toggle_ae: function(ae_cate, ae_name, ae_grade) {
        // first, find this ae in rs
        if (this.vpp.rs[ae_grade].hasOwnProperty(ae_name)) {
            // if exists, remove
            delete this.vpp.rs[ae_grade][ae_name];
        } else {
            var ae = this.data.ae_rsts[ae_name][ae_grade];
            if (ae.stus.length == 0) {
                // this means no studies in this ae + grade 
                return;
            }
            var measure = this.vpp.measure;
        
            // build the r for display
            var r = {
                name: ae_name,
                sm: ae.result[measure].random.model.sm,
                lower: ae.result[measure].random.model.lower,
                upper: ae.result[measure].random.model.upper,
                Et: ae.Et,
                Nt: ae.Nt,
                Ec: ae.Ec,
                Nc: ae.Nc,
                n_stu: ae.stus.length,
                // for display setting
                is_show: {
                    // show sm / study info
                    sm: true,
                    // show ARD / ARD CI
                    ARD: true
                }
            }

            // add this to list
            this.vpp.rs[ae_grade][ae_name] = r;
        }

        // have to force update the view
        tb_sofpma.vpp.$forceUpdate();
    },

    clear: function() {

    },

    clear_all: function() {
        for (var key in tb_sofpma.vpp.rs) {
            if (tb_sofpma.vpp.rs.hasOwnProperty(key)) {
                tb_sofpma.vpp.rs[key] = {};
            }
        }
        tb_sofpma.vpp.$forceUpdate();
    }
};


var jarvis = {

    init: function() {
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // OK, 
        var prj = jarvis.getUrlParameter('prj');
        if (prj == null) {
            jarvis.ssmsg('Project information error.')
            return;
        }
        // ok, remove the 
        jarvis.ssmsg('Almost initialized.');
        setTimeout('jarvis.ssclose();', 400);

        vw_simple_oclist.init();
        tb_sofnma.init();

    },

    getUrlParameter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    toggle_ae: function(ae_cate, ae_name, ae_grade) {
        console.log('* toggle_ae ' + ae_cate + ', ' + ae_name + ', ' + ae_grade);
        tb_sofpma.toggle_ae(ae_cate, ae_name, ae_grade);
    },

    clear_all_ae: function() {
        tb_sofpma.clear_all();
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    }
};

$(document).ready(function() {
    jarvis.init();
})
</script>
</body>