<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
<meta http-equiv="Pragma" content="no-cache" />
<meta http-equiv="Expires" content="0" />

<title>Summary of Findings: PMA</title>

<link rel="icon" href="/static/img/favicon.png" type="image/png">
<!-- <script src="https://kit.fontawesome.com/cb45cc91b0.js" crossorigin="anonymous"></script> -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" integrity="sha512-iBBXm8fW90+nuLcSKlbmrPcLa0OT92xO1BIsZ+ywDWZCvqsWgccV3gFoRBv0z+8dLJgyAHIhR35VZc2oM/gI1w==" crossorigin="anonymous" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />



<style>
{% include 'css/box.css' %}
html, body {
    width: 100%;
    height: 100%;
    padding: 0;
    margin: 0;
    overflow: hidden;
}
body {
    font-size: 12px;
    font-family: Arial, Helvetica, sans-serif;
}
a {
    color: #333333;
    text-decoration: none;
}
#wrapper {
    display: flex;
    flex-direction: row;
    width: 100%;
    height: 100%;
}
#start-screen {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 9999;
    background: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
}
#ss-msg {
    width: 100%;
    padding: 10px 0;
    text-align: center;
}

/* for this page */
#app {
    width: 100%;
    height: 100%;
}

/* for the simple oclist */

#vw_simple_oclist {
    width: 200px;
    min-width: 200px;
    padding: 0 5px;
    height: 100%;
}
.oc-item {
    display: flex;
    align-items: center;
    width: calc(100% - 10px);
    height: 50px;
    border: 1px solid #dddddd;
    margin: 0 0 10px;
    padding: 0 0 0 10px;
    cursor: pointer;
}
.oc-item:hover {
    background: whitesmoke;
    font-weight: bold;
}
.oc-item-selected {
    background: #ececec;
    font-weight: bold;
}

/* for the table */
#tb_simple_sofpma {
    width: 100%;
    height: 100%;
}
#vw_oclist_plotpanel {
    height: 100%;
    overflow-y: auto;
}
.oc-name {
    width:     180px;
    min-width: 180px;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type {
    width: 30px;
    min-width: 30px;
    text-align: center;
    cursor: pointer;
    padding: 2px 0;
}
.oc-type:hover {
    background-color: #cccccc;
    font-weight: bold;
}
.oc-type-selected {
    background-color: #555555;
    color: #ffffff;
    font-weight: bold;
}
.oc-cate {
    flex-direction: column;
}
.oc-cate-info {
    width: 100%;
    border-bottom: 1px solid transparent;
}
.oc-cate-info:hover {
    border-bottom: 1px solid #555555;
}
.oc-cate-info .oc-name {
    font-weight: bold;
}
.oc-cate-info .oc-type {
    font-weight: bold;
}
.oc-items {
    width: 100%;
    padding-left: 20px;
}
.oc-items-hide {
    display: none;
}
.oc-item {
    border-left: 1px solid #aaaaaa;
}
.oc-item-info {
    width: calc(100% - 20px);
    border-bottom: 1px solid transparent;
}
.oc-item-info:hover {
    background-color: #efefef;
    border-bottom: 1px solid #cccccc;
}
.oc-item-info .oc-name {
    width:       150px;
    min-width:   150px;
    padding-left: 10px;
}
.oc-plot-img {
    width: 100%;
}
.oc-plot-tab {
    padding: 4px 15px;
    border: 0;
    color: #999999;
    border-bottom: 1px solid #999999;
    cursor: pointer;
}
.oc-plot-tab:hover {
    color: #555555;
    border-bottom: 1px solid #555555;
}
.oc-plot-tab-selected {
    color: #000000;
    font-weight: bold;
    border-bottom: 1px solid #000000;
}
.oc-plot-tab-page {
    display: none;
}
.oc-plot-tab-page-selected {
    display: block;
}

/* for the SoF table */
.sof-table {
    width: 100%;
}
.sof-table th {
    text-align: center;
    background: whitesmoke;
    padding: 5px 0;
}
.sof-table td {
    text-align: center;
    line-height: 1.45em;
    padding: 3px 0;
    border-bottom: 1px solid #e6e6e6;
    border-right: 1px solid #e6e6e6;
    cursor: default;
}
.sof-table .col-oc-name {
    width: 150px;
    max-width: 200px;
    cursor: pointer;
}
.sof-table .col-oc-name:hover {
    background: whitesmoke;
}
.sof-table .col-ta-left {
    text-align: left !important;
    padding-left: 10px;
}
.sof-table .col-flipable {
    cursor: pointer;
}
.sof-table .col-flipable:hover {
    background: whitesmoke;
}
.cie-table th {
    text-align: left;
    padding: 3px 5px;
}
.cell-treat {
    background: white;
    cursor: pointer;
}
.cell-treat:hover {
    background: #efefef;
}
.cie-bene-4 { background: rgb(55, 86, 35); color: white; }
.cie-bene-3 { background: rgb(169, 208, 142); color: black; }
.cie-bene-2 { background: rgb(226, 239, 218); color: black; }
.cie-bene-1 { background: rgb(255, 242, 204); color: black; }
.cie-harm-4 { background: rgb(150, 0, 0); color: white; }
.cie-harm-3 { background: rgb(255, 103, 91); color: black; }
.cie-harm-2 { background: rgb(255, 199, 193); color: black; }
.cie-harm-1 { background: rgb(255, 242, 204); color: black; }
.cie-nner-4 { background: rgb(66, 66, 66); color: rgb(255, 255, 255); }
.cie-nner-3 { background: rgb(128, 128, 128); color: rgb(255, 255, 255); }
.cie-nner-2 { background: rgb(191, 191, 191); color: black; }
.cie-nner-1 { background: rgb(255, 242, 204); color: black; }

.legend-table td { padding: 5px 10px; font-size: 14px; }

.dlg-sm h4 { margin: 5px 0; }
.dlg-sm p { margin: 0; }
.dlg-sm hr { border: 0; border-bottom: 1px solid #ececec; }
</style>
</head>
<body>
<div id="start-screen">
    <h1>
        <i class="fa fa-table"></i>
        Summary of Findings: Pairwise Meta-Analysis
    </h1>
    <div id="ss-msg">Loading data and initializing ...</div>
</div>

<div id="wrapper">

<div id="color_guide" style="display: none;" title="Color guide">
{% include 'pub/pub._table_color_guide_v2.html' %}
</div>
<!-- /div#legend -->

<div id="app" class="d-flex fx-row">

    <!-- {% include 'pub/pub._vw_simple_oclist_v2.html' %} -->

    <div id="tb_simple_sofpma">
        <div class="box" style="width: 100%; height: 100%;">
            <div class="box-header">
                <h4>
                    <i class="fa fa-table"></i>
                </h4>
                <div class="d-flex fx-row">
                    <!-- <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Measure of effect: 
                        </div>
                        <div>
                            <select v-model='measure'>
                                <option v-for="m in measure_list"
                                    v-bind:value="m.abbr">
                                    {{ m.name }}
                                </option>
                            </select>
                        </div>
                    </div> -->

                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Display risks per: 
                        </div>
                        <div>
                            <select v-model="baseline">
                                <option value="100">100</option>
                                <option value="1000">1000</option>
                                <option value="10000">10,000</option>
                                <option value="100000">100,000</option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div>
                            <i class="fa fa-cog"></i>
                            Show survival data: 
                        </div>
                        <div>
                            <select v-model="show_survival">
                                <option value="yes">Yes</option>
                                <option value="no">No</option>
                            </select>
                        </div>
                    </div>

                    <div class="box-menu-group d-flex fx-row">
                        <div class="box-menu-link" onclick="jarvis.show_color_guide();">
                            <i class="fa fa-paint-brush"></i>
                            Color guide
                        </div>
                    </div>

                </div>
            </div>

            <div class="box-body" style="height: 100%; overflow-y: auto;">

                <table class="sof-table">
                    <tr>
                        <th class="col-oc-name" rowspan="2">Outcome</th>
                        <th rowspan="2">Relative</th>
                        <th colspan="6" v-if="show_survival=='yes'">Absolute</th>
                        <th colspan="3" v-else>Absolute</th>
                        <th rowspan="2">Certainty in <br>Evidence</th>
                        <th rowspan="2">Importance</th>
                    </tr>
                    <tr>
                        <th>Intervention</th>
                        <th>Control</th>
                        <th>Risk Difference</th>
                        <th v-if="show_survival=='yes'">Survival in Intervention</th>
                        <th v-if="show_survival=='yes'">Survival in Control</th>
                        <th v-if="show_survival=='yes'">Survival Difference</th>
                    </tr>

                    <tr v-for="r, oc_name in rs">
                        <td class="col-oc-name"
                            v-on:click="show_ctrl_options(r.oc_name)">
                            {{ r.oc_fullname }}
                        </td>

                        <td v-if="r.is_show['sm']" class="col-flipable"
                            v-on:click="flip_cell(r, 'sm')">
                            {{ get_a_measure(r) }} {{ _round2(r.oc.result[get_a_measure(r)].random.model.sm) }}<br>
                            ({{ _round2(r.oc.result[get_a_measure(r)].random.model.lower) }} to 
                            {{ _round2(r.oc.result[get_a_measure(r)].random.model.upper) }})
                        </td>
                        <td v-else class="col-ta-left col-flipable"
                            v-on:click="flip_cell(r, 'sm')">
                            <b>{{ r.n_stu }}</b> Studies<br>
                            Events: <b>{{ r.Et }}</b><br>
                            Participants: <b>{{ r.Nt }}</b>
                        </td>

                        <td v-if="r.is_show['CIR']" class="col-flipable"
                            v-on:click="flip_cell(r, 'CIR')">
                            {{ Math.round(get_CIR(r) * baseline) }} per {{ baseline }}
                        </td>
                        <td v-else class="col-flipable"
                            v-on:click="flip_cell(r, 'CIR')">
                            {{ Math.round(get_CIR(r) * baseline) }} per {{ baseline }}<br>
                            CI: {{ Math.round(get_CIR(r, 'lower') * baseline) }} to 
                                {{ Math.round(get_CIR(r, 'upper') * baseline) }}
                        </td>
                        <td>
                            {{ Math.round(get_ACR(r) * baseline) }} per {{ baseline }}
                        </td>
                        <td v-if="r.is_show['ARD']" class="col-flipable"
                            v-on:click="flip_cell(r, 'ARD')">
                            {{ get_ARD_txt(r) }} per {{ baseline }}
                        </td>
                        <td v-else class="col-flipable"
                            v-on:click="flip_cell(r, 'ARD')">
                            {{ get_ARD_txt(r) }} per {{ baseline }}<br>
                            CI: {{ get_ARD_txt(r, 'lower') }} to 
                                {{ get_ARD_txt(r, 'upper') }}<br>
                            RD(%): {{ get_ARDp_txt(r) }}<br>
                            CI: {{ get_ARDp_txt(r, 'lower')}} to {{ get_ARDp_txt(r, 'upper')}}
                        </td>

                        <td v-if="show_survival=='yes'">
                            {{ get_SRVI_txt(r, 'sm') }}
                        </td>

                        <td v-if="show_survival=='yes'">
                            {{ get_SRVC_txt(r) }}
                        </td>

                        <td v-if="show_survival=='yes'">
                            {{ get_SRVD_txt(r, 'sm') }}
                        </td>

                        <td v-bind:class="get_cieclr_v2(r.oc.param.which_is_better, r.oc.result[get_a_measure(r)].random.model, r.oc.cie)"
                            v-on:click="show_cie_detail(r.oc_name)">
                            {{ txt('CIE_TOT_' + r.oc.cie) }}
                        </td>
                        <td>
                            {{ r.oc.importance }}
                        </td>
                    </tr>
                </table>

                

            </div>
        </div>


        <div id="tb_simple_sofpma_cie_detail" class="box"
            v-bind:title="'Certainty in Evidence'">
            <div class="box-header">
                <h4>
                    Certainty in Evidence: 
                    <b class="txt-lg"
                        style="padding: 3px 5px"
                        v-bind:class="get_cieclr(oc_dict[detail.cie.oc_name].result[get_a_measure(rs[detail.cie.oc_name])].random.model.sm, oc_dict[detail.cie.oc_name].cie)">
                        {{ txt('CIE_TOT_' + oc_dict[detail.cie.oc_name].cie) }}
                    </b>
                </h4>
            </div>
            <div class="box-bod">
                <table class="cie-table">
                    <tr>
                        <th>Risk of bias</th>
                        <td>{{ txt('CIE_VAL_' + oc_dict[detail.cie.oc_name].cie_rob) }}</td>
                    </tr>
                    <tr>
                        <th>Inconsistency</th>
                        <td>{{ txt('CIE_VAL_' + oc_dict[detail.cie.oc_name].cie_inc) }}</td>
                    </tr>
                    <tr>
                        <th>Indirectness</th>
                        <td>{{ txt('CIE_VAL_' + oc_dict[detail.cie.oc_name].cie_ind) }}</td>
                    </tr>
                    <tr>
                        <th>Imprecision</th>
                        <td>{{ txt('CIE_VAL_' + oc_dict[detail.cie.oc_name].cie_imp) }}</td>
                    </tr>
                    <tr>
                        <th>Publication bias</th>
                        <td>{{ txt('PUB_BIA_' + oc_dict[detail.cie.oc_name].pub_bia) }}</td>
                    </tr>
                </table>
            </div>
        </div>

        <div id="tb_simple_sofpma_ctrl_select" class="box dlg-sm" title="Assumed Baseline Risk">
            <div class="box-body">
                <h4>Assumed Baseline Risk for {{ set_ctrl_oc_name }}</h4>
                <p>
                    <input type="radio" name="ipt_which_ctrl" value="external" 
                    v-model="rs[set_ctrl_oc_name].which_ACR.use_which_val"> 
                    User provided
                    <input type="text"
                        v-bind:disabled="rs[set_ctrl_oc_name].which_ACR.use_which_val == 'internal'"
                        v-model="rs[set_ctrl_oc_name].which_ACR.external_val">
                </p>
                <hr>
                <div v-if="rs[set_ctrl_oc_name].oc.has_internal_val">
                    <p>
                        <input type="radio" name="ipt_which_ctrl" value="internal"
                            v-model="rs[set_ctrl_oc_name].which_ACR.use_which_val">
                        Pre-specified
                    </p>
                    <!-- <p>&nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="ipt_ctrl"> Mean
                       &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="ipt_ctrl"> High risk
                       &nbsp;&nbsp;&nbsp;&nbsp;<input type="radio" name="ipt_ctrl"> Low risk</p> -->
                    <p></p>
                </div>
                <div v-else>
                    Internal data not available.
                </div>
            </div>
        </div>
    </div>
    
</div>

</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.6.10/vue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/alasql/0.5.5/alasql.min.js"></script>

<script>
var isIE = /*@cc_on!@*/false || !!document.documentMode;
if (isIE) {
    document.getElementById('ss-msg').innerHTML = 'The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.';
}
</script>

<script>

{% include 'js/vw_simple_oclist_v2.js' %}
{% include 'js/tb_simple_sofpma_v2.js' %}


var jarvis = {
    txt: {
        'OR': 'Odds Ratio (OR)',
        'RR': 'Risk Ratio (RR)',
        'HR': 'Hazard Ratio (HR)',
        'CIE_TOT_4': 'High',
        'CIE_TOT_3': 'Moderate',
        'CIE_TOT_2': 'Low',
        'CIE_TOT_1': 'Very Low',
        'CIE_VAL_4': 'Very serious',
        'CIE_VAL_3': 'Very serious',
        'CIE_VAL_2': 'Serious',
        'CIE_VAL_1': 'No serious',
        'PUB_BIA_2': 'Strongly suspected',
        'PUB_BIA_1': 'Undetected',
        'PUB_BIA_0': 'Not applicable'
    },

    // for the PMA table
    default_measure: '',
    measure_list: [],

    measure_dict: {
        OR: { abbr: 'OR', name: 'Odds Ratio (OR)' },
        RR: { abbr: 'RR', name: 'Risk Ratio (RR)' },
        HR: { abbr: 'HR', name: 'Hazard Ratio (HR)' },
    },

    init: function() {
        var isIE = /*@cc_on!@*/false || !!document.documentMode;

        console.log('* User is using IE:', isIE);
        if (isIE) {
            jarvis.ssmsg('The functions used in this website require advanced web technologies, which are <b>NOT</b> supported by Internet Explorer<br>Try using Google Chrome, Apple Safari, Mozilla Firefox or other modern browsers.')
            return;
        }

        // OK, get the project name
        var prj = jarvis.get_url_paramter('prj');
        if (prj == null) {
            jarvis.ssmsg('Project information error.')
            return;
        }

        // set the measures
        // the msrs should be a comma seperated string:
        // e.g., OR,RR
        // HR,OR
        var msrs = jarvis.get_url_paramter('msrs');
        if (msrs == null || msrs == '') {
            msrs = 'OR,RR';
        }
        msrs = msrs.split(',')
        this.default_measure = msrs[0];
        this.measure_list = msrs.map(function(v) {
            return jarvis.measure_dict[v];
        });
        
        // set the measures in SoF PMA
        tb_simple_sofpma.default_measure = this.default_measure;
        tb_simple_sofpma.measure_list = this.measure_list;

        $.get(
            '/pub/graphdata/'+prj+'/SOFTABLE_PMA.json',
            {v: 2, ver: Math.random()},
            function(data) {
                vw_simple_oclist.init(data);
                tb_simple_sofpma.init(data);

                // show the first one
                // vw_simple_oclist.toggle_oc(data.oc_list[0].oc_names[0]);

                // ok, remove the 
                jarvis.ssmsg('Almost initialized.');
                setTimeout('jarvis.ssclose();', 400);
            }, 'json'
        );

        
    },

    get_url_paramter: function(name) {
        name = name.replace(/[\[]/, '\\[').replace(/[\]]/, '\\]');
        var regex = new RegExp('[\\?&]' + name + '=([^&#]*)');
        var results = regex.exec(location.search);
        return results === null ? '' : decodeURIComponent(results[1].replace(/\+/g, ' '));
    },

    toggle_oc: function(oc_name) {
        console.log('* toggle_oc '+ oc_name);
        tb_simple_sofpma.toggle_oc(oc_name);
    },

    clear_all_oc: function() {
        tb_simple_sofpma.clear_all_oc();
    },

    ssmsg: function(msg) {
        $('#ss-msg').html(msg);
    },

    ssclose: function() {
        $('#start-screen').hide();
    },

    show_color_guide: function() {
        $('#color_guide').dialog({
            width: 680
        });
    }
};

$(document).ready(function() {
    jarvis.init();
})
</script>
</body>